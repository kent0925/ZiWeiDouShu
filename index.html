<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç´«å¾®æ–—æ•¸ â”€ å‘½ç†æ’ç›¤</title>
    <meta name="description" content="ç´«å¾®æ–—æ•¸ç·šä¸Šæ’ç›¤ï¼Œè¼¸å…¥å‡ºç”Ÿè³‡æ–™å³å¯ç²å¾—å®Œæ•´å‘½ç›¤åˆ†æèˆ‡å£èªåŒ–è§£èªªã€‚">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iztro/dist/iztro.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* æ±æ–¹æ°´å¢¨é…è‰² */
            --bg-paper: #faf8f3;
            --bg-card: #ffffff;
            --bg-card-alt: #f5f0e8;
            --ink: #292524;
            --ink-light: #44403c;
            --ink-muted: #78716c;
            --ink-faint: #a8a29e;
            --accent: #8b2500;
            --accent-light: #b33a1a;
            --accent-muted: rgba(139, 37, 0, 0.08);
            --border: #e7e0d5;
            --border-light: #ede8df;
            --gold: #8b6914;
            --gold-soft: #a67c1a;
            --radius: 8px;
            --radius-lg: 12px;
            --font-serif: 'Noto Serif TC', 'å®‹é«”', 'SimSun', serif;
            --font-sans: 'Noto Sans TC', sans-serif;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.1);
            /* Legacy aliases for JS inline styles */
            --text-primary: #292524;
            --text-secondary: #78716c;
        }

        html {
            font-size: 15px;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-paper);
            color: var(--ink);
            min-height: 100dvh;
            overflow-x: hidden;
            position: relative;
        }

        /* ç´™å¼µç´‹ç†èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                repeating-linear-gradient(0deg, transparent, transparent 28px, rgba(0, 0, 0, 0.015) 28px, rgba(0, 0, 0, 0.015) 29px);
            z-index: 0;
            pointer-events: none;
        }

        #star-canvas {
            display: none;
        }

        .app-container {
            position: relative;
            z-index: 1;
            max-width: 640px;
            margin: 0 auto;
            padding: 20px 16px;
            min-height: 100dvh;
        }

        /* å¡ç‰‡ â€” ä¹¾æ·¨çš„ç´™å¼µè³ªæ„Ÿ */
        .glass {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .glass-strong {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        /* Loading å‹•ç•« */
        #loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: var(--bg-paper);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s ease;
        }

        .taiji {
            width: 64px;
            height: 64px;
            animation: spin 4s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        .animate-fade {
            animation: fadeIn 0.4s ease both;
        }

        /* æŒ‰éˆ• */
        .btn-primary {
            background: var(--ink);
            color: var(--bg-paper);
            border: none;
            padding: 14px 24px;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: transform 0.15s, opacity 0.2s;
            font-family: var(--font-sans);
        }

        .btn-primary:hover {
            opacity: 0.85;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            color: var(--ink);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-sans);
        }

        .btn-secondary:hover {
            background: var(--bg-card-alt);
        }

        .btn-gold {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 14px 24px;
            border-radius: var(--radius);
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: transform 0.15s, opacity 0.2s;
            font-family: var(--font-sans);
        }

        .btn-gold:hover {
            opacity: 0.9;
        }

        .btn-gold:active {
            transform: scale(0.98);
        }

        /* è¡¨å–® */
        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 0.82rem;
            color: var(--ink-muted);
            margin-bottom: 6px;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px 14px;
            border-radius: var(--radius);
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--ink);
            font-size: 1rem;
            font-family: var(--font-sans);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus,
        .form-select:focus {
            border-color: var(--ink-muted);
            box-shadow: 0 0 0 3px rgba(41, 37, 36, 0.06);
        }

        .form-select option {
            background: var(--bg-card);
            color: var(--ink);
        }

        /* åˆ‡æ›é–‹é—œ */
        .toggle-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--ink);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        }

        .toggle-switch.active::after {
            transform: translateX(22px);
        }

        /* é é¢è¦–åœ– */
        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.4s ease both;
        }

        /* Header */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        .app-header h1 {
            font-family: var(--font-serif);
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--ink);
            letter-spacing: 0.08em;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--border);
            object-fit: cover;
        }

        /* é¦–é å¡ç‰‡ */
        .home-card {
            padding: 20px 24px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            margin-bottom: 12px;
        }

        .home-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .home-card .card-icon {
            font-size: 1.6rem;
            margin-bottom: 8px;
        }

        .home-card h3 {
            font-family: var(--font-serif);
            font-size: 1.05rem;
            margin-bottom: 6px;
            color: var(--ink);
            font-weight: 700;
        }

        .home-card p {
            font-size: 0.82rem;
            color: var(--ink-muted);
            line-height: 1.6;
        }

        /* å‘½ç›¤ç¶²æ ¼ */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            margin: 16px 0;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--border);
        }

        .palace-cell {
            background: var(--bg-card);
            padding: 6px 4px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            font-size: 0.65rem;
            position: relative;
            transition: background 0.2s;
            cursor: pointer;
        }

        .palace-cell:hover {
            background: var(--bg-card-alt);
        }

        .palace-cell.highlight {
            background: var(--accent-muted);
        }

        .palace-name {
            text-align: center;
            font-weight: 700;
            font-size: 0.72rem;
            color: var(--accent);
            margin-bottom: 3px;
            font-family: var(--font-serif);
        }

        .palace-stem {
            text-align: center;
            font-size: 0.6rem;
            color: var(--ink-faint);
            margin-bottom: 2px;
        }

        .star-list {
            flex: 1;
        }

        .star-item {
            display: flex;
            align-items: center;
            gap: 2px;
            line-height: 1.4;
        }

        .star-name {
            color: var(--ink-light);
            font-size: 0.62rem;
        }

        .star-name.major {
            color: var(--accent);
            font-weight: 700;
            font-size: 0.68rem;
        }

        .star-name.minor {
            color: var(--ink-muted);
        }

        .star-bright {
            font-size: 0.5rem;
            color: var(--ink-faint);
        }

        .star-hua {
            font-size: 0.55rem;
            font-weight: 700;
            padding: 0 2px;
            border-radius: 2px;
        }

        .hua-lu {
            color: #2e7d32;
        }

        .hua-quan {
            color: #b71c1c;
        }

        .hua-ke {
            color: #1565c0;
        }

        .hua-ji {
            color: #c62828;
            background: rgba(198, 40, 40, 0.08);
        }

        /* å‘½ç›¤æ‘˜è¦ */
        .chart-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 16px 0;
        }

        .summary-item {
            text-align: center;
            padding: 14px 8px;
            background: var(--bg-card-alt);
            border-radius: var(--radius);
        }

        .summary-item .label {
            font-size: 0.75rem;
            color: var(--ink-muted);
            margin-bottom: 4px;
        }

        .summary-item .value {
            font-family: var(--font-serif);
            font-size: 1rem;
            font-weight: 700;
            color: var(--ink);
        }

        /* è§£èªªå€ */
        .explain-section {
            margin: 16px 0;
        }

        .explain-card {
            padding: 20px;
            margin-bottom: 12px;
        }

        .explain-card h4 {
            font-family: var(--font-serif);
            font-size: 0.95rem;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        .explain-card p {
            font-size: 0.85rem;
            line-height: 1.85;
            color: var(--ink-light);
        }

        .explain-card p strong {
            color: var(--ink);
        }

        /* é€²éšåŠŸèƒ½é¸æ“‡ */
        .feature-tabs {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding-bottom: 8px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .feature-tabs::-webkit-scrollbar {
            display: none;
        }

        .feature-tab {
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 0.8rem;
            white-space: nowrap;
            cursor: pointer;
            font-weight: 600;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--ink-muted);
            transition: all 0.2s;
        }

        .feature-tab.active {
            background: var(--ink);
            border-color: var(--ink);
            color: var(--bg-paper);
        }

        /* æ­·å²ç´€éŒ„ */
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border-light);
        }

        .history-item:hover {
            background: var(--bg-card-alt);
        }

        .history-meta {
            flex: 1;
        }

        .history-meta .name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
            color: var(--ink);
        }

        .history-meta .date {
            font-size: 0.75rem;
            color: var(--ink-muted);
        }

        .history-delete {
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
        }

        /* Toast */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-60px);
            background: var(--ink);
            color: var(--bg-paper);
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 10000;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s;
            opacity: 0;
            pointer-events: none;
        }

        #toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* é‹é™å€åŸŸ */
        .fortune-period {
            padding: 16px 20px;
            margin-bottom: 10px;
        }

        .fortune-period .period-title {
            font-family: var(--font-serif);
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 6px;
        }

        .fortune-period .period-detail {
            font-size: 0.82rem;
            color: var(--ink-light);
            line-height: 1.7;
        }

        /* å®®ä½è©³æƒ… Modal */
        #palace-modal {
            position: fixed;
            inset: 0;
            z-index: 500;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        #palace-modal.show {
            display: flex;
        }

        .palace-modal-content {
            background: var(--bg-paper);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            width: 100%;
            max-width: 640px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px 20px;
            animation: slideUp 0.3s ease;
            border-top: 1px solid var(--border);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 380px) {
            .palace-cell {
                min-height: 68px;
                padding: 4px 2px;
            }

            .star-name {
                font-size: 0.58rem;
            }

            .palace-name {
                font-size: 0.65rem;
            }
        }

        @media (min-width: 641px) {
            .app-container {
                padding: 24px 32px;
            }
        }

        /* éš±è— class */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <canvas id="star-canvas"></canvas>
    <div id="toast"></div>

    <!-- Loading -->
    <div id="loading-overlay">
        <svg class="taiji" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="48" fill="none" stroke="#e7e0d5" stroke-width="2" />
            <path d="M50 2 A48 48 0 0 1 50 98 A24 24 0 0 0 50 50 A24 24 0 0 1 50 2" fill="#292524" />
            <path d="M50 98 A48 48 0 0 1 50 2 A24 24 0 0 0 50 50 A24 24 0 0 1 50 98" fill="#a8a29e" />
            <circle cx="50" cy="26" r="5" fill="#a8a29e" />
            <circle cx="50" cy="74" r="5" fill="#292524" />
        </svg>
        <p
            style="margin-top:20px;color:var(--ink);font-family:var(--font-serif);font-size:1.1rem;font-weight:700;animation:pulse 1.5s infinite">
            ç´«å¾®æ–—æ•¸</p>
        <p style="margin-top:6px;color:var(--ink-muted);font-size:0.8rem">è¼‰å…¥ä¸­...</p>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div style="display:flex;align-items:center;gap:10px">
                <button id="btn-back" class="hidden" onclick="goBack()"
                    style="background:none;border:none;color:var(--text-primary);cursor:pointer;padding:4px">
                    <i data-lucide="arrow-left" style="width:22px;height:22px"></i>
                </button>
                <h1 id="header-title">ç´«å¾®æ–—æ•¸</h1>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
                <span id="user-name-display" style="font-size:0.8rem;color:var(--text-secondary)"></span>
                <img id="user-avatar" class="user-avatar hidden" src="" alt="é ­åƒ">
            </div>
        </header>

        <!-- ========== é¦–é  ========== -->
        <div id="view-home" class="view active">
            <div style="text-align:center;padding:20px 0 30px">
                <p
                    style="font-family:var(--font-serif);font-size:1.6rem;font-weight:900;color:var(--ink);letter-spacing:0.1em">
                    è§€æ˜Ÿå•å‘½</p>
                <p style="font-size:0.82rem;color:var(--ink-muted);margin-top:6px">æ¢ç´¢ä½ çš„ç´«å¾®å‘½ç›¤ï¼Œäº†è§£å‘½é‹çš„å¯†ç¢¼</p>
            </div>

            <div class="glass home-card" onclick="showView('view-form')">
                <div class="card-icon">ğŸ”®</div>
                <h3>é–‹å§‹æ’ç›¤</h3>
                <p>è¼¸å…¥å‡ºç”Ÿå¹´æœˆæ—¥èˆ‡æ™‚è¾°ï¼Œç«‹å³ç”¢ç”Ÿå°ˆå±¬ç´«å¾®å‘½ç›¤ï¼ŒåŒ…å«åäºŒå®®ä½ã€ä¸»å‰¯æ˜Ÿæ›œèˆ‡å››åŒ–åˆ†æ</p>
            </div>

            <div class="glass home-card" onclick="showView('view-history')">
                <div class="card-icon">ğŸ“œ</div>
                <h3>æ­·å²ç´€éŒ„</h3>
                <p>æŸ¥çœ‹éå»æ’éçš„å‘½ç›¤ç´€éŒ„ï¼Œéš¨æ™‚å›é¡§åˆ†æ</p>
            </div>

            <div class="glass home-card" onclick="showView('view-about')">
                <div class="card-icon">ğŸ“–</div>
                <h3>é—œæ–¼ç´«å¾®æ–—æ•¸</h3>
                <p>äº†è§£ä»€éº¼æ˜¯ç´«å¾®æ–—æ•¸ã€åäºŒå®®ä½ä»£è¡¨ä»€éº¼ã€å››åŒ–æ€éº¼çœ‹</p>
            </div>
        </div>

        <!-- ========== æ’ç›¤è¡¨å–® ========== -->
        <div id="view-form" class="view">
            <div class="glass" style="padding:24px">
                <h2
                    style="font-family:var(--font-serif);font-size:1.15rem;color:var(--ink);margin-bottom:18px;display:flex;align-items:center;gap:8px;letter-spacing:0.05em">
                    <i data-lucide="sparkles" style="width:20px;height:20px"></i> è¼¸å…¥å‡ºç”Ÿè³‡æ–™
                </h2>

                <div class="form-group">
                    <label class="form-label">æ—¥æ›†é¡å‹</label>
                    <div class="toggle-row">
                        <span style="font-size:0.9rem" id="cal-label">â˜€ï¸ åœ‹æ›†ï¼ˆé™½æ›†ï¼‰</span>
                        <div class="toggle-switch" id="cal-toggle" onclick="toggleCalendar()"></div>
                        <span style="font-size:0.85rem;color:var(--text-secondary)" id="cal-hint">é»æ“Šåˆ‡æ›è¾²æ›†</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="birth-date">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="date" id="birth-date" class="form-input" value="1990-01-01">
                </div>

                <div class="form-group" id="leap-group" style="display:none">
                    <label class="form-label">
                        <input type="checkbox" id="is-leap-month" style="margin-right:6px"> æ˜¯é–æœˆ
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label" for="birth-hour">å‡ºç”Ÿæ™‚è¾°</label>
                    <select id="birth-hour" class="form-select">
                        <option value="0">æ—©å­æ™‚ï¼ˆ00:00~01:00ï¼‰</option>
                        <option value="1">ä¸‘æ™‚ï¼ˆ01:00~03:00ï¼‰</option>
                        <option value="2">å¯…æ™‚ï¼ˆ03:00~05:00ï¼‰</option>
                        <option value="3">å¯æ™‚ï¼ˆ05:00~07:00ï¼‰</option>
                        <option value="4">è¾°æ™‚ï¼ˆ07:00~09:00ï¼‰</option>
                        <option value="5">å·³æ™‚ï¼ˆ09:00~11:00ï¼‰</option>
                        <option value="6">åˆæ™‚ï¼ˆ11:00~13:00ï¼‰</option>
                        <option value="7">æœªæ™‚ï¼ˆ13:00~15:00ï¼‰</option>
                        <option value="8">ç”³æ™‚ï¼ˆ15:00~17:00ï¼‰</option>
                        <option value="9">é…‰æ™‚ï¼ˆ17:00~19:00ï¼‰</option>
                        <option value="10">æˆŒæ™‚ï¼ˆ19:00~21:00ï¼‰</option>
                        <option value="11">äº¥æ™‚ï¼ˆ21:00~23:00ï¼‰</option>
                        <option value="12">æ™šå­æ™‚ï¼ˆ23:00~00:00ï¼‰</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="birth-gender">æ€§åˆ¥</label>
                    <select id="birth-gender" class="form-select">
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                    </select>
                </div>

                <div class="form-group"
                    style="margin-top:16px;background:rgba(0,0,0,0.02);padding:12px;border-radius:8px;border:1px solid rgba(0,0,0,0.05)">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <label for="birth-lotitude-select" style="margin:0;font-weight:700;color:var(--ink)">å‡ºç”Ÿåœ°é»
                            (æ ¡æ­£çœŸå¤ªé™½æ™‚)</label>
                        <div class="toggle-switch active" onclick="toggleTST()">
                            <div class="toggle-knob active" id="tst-toggle"></div>
                        </div>
                    </div>
                    <div style="font-size:0.8rem;color:var(--ink-muted);margin-bottom:8px" id="tst-label">âœ… å•Ÿç”¨çœŸå¤ªé™½æ™‚æ ¡æ­£
                    </div>

                    <select id="birth-lotitude-select" class="form-select" onchange="checkCustomLocation()">
                        <option value="121.56">å°åŒ—å¸‚ (121.56Â°E)</option>
                        <option value="121.74">åŸºéš†å¸‚ (121.74Â°E)</option>
                        <option value="121.47">æ–°åŒ—å¸‚ (121.47Â°E)</option>
                        <option value="121.30">æ¡ƒåœ’å¸‚ (121.30Â°E)</option>
                        <option value="120.96">æ–°ç«¹å¸‚/ç¸£ (120.96Â°E)</option>
                        <option value="120.82">è‹—æ —ç¸£ (120.82Â°E)</option>
                        <option value="120.67">å°ä¸­å¸‚ (120.67Â°E)</option>
                        <option value="120.54">å½°åŒ–ç¸£ (120.54Â°E)</option>
                        <option value="120.68">å—æŠ•ç¸£ (120.68Â°E)</option>
                        <option value="120.53">é›²æ—ç¸£ (120.53Â°E)</option>
                        <option value="120.45">å˜‰ç¾©å¸‚/ç¸£ (120.45Â°E)</option>
                        <option value="120.20">å°å—å¸‚ (120.20Â°E)</option>
                        <option value="120.30">é«˜é›„å¸‚ (120.30Â°E)</option>
                        <option value="120.48">å±æ±ç¸£ (120.48Â°E)</option>
                        <option value="121.77">å®œè˜­ç¸£ (121.77Â°E)</option>
                        <option value="121.60">èŠ±è“®ç¸£ (121.60Â°E)</option>
                        <option value="121.14">å°æ±ç¸£ (121.14Â°E)</option>
                        <option value="119.56">æ¾æ¹–ç¸£ (119.56Â°E)</option>
                        <option value="118.32">é‡‘é–€ç¸£ (118.32Â°E)</option>
                        <option value="119.94">é€£æ±Ÿç¸£ (119.94Â°E)</option>
                        <option value="custom">ğŸ“ è‡ªè¡Œè¼¸å…¥ç¶“åº¦...</option>
                    </select>

                    <div id="custom-longitude-group" style="display:none;margin-top:8px">
                        <input type="number" id="birth-longitude" class="form-input" placeholder="è¼¸å…¥ç¶“åº¦ (ä¾‹å¦‚ 121.5)"
                            step="0.01" value="121.5" min="0" max="180">
                        <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px">å°ç£ç¶“åº¦ç´„ 120-122 åº¦ï¼Œæ¯å·® 1
                            åº¦å½±éŸ¿ç´„ 4 åˆ†é˜ã€‚</div>
                    </div>
                </div>
                <p style="font-size:0.72rem;color:var(--ink-faint);margin-top:4px;line-height:1.5">
                    å°åŒ— 121.5Â° ï½œ å°ä¸­ 120.7Â° ï½œ é«˜é›„ 120.3Â° ï½œ åŒ—äº¬ 116.4Â° ï½œ ä¸Šæµ· 121.5Â° ï½œ é¦™æ¸¯ 114.2Â°
                </p>
            </div>



            <button class="btn-gold" onclick="generateChart()" id="btn-generate">
                <span style="display:flex;align-items:center;justify-content:center;gap:8px">
                    <i data-lucide="compass" style="width:20px;height:20px"></i> é–‹å§‹æ’ç›¤
                </span>
            </button>
        </div>
    </div>

    <!-- ========== å‘½ç›¤çµæœ ========== -->
    <div id="view-result" class="view">
        <div id="chart-summary-section" class="glass" style="padding:16px;margin-bottom:14px">
            <h3 style="font-family:var(--font-serif);font-size:1rem;color:var(--gold);margin-bottom:12px;text-align:center"
                id="result-title">å‘½ç›¤çµæœ</h3>
            <div class="chart-summary" id="chart-summary"></div>
        </div>

        <!-- é€²éšåŠŸèƒ½ Tabs -->
        <div class="feature-tabs" id="feature-tabs">
            <div class="feature-tab active" data-tab="chart" onclick="switchTab('chart')">å‘½ç›¤ç¸½è¦½</div>
            <div class="feature-tab" data-tab="explain" onclick="switchTab('explain')">å£èªè§£èªª</div>
            <div class="feature-tab" data-tab="decade" onclick="switchTab('decade')">å¤§é™åˆ†æ</div>
            <div class="feature-tab" data-tab="yearly" onclick="switchTab('yearly')">æµå¹´é‹å‹¢</div>
            <div class="feature-tab" data-tab="monthly" onclick="switchTab('monthly')">æµæœˆç´°çœ‹</div>
            <div class="feature-tab" data-tab="relations" onclick="switchTab('relations')">ä¸‰æ–¹å››æ­£</div>
        </div>

        <!-- Tab: å‘½ç›¤ -->
        <div id="tab-chart" class="tab-content">
            <div class="chart-grid" id="chart-grid"></div>
        </div>

        <!-- Tab: å£èªè§£èªª -->
        <div id="tab-explain" class="tab-content hidden">
            <div class="explain-section" id="explain-content"></div>
        </div>

        <!-- Tab: å¤§é™ -->
        <div id="tab-decade" class="tab-content hidden">
            <div id="decade-content"></div>
        </div>

        <!-- Tab: æµå¹´ -->
        <div id="tab-yearly" class="tab-content hidden">
            <div class="form-group" style="margin:12px 0">
                <label class="form-label">é¸æ“‡æµå¹´å¹´ä»½</label>
                <select id="yearly-select" class="form-select" onchange="renderYearly()"></select>
            </div>
            <div id="yearly-content"></div>
        </div>

        <!-- Tab: æµæœˆ -->
        <div id="tab-monthly" class="tab-content hidden">
            <div style="display:flex;gap:8px;margin:12px 0">
                <div class="form-group" style="flex:1">
                    <label class="form-label">å¹´ä»½</label>
                    <select id="monthly-year" class="form-select" onchange="updateMonthlyOptions()"></select>
                </div>
                <div class="form-group" style="flex:1">
                    <label class="form-label">æœˆä»½</label>
                    <select id="monthly-month" class="form-select" onchange="renderMonthly()">
                        <option value="1">æ­£æœˆ</option>
                        <option value="2">äºŒæœˆ</option>
                        <option value="3">ä¸‰æœˆ</option>
                        <option value="4">å››æœˆ</option>
                        <option value="5">äº”æœˆ</option>
                        <option value="6">å…­æœˆ</option>
                        <option value="7">ä¸ƒæœˆ</option>
                        <option value="8">å…«æœˆ</option>
                        <option value="9">ä¹æœˆ</option>
                        <option value="10">åæœˆ</option>
                        <option value="11">å†¬æœˆ</option>
                        <option value="12">è‡˜æœˆ</option>
                    </select>
                </div>
            </div>
            <div id="monthly-content"></div>
        </div>

        <!-- Tab: ä¸‰æ–¹å››æ­£ -->
        <div id="tab-relations" class="tab-content hidden">
            <div class="form-group" style="margin:12px 0">
                <label class="form-label">é¸æ“‡å®®ä½æŸ¥çœ‹ä¸‰æ–¹å››æ­£</label>
                <select id="relations-palace" class="form-select" onchange="renderRelations()"></select>
            </div>
            <div id="relations-content"></div>
        </div>

        <div style="display:flex;gap:10px;margin-top:16px">
            <button class="btn-secondary" style="flex:1" onclick="saveChart()">
                <span style="display:flex;align-items:center;justify-content:center;gap:6px">
                    <i data-lucide="save" style="width:16px;height:16px"></i> å„²å­˜ç´€éŒ„
                </span>
            </button>
            <button class="btn-secondary" style="flex:1" onclick="showView('view-form')">
                <span style="display:flex;align-items:center;justify-content:center;gap:6px">
                    <i data-lucide="rotate-ccw" style="width:16px;height:16px"></i> é‡æ–°æ’ç›¤
                </span>
            </button>
        </div>
    </div>

    <!-- ========== æ­·å²ç´€éŒ„ ========== -->
    <div id="view-history" class="view">
        <div class="glass" style="padding:20px">
            <h2
                style="font-family:var(--font-serif);font-size:1.1rem;color:var(--gold);margin-bottom:14px;display:flex;align-items:center;gap:8px">
                <i data-lucide="scroll-text" style="width:20px;height:20px"></i> æ­·å²ç´€éŒ„
            </h2>
            <div id="history-list">
                <p style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:30px 0">å°šç„¡ç´€éŒ„</p>
            </div>
        </div>
    </div>

    <!-- ========== é—œæ–¼ ========== -->
    <div id="view-about" class="view">
        <div class="glass explain-card">
            <h4>ğŸŒŸ ä»€éº¼æ˜¯ç´«å¾®æ–—æ•¸ï¼Ÿ</h4>
            <p>ç°¡å–®ä¾†èªªï¼Œç´«å¾®æ–—æ•¸å°±åƒæ˜¯ä½ å‡ºç”Ÿé‚£ä¸€åˆ»çš„ã€Œæ˜Ÿç©ºå¿«ç…§ã€ã€‚å¤äººè§€å¯Ÿå¤©ä¸Šæ˜Ÿè¾°çš„æ’åˆ—ï¼Œç™¼å±•å‡ºé€™å¥—å‘½ç†ç³»çµ±ã€‚
                <strong>å®ƒç”¨åäºŒå€‹å®®ä½ä¾†æè¿°ä½ äººç”Ÿçš„å„å€‹é¢å‘</strong>ï¼Œåƒæ˜¯ä½ çš„å€‹æ€§ã€äº‹æ¥­ã€æ„Ÿæƒ…ã€è²¡é‹ç­‰ç­‰ã€‚æ¯å€‹å®®ä½è£¡é¢æœƒæœ‰ä¸åŒçš„æ˜Ÿæ˜Ÿï¼ˆæˆ‘å€‘å«ã€Œæ˜Ÿæ›œã€ï¼‰ï¼Œé€™äº›æ˜Ÿæ˜Ÿçš„çµ„åˆå°±æ±ºå®šäº†é‚£å€‹é¢å‘çš„ç‰¹è³ªã€‚
            </p>
        </div>
        <div class="glass explain-card">
            <h4>ğŸ“ åäºŒå®®ä½æ˜¯ä»€éº¼ï¼Ÿ</h4>
            <p>ä½ å¯ä»¥æŠŠåäºŒå®®æƒ³åƒæˆäººç”Ÿçš„åäºŒå€‹èˆå°ï¼š<br>
                <strong>å‘½å®®</strong>ï¼ä½ é€™å€‹äººçš„æ ¸å¿ƒå€‹æ€§<br>
                <strong>å…„å¼Ÿå®®</strong>ï¼è·Ÿå…„å¼Ÿå§å¦¹ã€æœ‹å‹çš„é—œä¿‚<br>
                <strong>å¤«å¦»å®®</strong>ï¼æ„Ÿæƒ…è·Ÿå©šå§»ç‹€æ³<br>
                <strong>å­å¥³å®®</strong>ï¼è·Ÿå°å­©çš„ç·£åˆ†ã€æ¡ƒèŠ±<br>
                <strong>è²¡å¸›å®®</strong>ï¼è³ºéŒ¢çš„æ–¹å¼è·Ÿè²¡é‹<br>
                <strong>ç–¾å„å®®</strong>ï¼èº«é«”å¥åº·<br>
                <strong>é·ç§»å®®</strong>ï¼å‡ºå¤–é‹ã€äººéš›é—œä¿‚<br>
                <strong>äº¤å‹å®®</strong>ï¼æœ‹å‹è·Ÿåˆä½œå¤¥ä¼´<br>
                <strong>å®˜ç¥¿å®®</strong>ï¼å·¥ä½œè·Ÿäº‹æ¥­<br>
                <strong>ç”°å®…å®®</strong>ï¼å®¶åº­è·Ÿæˆ¿ç”¢<br>
                <strong>ç¦å¾·å®®</strong>ï¼ç²¾ç¥å±¤é¢ã€æœ‰æ²’æœ‰ç¦æ°£<br>
                <strong>çˆ¶æ¯å®®</strong>ï¼è·Ÿé•·è¼©çš„é—œä¿‚ã€è®€æ›¸é‹
            </p>
        </div>
        <div class="glass explain-card">
            <h4>âœ¨ å››åŒ–æ˜¯ä»€éº¼ï¼Ÿ</h4>
            <p>å››åŒ–å°±åƒæ˜¯æ˜Ÿæ˜Ÿè¢«ã€ŒåŠ æŒã€äº†ç‰¹æ®Šèƒ½é‡ï¼š<br>
                <strong style="color:#2ed573">ç¥¿</strong>ï¼å¥½é‹åŠ å€ã€é †é †åˆ©åˆ©ï¼Œå°±åƒæ‹¿åˆ°å¥½ç‰Œ<br>
                <strong style="color:#ff6b6b">æ¬Š</strong>ï¼æœ‰æ¬ŠåŠ›ã€æœ‰æŒæ§åŠ›ï¼Œä½†ä¹Ÿæ¯”è¼ƒå¼·å‹¢<br>
                <strong style="color:#48dbfb">ç§‘</strong>ï¼æœ‰åæ°£ã€æœ‰è²´äººç›¸åŠ©ï¼Œè°æ˜æ‰æ™º<br>
                <strong style="color:#ff4757">å¿Œ</strong>ï¼å¡é—œã€éœ€è¦ç‰¹åˆ¥æ³¨æ„çš„åœ°æ–¹ï¼Œä½†ä¸ä¸€å®šæ˜¯å£äº‹ï¼Œæœ‰æ™‚å€™æ˜¯å› ç‚ºå¤ªåœ¨ä¹æ‰€ä»¥å®¹æ˜“é‘½ç‰›è§’å°–
            </p>
        </div>
    </div>
    </div>

    <!-- å®®ä½è©³æƒ… Modal -->
    <div id="palace-modal">
        <div class="palace-modal-content" id="palace-modal-body"></div>
    </div>

    <script>
        // ============================================================
        // å…¨åŸŸè¨­å®š
        // ============================================================
        const LIFF_ID = "2008678090-t9dLJLeD"; // â† è«‹æ›¿æ›æˆæ‚¨çš„ LIFF ID
        const API_BASE = "https://zwds-api.vercel.app"; // â† ç§»é™¤å°¾éƒ¨æ–œç·š

        // ä½¿ç”¨è€…ç‹€æ…‹
        const appState = {
            user: { userId: '', displayName: 'è¨ªå®¢', pictureUrl: '' },
            astrolabe: null,        // iztro ç”¢ç”Ÿçš„æ˜Ÿç›¤ç‰©ä»¶
            birthData: null,        // ç›®å‰æ’ç›¤ç”¨çš„å‡ºç”Ÿè³‡æ–™
            isLunar: false,         // æ˜¯å¦ä½¿ç”¨è¾²æ›†
            useTST: true,           // æ˜¯å¦ä½¿ç”¨çœŸå¤ªé™½æ™‚
            history: [],            // æœ¬æ©Ÿæ­·å²ç´€éŒ„
            viewStack: ['view-home']
        };

        // ============================================================
        // çœŸå¤ªé™½æ™‚è¨ˆç®— (True Solar Time)
        // ============================================================
        function getEquationOfTime(dayOfYear) {
            // å‡æ™‚å·®å…¬å¼ (Equation of Time Approximation)
            const B = (360 * (dayOfYear - 81)) / 365;
            const bRad = B * Math.PI / 180;
            return 9.87 * Math.sin(2 * bRad) - 7.53 * Math.cos(bRad) - 1.5 * Math.sin(bRad);
        }

        function calculateTrueSolarTime(dateStr, hourIdx, longitude) {
            const date = new Date(dateStr);
            const startOfYear = new Date(date.getFullYear(), 0, 0);
            const diff = date - startOfYear;
            const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));

            // å‡æ™‚å·® (åˆ†é˜)
            const eot = getEquationOfTime(dayOfYear);

            // ç¶“åº¦ä¿®æ­£ (åˆ†é˜)ï¼šæ¯å·®1åº¦å·®4åˆ†é˜ï¼ŒåŸºæº–ç‚º UTC+8 (120åº¦)
            // å…¬å¼ï¼š(ç•¶åœ°ç¶“åº¦ - 120) * 4
            const longCorrection = (longitude - 120) * 4;

            // ç¸½ä¿®æ­£é‡ (åˆ†é˜)
            const totalCorrection = longCorrection + eot;

            // åŸå§‹æ™‚è¾°å°æ‡‰çš„å°æ™‚ (å–è©²æ™‚è¾°çš„ä¸­é–“å€¼)
            // å­0, ä¸‘1... äº¥11
            const hourMap = [0.5, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 23.5];
            let solarHour = hourMap[hourIdx] + (totalCorrection / 60);

            // ä¿®æ­£åˆ° 0-24 ç¯„åœ
            if (solarHour < 0) solarHour += 24;
            if (solarHour >= 24) solarHour -= 24;

            // åæ¨å› iztro éœ€è¦çš„æ™‚è¾°ç´¢å¼•
            // æ—©å­(0): 00-01, ä¸‘(1): 01-03 ... æ™šå­(12): 23-00
            if (solarHour >= 23 || solarHour < 1) return 12; // æ™šå­/æ—©å­æš«æ­¸ç‚ºå­æ™‚ï¼Œiztro åªæœ‰ 0-11ï¼Œæ™šå­ç®—0
            if (solarHour < 1) return 0; // æ—©å­
            if (solarHour >= 1 && solarHour < 3) return 1;
            if (solarHour >= 3 && solarHour < 5) return 2;
            if (solarHour >= 5 && solarHour < 7) return 3;
            if (solarHour >= 7 && solarHour < 9) return 4;
            if (solarHour >= 9 && solarHour < 11) return 5;
            if (solarHour >= 11 && solarHour < 13) return 6;
            if (solarHour >= 13 && solarHour < 15) return 7;
            if (solarHour >= 15 && solarHour < 17) return 8;
            if (solarHour >= 17 && solarHour < 19) return 9;
            if (solarHour >= 19 && solarHour < 21) return 10;
            if (solarHour >= 21 && solarHour < 23) return 11;
            return 0;
        }

        // ============================================================
        // æ˜Ÿç©ºèƒŒæ™¯å‹•ç•«
        // ============================================================
        function initStarCanvas() {
            const c = document.getElementById('star-canvas');
            const ctx = c.getContext('2d');
            let stars = [];
            function resize() { c.width = window.innerWidth; c.height = window.innerHeight; }
            resize(); window.addEventListener('resize', resize);
            for (let i = 0; i < 120; i++) {
                stars.push({ x: Math.random() * c.width, y: Math.random() * c.height, r: Math.random() * 1.5 + 0.3, speed: Math.random() * 0.3 + 0.05, opacity: Math.random() });
            }
            function draw() {
                ctx.clearRect(0, 0, c.width, c.height);
                stars.forEach(s => {
                    s.opacity += (Math.random() - 0.5) * 0.02;
                    s.opacity = Math.max(0.1, Math.min(1, s.opacity));
                    s.y -= s.speed; if (s.y < 0) { s.y = c.height; s.x = Math.random() * c.width; }
                    ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(200,190,255,${s.opacity * 0.6})`; ctx.fill();
                });
                requestAnimationFrame(draw);
            }
            draw();
        }

        // ============================================================
        // å·¥å…·å‡½å¼
        // ============================================================
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const back = document.getElementById('btn-back');
            if (id === 'view-home') {
                back.classList.add('hidden');
                appState.viewStack = ['view-home'];
            } else {
                back.classList.remove('hidden');
                if (appState.viewStack[appState.viewStack.length - 1] !== id) appState.viewStack.push(id);
            }
            // æ›´æ–°æ¨™é¡Œ
            const titles = { 'view-home': 'ç´«å¾®æ–—æ•¸', 'view-form': 'æ’ç›¤è¼¸å…¥', 'view-result': 'å‘½ç›¤çµæœ', 'view-history': 'æ­·å²ç´€éŒ„', 'view-about': 'èªè­˜ç´«å¾®æ–—æ•¸' };
            document.getElementById('header-title').textContent = titles[id] || 'ç´«å¾®æ–—æ•¸';
            window.scrollTo(0, 0);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function goBack() {
            appState.viewStack.pop();
            const prev = appState.viewStack[appState.viewStack.length - 1] || 'view-home';
            showView(prev);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.querySelectorAll('.feature-tab').forEach(el => el.classList.toggle('active', el.dataset.tab === tabId));
        }

        function toggleCalendar() {
            appState.isLunar = !appState.isLunar;
            const tog = document.getElementById('cal-toggle');
            const label = document.getElementById('cal-label');
            const hint = document.getElementById('cal-hint');
            const leapGrp = document.getElementById('leap-group');
            tog.classList.toggle('active', appState.isLunar);
            if (appState.isLunar) {
                label.textContent = 'ğŸŒ™ è¾²æ›†'; hint.textContent = 'é»æ“Šåˆ‡æ›åœ‹æ›†';
                leapGrp.style.display = 'block';
            } else {
                label.textContent = 'â˜€ï¸ åœ‹æ›†ï¼ˆé™½æ›†ï¼‰'; hint.textContent = 'é»æ“Šåˆ‡æ›è¾²æ›†';
                leapGrp.style.display = 'none';
            }
        }

        function toggleTST() {
            appState.useTST = !appState.useTST;
            const tog = document.getElementById('tst-toggle');
            const label = document.getElementById('tst-label');
            tog.classList.toggle('active', appState.useTST);
            label.textContent = appState.useTST ? 'âœ… å•Ÿç”¨çœŸå¤ªé™½æ™‚æ ¡æ­£' : 'â¬œ åœç”¨çœŸå¤ªé™½æ™‚æ ¡æ­£';
        }

        function checkCustomLocation() {
            const select = document.getElementById('birth-lotitude-select');
            const customGroup = document.getElementById('custom-longitude-group');
            if (select.value === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        }

        // ============================================================
        // åäºŒæ™‚è¾°åç¨±å°ç…§
        // ============================================================
        const HOUR_NAMES = ['æ—©å­æ™‚', 'ä¸‘æ™‚', 'å¯…æ™‚', 'å¯æ™‚', 'è¾°æ™‚', 'å·³æ™‚', 'åˆæ™‚', 'æœªæ™‚', 'ç”³æ™‚', 'é…‰æ™‚', 'æˆŒæ™‚', 'äº¥æ™‚', 'æ™šå­æ™‚'];

        // ============================================================
        // æ ¸å¿ƒæ’ç›¤
        // ============================================================
        function generateChart() {
            const dateStr = document.getElementById('birth-date').value;
            let hour = parseInt(document.getElementById('birth-hour').value);
            const gender = document.getElementById('birth-gender').value;

            // å–å¾—ç¶“åº¦
            let longitude = 121.5;
            const locSelect = document.getElementById('birth-lotitude-select');
            if (locSelect && locSelect.value !== 'custom') {
                longitude = parseFloat(locSelect.value);
            } else {
                const manualInput = parseFloat(document.getElementById('birth-longitude').value);
                if (!isNaN(manualInput)) longitude = manualInput;
            }

            if (!dateStr) { showToast('è«‹å¡«å¯«å‡ºç”Ÿæ—¥æœŸ'); return; }

            // çœŸå¤ªé™½æ™‚æ ¡æ­£
            let finalHour = hour;
            if (appState.useTST && !appState.isLunar) {
                // è¾²æ›†å¦‚æœå•Ÿç”¨æ ¡æ­£æ¯”è¼ƒè¤‡é›œï¼Œç›®å‰åƒ…æ”¯æ´é™½æ›†æ ¡æ­£
                finalHour = calculateTrueSolarTime(dateStr, hour, longitude);
            }

            try {
                let astrolabe;
                if (appState.isLunar) {
                    const [y, m, d] = dateStr.split('-');
                    const lunarDate = `${y}-${m}-${d}`;
                    const isLeap = document.getElementById('is-leap-month').checked;
                    astrolabe = iztro.astro.byLunar(lunarDate, finalHour, gender, isLeap, true, 'zh-TW');
                } else {
                    astrolabe = iztro.astro.bySolar(dateStr, finalHour, gender, true, 'zh-TW');
                }

                appState.astrolabe = astrolabe;
                appState.birthData = {
                    date: dateStr,
                    hour: hour, // é¡¯ç¤ºç”¨åŸå§‹æ™‚è¾°
                    realHour: finalHour, // å¯¦éš›è¨ˆç®—ç”¨æ™‚è¾°
                    gender,
                    isLunar: appState.isLunar,
                    isLeap: document.getElementById('is-leap-month').checked,
                    longitude: longitude,
                    useTST: appState.useTST
                };

                renderChartResult();
                showView('view-result');
                showToast('æ’ç›¤å®Œæˆï¼');
            } catch (e) {
                console.error('æ’ç›¤éŒ¯èª¤', e);
                showToast('æ’ç›¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥æœŸæ˜¯å¦æ­£ç¢º');
            }
        }

        // ============================================================
        // æ¸²æŸ“å‘½ç›¤çµæœ
        // ============================================================

        // ç´«å¾®æ–—æ•¸çš„å®®ä½åœ¨æ˜Ÿç›¤ä¸­çš„æ’åˆ—é †åºï¼ˆå¾å·¦ä¸‹è§’é€†æ™‚é‡ï¼‰
        // å‚³çµ±æ’åˆ—ï¼šå·³åˆæœªç”³ / è¾°.é…‰ / å¯.æˆŒ / å¯…ä¸‘å­äº¥
        // å°æ‡‰åˆ° 4x4 grid (row-major)ï¼š
        // [å·³, åˆ, æœª, ç”³]  â†’ row 0
        // [è¾°,       , é…‰]  â†’ row 1
        // [å¯,       , æˆŒ]  â†’ row 2
        // [å¯…, ä¸‘, å­, äº¥]  â†’ row 3
        const GRID_POSITIONS = [
            // [paletIdx, gridRow, gridCol] â€” palaceIdx æ˜¯ iztro palaces é™£åˆ—çš„ç´¢å¼•
            // iztro çš„ palaces é †åºæ˜¯å›ºå®šå¾å‘½å®®é–‹å§‹çš„åäºŒå®®
            // æˆ‘å€‘éœ€è¦æ ¹æ“šåœ°æ”¯ä½ç½®ä¾†æ’åˆ—
        ];

        // ============================================================
        // æ¸²æŸ“å‘½ç›¤çµæœ (æ•´åˆ Summary + Grid + Explain)
        // ============================================================
        function renderChartResult() {
            const astro = appState.astrolabe;
            if (!astro) return;

            // 1. å‘½ç›¤æ‘˜è¦
            const summary = document.getElementById('chart-summary');
            const fiveElements = astro.fiveElementsClass;
            const soul = astro.soul;
            const bodySoul = astro.bodySoul;

            summary.innerHTML = `
                <div class="summary-item"><div class="label">äº”è¡Œå±€</div><div class="value">${fiveElements}</div></div>
                <div class="summary-item"><div class="label">å‘½ä¸»</div><div class="value">${soul || 'â€”'}</div></div>
                <div class="summary-item"><div class="label">èº«ä¸»</div><div class="value">${bodySoul || 'â€”'}</div></div>
                <div class="summary-item"><div class="label">è¾²æ›†ç”Ÿè¾°</div><div class="value" style="font-size:0.9rem">${astro.lunarDate.year}å¹´${astro.lunarDate.month}æœˆ${astro.lunarDate.day}æ—¥</div></div>
                ${appState.birthData.useTST ? `<div class="summary-item"><div class="label">çœŸå¤ªé™½æ™‚</div><div class="value" style="font-size:0.9rem">${HOUR_NAMES[appState.birthData.realHour]}</div></div>` : ''}
            `;

            document.getElementById('result-title').textContent =
                `${appState.birthData.date} ${HOUR_NAMES[appState.birthData.hour]} ${appState.birthData.gender}å‘½`;

            // 2. å‘½ç›¤ç¶²æ ¼ (4x4, ä½†éœ€è¦ç’°ç‹€æ’åˆ—)
            // iztro palace.earthlyBranch ä¹Ÿæ˜¯å–®å­—
            const palaceMap = {};
            astro.palaces.forEach(p => {
                palaceMap[p.earthlyBranch] = p;
            });

            const gridOrder = [
                'å·³', 'åˆ', 'æœª', 'ç”³',
                'è¾°', '', '', 'é…‰',
                'å¯', '', '', 'æˆŒ',
                'å¯…', 'ä¸‘', 'å­', 'äº¥'
            ];

            const gridEl = document.getElementById('chart-grid');
            gridEl.innerHTML = '';

            gridOrder.forEach((branch, idx) => {
                if (!branch) {
                    // ä¸­é–“ç•™ç™½å€å¡Š
                    // åªæœ‰ç•¶å®ƒæ˜¯ç¬¬ä¸€å€‹ç©ºç™½æ ¼æ™‚ (idx=5)ï¼Œæ’å…¥è£é£¾æˆ–è³‡è¨Š
                    if (idx === 5) {
                        const centerDiv = document.createElement('div');
                        centerDiv.className = 'chart-center-info';
                        centerDiv.style.gridColumn = 'span 2';
                        centerDiv.style.gridRow = 'span 2';
                        centerDiv.style.display = 'flex';
                        centerDiv.style.flexDirection = 'column';
                        centerDiv.style.alignItems = 'center';
                        centerDiv.style.justifyContent = 'center';
                        centerDiv.style.height = '100%';
                        centerDiv.style.pointerEvents = 'none';
                        centerDiv.innerHTML = `
                            <div style="font-family:var(--font-serif);font-size:1.5rem;font-weight:900;color:rgba(0,0,0,0.03);user-select:none">ç´«å¾®æ–—æ•¸</div>
                        `;
                        gridEl.appendChild(centerDiv);
                    }
                    return;
                }
                const p = palaceMap[branch];
                if (!p) return;

                const isMing = p.name === 'å‘½å®®';
                const div = document.createElement('div');
                div.className = `palace-cell ${isMing ? 'highlight' : ''}`;
                div.onclick = () => showPalaceDetail(p.index);

                // æ˜Ÿæ›œåˆ—è¡¨
                const majorStars = (p.majorStars || []).filter(s => s.name).map(s => {
                    return `<div class="star-item"><span class="star-name major">${s.name}</span><span class="star-bright">${s.brightness || ''}</span>${s.mutagen ? `<span class="star-hua ${s.mutagen === 'ç¥¿' ? 'hua-lu' : s.mutagen === 'æ¬Š' ? 'hua-quan' : s.mutagen === 'ç§‘' ? 'hua-ke' : 'hua-ji'}">${s.mutagen}</span>` : ''}</div>`;
                }).join('');

                const minorStars = (p.minorStars || []).filter(s => s.name).slice(0, 4).map(s => { // æœ€å¤šé¡¯ç¤º4é¡†å‰¯æ˜Ÿ
                    return `<div class="star-item"><span class="star-name minor">${s.name}</span>${s.mutagen ? `<span class="star-hua ${s.mutagen === 'ç¥¿' ? 'hua-lu' : s.mutagen === 'æ¬Š' ? 'hua-quan' : s.mutagen === 'ç§‘' ? 'hua-ke' : 'hua-ji'}">${s.mutagen}</span>` : ''}</div>`;
                }).join('');

                // å¤§é™
                const range = p.ages ? `${p.ages[0]}-${p.ages[p.ages.length - 1]}` : '';

                div.innerHTML = `
                    <div class="palace-header">
                        <span class="palace-name">${p.name}</span>
                        <span class="palace-ages">${range}</span>
                    </div>
                    <div class="star-list">
                        ${majorStars}
                        ${minorStars}
                    </div>
                    <div class="palace-footer">
                        <span class="palace-stem">${p.heavenlyStem}${p.earthlyBranch}</span>
                    </div>
                `;
                gridEl.appendChild(div);
            });

            // 3. æ¸²æŸ“é€²éšåŠŸèƒ½
            renderExplanation(astro);
            renderDecade(astro);
            renderYearly(); // é è¨­ä»Šå¹´
            initYearlySelector(astro);
            initMonthlySelector(astro);
            initRelationsSelector(astro);

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // ============================================================
        // å£èªè§£èªª (çµåˆæ˜Ÿåº§ã€å››åŒ–ã€äº®åº¦ã€å‰¯æ˜Ÿ)
        // ============================================================
        function renderExplanation(astro) {
            const container = document.getElementById('explain-content');
            const palaces = astro.palaces;
            let html = '';

            // å‘½å®®
            const ming = palaces.find(p => p.name === 'å‘½å®®');
            if (ming) html += explainCard('ğŸ§™ å‘½å®® â€” ä½ çš„æ ¸å¿ƒå€‹æ€§', getPersonalityExplain(ming.majorStars || [], ming));

            // å®˜ç¥¿å®®
            const career = palaces.find(p => p.name === 'å®˜ç¥¿å®®');
            if (career) html += explainCard('ğŸ’¼ å®˜ç¥¿å®® â€” é©åˆçš„å·¥ä½œ', getCareerExplain(career.majorStars || [], career));

            // è²¡å¸›å®®
            const wealth = palaces.find(p => p.name === 'è²¡å¸›å®®');
            if (wealth) html += explainCard('ğŸ’° è²¡å¸›å®® â€” è²¡é‹å¦‚ä½•', getWealthExplain(wealth.majorStars || [], wealth));

            // å¤«å¦»å®®
            const spouse = palaces.find(p => p.name === 'å¤«å¦»å®®');
            if (spouse) html += explainCard('ğŸ’• å¤«å¦»å®® â€” æ„Ÿæƒ…èˆ‡å©šå§»', getSpouseExplain(spouse.majorStars || [], spouse));

            // ç¦å¾·å®® (æ–°å¢)
            const fortune = palaces.find(p => p.name === 'ç¦å¾·å®®');
            if (fortune) html += explainCard('ğŸ§˜ ç¦å¾·å®® â€” ç²¾ç¥èˆ‡ç¦æ°£', getFortuneExplain(fortune.majorStars || [], fortune));

            // ç–¾å„å®® (æ–°å¢)
            const health = palaces.find(p => p.name === 'ç–¾å„å®®');
            if (health) html += explainCard('ğŸ¥ ç–¾å„å®® â€” å¥åº·æ³¨æ„', getHealthExplain(health.majorStars || [], health));

            // é·ç§»å®®
            const travel = palaces.find(p => p.name === 'é·ç§»å®®');
            if (travel) {
                html += explainCard('âœˆï¸ é·ç§»å®® â€” å¤–å‡ºèˆ‡äººéš›', getGeneralPalaceExplain(travel, 'é·ç§»å®®ä»£è¡¨ä½ åœ¨å¤–é¢çš„éš›é‡ã€å‡ºé é–€çš„é‹å‹¢ï¼Œä»¥åŠçµ¦äººçš„ç¬¬ä¸€å°è±¡ã€‚', {
                    'ç´«å¾®': 'åœ¨å¤–æœ‰è²´äººï¼Œå—äººæ•¬é‡', 'å¤©æ©Ÿ': 'é©åˆåœ¨å¤–åœ°ç™¼å±•ï¼Œè®Šå‹•å¤š', 'å¤ªé™½': 'åœ¨å¤–æ´»èºï¼Œå–œæ­¡äº¤éš›',
                    'æ­¦æ›²': 'åœ¨å¤–å¥”æ³¢å‹ç¢Œæ±‚è²¡', 'å¤©åŒ': 'å‡ºå¤–æœ‰ç¦æ°£ï¼Œå°‘æ“å¿ƒ', 'å»‰è²': 'åœ¨å¤–äº¤éš›æ‡‰é…¬å¤š',
                    'å¤©åºœ': 'å‡ºå¤–é‹å‹¢ç©©å®šï¼Œæœ‰è²´äººç›¸åŠ©', 'å¤ªé™°': 'åœ¨å¤–äººç·£å¥½ï¼Œé©åˆå¤œé–“æ´»å‹•', 'è²ªç‹¼': 'åœ¨å¤–æ¡ƒèŠ±å¤šï¼Œäº¤éŠå»£é—Š',
                    'å·¨é–€': 'åœ¨å¤–æ˜“æœ‰å£èˆŒæ˜¯é', 'å¤©ç›¸': 'åœ¨å¤–æœ‰äººç·£ï¼Œå¸¸æœ‰äººå¹«å¿™', 'å¤©æ¢': 'åœ¨å¤–æœ‰é•·è¼©ç·£ï¼Œé€¢å‡¶åŒ–å‰',
                    'ä¸ƒæ®º': 'åœ¨å¤–å¥”æ³¢ï¼Œé è‡ªå·±æ‰“å¤©ä¸‹', 'ç ´è»': 'åœ¨å¤–è®Šå‹•å¤§ï¼Œå¯èƒ½å¸¸æ¬å®¶æˆ–æ›ç’°å¢ƒ'
                }));
            }

            // ç”°å®…å®®
            const property = palaces.find(p => p.name === 'ç”°å®…å®®');
            if (property) {
                html += explainCard('ğŸ  ç”°å®…å®® â€” å±…ä½èˆ‡ä¸å‹•ç”¢', getGeneralPalaceExplain(property, 'ç”°å®…å®®ä»£è¡¨ä½ çš„å±…ä½ç’°å¢ƒã€ä¸å‹•ç”¢é‹å‹¢ï¼Œä»¥åŠå®¶åº­æ°£æ°›ã€‚', {
                    'ç´«å¾®': 'ä½å®¶ç’°å¢ƒé«˜é›…ï¼Œå¯èƒ½ä½åœ¨é«˜æ¨“æˆ–åœ°å‹¢é«˜è™•', 'å¤©æ©Ÿ': 'å¸¸æ¬å®¶æˆ–æ›´å‹•å®¶ä¸­æ“ºè¨­', 'å¤ªé™½': 'å…‰ç·šå……è¶³ï¼Œä½å®¶ç’°å¢ƒæ˜äº®',
                    'æ­¦æ›²': 'é è¿‘é‡‘èæ©Ÿæ§‹æˆ–è»è­¦å–®ä½', 'å¤©åŒ': 'ä½å®¶èˆ’é©ï¼Œæœ‰æ°´æˆ–ä½çªªåœ°', 'å»‰è²': 'å®¶ä¸­é›»å™¨å¤šï¼Œæˆ–é™„è¿‘æœ‰è®Šé›»æ‰€',
                    'å¤©åºœ': 'ä½å®¶å¯¬æ•ï¼Œåœ°æ®µå¥½', 'å¤ªé™°': 'ä½å®¶å…‰ç·šè¼ƒæš—ï¼Œæˆ–é è¿‘æ°´é‚Š', 'è²ªç‹¼': 'ä½å®¶é™„è¿‘ç†±é¬§æˆ–æœ‰å¨›æ¨‚å ´æ‰€',
                    'å·¨é–€': 'é™„è¿‘æœ‰æ°´æºæˆ–å·¨å‹å»ºç¯‰ï¼Œæ˜“æœ‰å™ªéŸ³', 'å¤©ç›¸': 'ä½å®¶ç’°å¢ƒå„ªé›…ï¼Œé„°å±…å’Œå–„', 'å¤©æ¢': 'ä½å®¶é™„è¿‘æœ‰é†«é™¢ã€å¯ºå»Ÿæˆ–è€æ¨¹',
                    'ä¸ƒæ®º': 'ä½å®¶é™„è¿‘ç’°å¢ƒé›œäº‚æˆ–æœ‰è­¦å±€', 'ç ´è»': 'ä½å®¶è€èˆŠæˆ–é›œäº‚ï¼Œå¯èƒ½æ¼æ°´'
                }));
            }

            // å­å¥³å®®
            const children = palaces.find(p => p.name === 'å­å¥³å®®');
            if (children) {
                html += explainCard('ğŸ‘¶ å­å¥³å®® â€” å­å¥³èˆ‡æ¡ƒèŠ±', getGeneralPalaceExplain(children, 'å­å¥³å®®é™¤äº†çœ‹å­å¥³ç‹€æ³ï¼Œä¹Ÿä»£è¡¨ä½ çš„æ¡ƒèŠ±é‹ï¼ˆæ€§ç”Ÿæ´»ï¼‰ä»¥åŠèˆ‡æ™šè¼©çš„é—œä¿‚ã€‚', {
                    'ç´«å¾®': 'å­å¥³å„ªç§€ï¼Œæœ‰é ˜å°æ½›åŠ›', 'å¤©æ©Ÿ': 'å­å¥³è°æ˜æ´»æ½‘ï¼Œå¥½å‹•', 'å¤ªé™½': 'å­å¥³é–‹æœ—ï¼Œæ´»æ½‘å¥½å‹•',
                    'æ­¦æ›²': 'å­å¥³å€‹æ€§å‰›å¼·ï¼Œè¼ƒåš´è‚…', 'å¤©åŒ': 'å­å¥³è²¼å¿ƒä¹–å·§ï¼Œæ„›æ’’å¬Œ', 'å»‰è²': 'å­å¥³å€‹æ€§å¼·ç¡¬ï¼Œæ³¨æ„è¦ªå­æºé€š',
                    'å¤©åºœ': 'å­å¥³ç©©é‡ï¼Œæœ‰è²¬ä»»æ„Ÿ', 'å¤ªé™°': 'å­å¥³æº«æŸ”ï¼Œæœ‰è—è¡“å¤©åˆ†', 'è²ªç‹¼': 'å­å¥³è°æ˜ï¼Œæ…¾æœ›è¼ƒå¼·',
                    'å·¨é–€': 'å­å¥³å£æ‰å¥½ï¼Œä½†å®¹æ˜“æœ‰ä»£æº', 'å¤©ç›¸': 'å­å¥³æ•¦åšï¼Œé‡å¤–è¡¨', 'å¤©æ¢': 'å­å¥³æ—©ç†Ÿï¼Œå­é †',
                    'ä¸ƒæ®º': 'å­å¥³å€‹æ€§å›é€†ï¼Œé›£ç®¡æ•™', 'ç ´è»': 'å­å¥³ç ´å£åŠ›å¼·ï¼Œå¥½å‹•'
                }));
            }

            // çˆ¶æ¯å®®
            const parents = palaces.find(p => p.name === 'çˆ¶æ¯å®®');
            if (parents) {
                html += explainCard('ğŸ‘´ çˆ¶æ¯å®® â€” é•·è¼©èˆ‡ç›¸è²Œ', getGeneralPalaceExplain(parents, 'çˆ¶æ¯å®®ä»£è¡¨èˆ‡çˆ¶æ¯çš„ç·£åˆ†ã€é•·è¼©ææ”œé‹ï¼Œä¹Ÿä»£è¡¨ä½ çš„ç›¸è²Œæ°£è³ªã€‚', {
                    'ç´«å¾®': 'çˆ¶æ¯æœ‰æ¬Šå¨ï¼Œå—äººæ•¬é‡', 'å¤©æ©Ÿ': 'çˆ¶æ¯å–„è‰¯é€™è°æ˜ï¼Œä½†è¼ƒæ“å‹', 'å¤ªé™½': 'çˆ¶è¦ªè¼ƒå¼·å‹¢æˆ–ç„¡ç·£',
                    'æ­¦æ›²': 'çˆ¶æ¯å€‹æ€§å‰›æ¯…ï¼Œèªªè©±åš´è‚…', 'å¤©åŒ': 'çˆ¶æ¯æ…ˆç¥¥ï¼Œæ„Ÿæƒ…å¥½', 'å»‰è²': 'èˆ‡çˆ¶æ¯ç·£åˆ†è¼ƒè–„ï¼Œæˆ–æœ‰ä»£æº',
                    'å¤©åºœ': 'çˆ¶æ¯æ…ˆç¥¥ï¼Œé›–ç„¶å˜®å¨ä½†æ„›è­·å­å¥³', 'å¤ªé™°': 'æ¯è¦ªè¼ƒå¼·å‹¢æˆ–ç„¡ç·£', 'è²ªç‹¼': 'çˆ¶æ¯æ„Ÿæƒ…è¤‡é›œæˆ–é›¢ç•°',
                    'å·¨é–€': 'èˆ‡çˆ¶æ¯æ˜“æœ‰å£è§’', 'å¤©ç›¸': 'çˆ¶æ¯é–‹æ˜ï¼Œé‡æ‰“æ‰®', 'å¤©æ¢': 'çˆ¶æ¯é•·å£½ï¼Œæœ‰å¨åš´',
                    'ä¸ƒæ®º': 'çˆ¶æ¯ç®¡æ•™åš´æ ¼ï¼Œæ—©å¹´é›¢å®¶', 'ç ´è»': 'èˆ‡çˆ¶æ¯ç·£åˆ†è–„ï¼Œæ—©å¹´é›¢å®¶'
                }));
            }

            // åƒ•å½¹å®®
            const friends = palaces.find(p => p.name === 'åƒ•å½¹å®®') || palaces.find(p => p.name === 'äº¤å‹å®®');
            if (friends) {
                html += explainCard('ğŸ¤ åƒ•å½¹å®® â€” æœ‹å‹èˆ‡äººè„ˆ', getGeneralPalaceExplain(friends, 'åƒ•å½¹å®®ï¼ˆäº¤å‹å®®ï¼‰çœ‹ä½ èˆ‡æœ‹å‹ã€åŒäº‹ã€ä¸‹å±¬çš„é—œä¿‚ã€‚', {
                    'ç´«å¾®': 'çµäº¤æœ‰åœ°ä½çš„æœ‹å‹ï¼Œèƒ½å¾—åŠ©ç›Š', 'å¤©æ©Ÿ': 'æœ‹å‹å¤šä½†æµå‹•å¿«', 'å¤ªé™½': 'æœ‹å‹ç†±æƒ…ï¼Œå–œæ­¡åŠ©äºº',
                    'æ­¦æ›²': 'æœ‹å‹å¤šç‚ºå‰›æ¯…ä¹‹äººï¼Œæˆ–æœ‰é‡‘éŒ¢å¾€ä¾†', 'å¤©åŒ': 'æœ‹å‹å¤šç‚ºåƒå–ç©æ¨‚ä¼´ä¾¶', 'å»‰è²': 'æœ‹å‹å¤šæ¨£åŒ–ï¼Œæ³¨æ„æå‹',
                    'å¤©åºœ': 'æœ‹å‹ç©©é‡ï¼Œå€¼å¾—ä¿¡è³´', 'å¤ªé™°': 'ç•°æ€§æœ‹å‹å¤š', 'è²ªç‹¼': 'é…’è‚‰æœ‹å‹å¤šï¼Œæ¡ƒèŠ±æ—º',
                    'å·¨é–€': 'æœ‹å‹é–“æ˜“æœ‰æ˜¯éå£èˆŒ', 'å¤©ç›¸': 'æœ‹å‹å¤šæœ‰æ­£ç¾©æ„Ÿ', 'å¤©æ¢': 'æœ‹å‹å¤šç‚ºé•·è€…æˆ–å°ˆæ¥­äººå£«',
                    'ä¸ƒæ®º': 'æœ‹å‹å€‹æ€§è¡å‹•ï¼Œæ˜“æœ‰è¡çª', 'ç ´è»': 'æœ‹å‹ä¸‰æ•™ä¹æµéƒ½æœ‰ï¼Œå°å¿ƒè¢«æ‹–ç´¯'
                }));
            }

            // å…„å¼Ÿå®®
            const siblings = palaces.find(p => p.name === 'å…„å¼Ÿå®®');
            if (siblings) {
                html += explainCard('ğŸ‘¯ å…„å¼Ÿå®® â€” æ‰‹è¶³èˆ‡ç©è“„', getGeneralPalaceExplain(siblings, 'å…„å¼Ÿå®®çœ‹æ‰‹è¶³æƒ…åˆ†ï¼Œåœ¨ç¾ä»£ä¹Ÿä»£è¡¨ä½ çš„ç¾é‡‘åº«ï¼ˆè²¡åº«ï¼‰ã€‚', {
                    'ç´«å¾®': 'å…„å¼Ÿå§Šå¦¹ä¸­æœ‰æˆå°±é«˜è€…', 'å¤©æ©Ÿ': 'å…„å¼Ÿå§Šå¦¹è°æ˜ï¼Œä½†å¯èƒ½å„å¥”æ±è¥¿', 'å¤ªé™½': 'å…„å¼Ÿæ„Ÿæƒ…ä¸éŒ¯ï¼Œæœƒäº’åŠ©',
                    'æ­¦æ›²': 'å…„å¼Ÿå°‘ï¼Œæˆ–å€‹æ€§å‰›ç¡¬ä¸åˆ', 'å¤©åŒ': 'å…„å¼Ÿæ„Ÿæƒ…å¥½ï¼Œå¸¸è¯çµ¡', 'å»‰è²': 'å…„å¼Ÿé–“æœ‰ç«¶çˆ­æˆ–ä¸åˆ',
                    'å¤©åºœ': 'å…„å¼Ÿå§Šå¦¹ç©©é‡å¯é ', 'å¤ªé™°': 'è·Ÿå§Šå¦¹æ„Ÿæƒ…è¼ƒå¥½', 'è²ªç‹¼': 'å…„å¼Ÿå§Šå¦¹å„æœ‰æ‰è—',
                    'å·¨é–€': 'æ‰‹è¶³é–“å®¹æ˜“æœ‰çˆ­åŸ·', 'å¤©ç›¸': 'å…„å¼Ÿå§Šå¦¹æ„Ÿæƒ…å¥½ã€äº’ç›¸å¹«å¿™', 'å¤©æ¢': 'å…„å¼Ÿä¸­æœ‰ç…§é¡§ä½ çš„äºº',
                    'ä¸ƒæ®º': 'å…„å¼Ÿå§Šå¦¹åšäº‹æœæ–·ã€ç¨ç«‹', 'ç ´è»': 'æ‰‹è¶³ç·£åˆ†è¼ƒæ·¡ï¼Œå„å¥”æ±è¥¿'
                }));
            }

            // å››åŒ–ç‰¹åˆ¥æé†’
            html += renderHuaSummary(palaces);

            // æ ¼å±€åˆ†æ
            html += renderStarCombinations(palaces);

            // ç¶œåˆå‘½ç›¤ç¸½è©•
            html += renderOverallSummary(palaces, astro);

            container.innerHTML = html;
        }

        function explainCard(title, content) {
            return `<div class="glass explain-card"><h4>${title}</h4><p>${content}</p></div>`;
        }

        // é€šç”¨å®®ä½è§£èªªï¼ˆçµ¦é·ç§»ã€ç”°å®…ç­‰é¡å¤–å®®ä½ä½¿ç”¨ï¼‰
        function getGeneralPalaceExplain(palace, intro, starExplains) {
            const stars = (palace.majorStars || []).filter(s => s.name).map(s => s.name);
            let text = `<em style="color:var(--ink-muted);font-size:0.82rem">${intro}</em><br><br>`;

            if (stars.length === 0) {
                text += 'æ­¤å®®ä½æ²’æœ‰ä¸»æ˜Ÿåé®ï¼Œæœƒå—åˆ°å°å®®çš„æ˜Ÿæ›œå½±éŸ¿ã€‚';
            } else {
                text += stars.map(s => `<strong>${s}</strong>ï¼š${starExplains[s] || 'å¸¶ä¾†ç¨ç‰¹çš„å½±éŸ¿ã€‚'}`).join('<br><br>');
            }

            // å››åŒ–å½±éŸ¿
            const huaStars = (palace.majorStars || []).filter(s => s.mutagen);
            if (huaStars.length) {
                text += '<br><br>âš¡ <strong>å››åŒ–å½±éŸ¿ï¼š</strong>';
                huaStars.forEach(s => {
                    if (s.mutagen === 'ç¥¿') text += `<br>â€¢ ${s.name}åŒ–ç¥¿ â€” é€™æ–¹é¢ç‰¹åˆ¥é †åˆ©ï¼Œæœ‰å¥½é‹æ°£ã€‚`;
                    if (s.mutagen === 'æ¬Š') text += `<br>â€¢ ${s.name}åŒ–æ¬Š â€” é€™æ–¹é¢æœ‰ä¸»å°åŠ›ä½†æ³¨æ„ä¸è¦å¤ªå¼·å‹¢ã€‚`;
                    if (s.mutagen === 'ç§‘') text += `<br>â€¢ ${s.name}åŒ–ç§‘ â€” é€™æ–¹é¢æœ‰è²´äººå¹«å¿™ï¼Œå®¹æ˜“è¢«çœ‹è¦‹ã€‚`;
                    if (s.mutagen === 'å¿Œ') text += `<br>â€¢ ${s.name}åŒ–å¿Œ â€” é€™æ–¹é¢å®¹æ˜“æœ‰é˜»ç¤™ã€‚<br>ã€€ğŸ’¡ åŒ–è§£ï¼šæ”¾å¯¬å¿ƒæ…‹ï¼Œé‡é˜»å°±è½‰å½ï¼Œä¸è¦ç¡¬ç¢°ã€‚`;
                });
            }

            // å®Œæ•´å‰¯æ˜Ÿ/ç…æ˜Ÿ/äº®åº¦åˆ†æ
            text += getFullPalaceAnalysis(palace);
            return text;
        }

        // ============================================================
        // æ ¼å±€åµæ¸¬èˆ‡åˆ†æ
        // ============================================================
        const STAR_COMBOS = [
            { stars: ['ä¸ƒæ®º', 'ç ´è»', 'è²ªç‹¼'], name: 'æ®ºç ´ç‹¼æ ¼', desc: 'ä½ æ˜¯å¤©ç”Ÿçš„é–‹å‰µè€…å’Œæ”¹é©å®¶ï¼äººç”Ÿæœƒç¶“æ­·å¤§èµ·å¤§è½ï¼Œä½†æ¯æ¬¡è·Œå€’éƒ½èƒ½çˆ¬å¾—æ›´é«˜ã€‚é©åˆå‰µæ¥­ã€å¾è»ã€åšæ¥­å‹™ç­‰éœ€è¦è¡å‹çš„äº‹ã€‚', advice: 'å–„ç”¨ä½ çš„è¡Œå‹•åŠ›ï¼Œä½†è¨˜å¾—è¦æœ‰ç­–ç•¥ä¸è¦è »å¹¹ã€‚æ‰¾åˆ°èƒ½åŠ›äº’è£œçš„æ­æª”å¾ˆé‡è¦ã€‚', level: 'å¤§æ ¼å±€' },
            { stars: ['å¤©æ©Ÿ', 'å¤ªé™°', 'å¤©åŒ', 'å¤©æ¢'], name: 'æ©ŸæœˆåŒæ¢æ ¼', desc: 'ä½ æ˜¯ç©©é‡çš„å¯¦åŠ›æ´¾ï¼é©åˆåœ¨å¤§çµ„ç¹”æˆ–é«”åˆ¶å…§ç™¼å±•ï¼Œåƒå…¬å‹™å“¡ã€æ•™å¸«ã€å¤§ä¼æ¥­å“¡å·¥éƒ½å¾ˆé©åˆã€‚', advice: 'ä½ çš„å„ªå‹¢åœ¨ç©©å®šå’Œå°ˆæ¥­ï¼Œä¸é©åˆé«˜é¢¨éšªæŠ•æ©Ÿã€‚é¸å…¬å®¶æ©Ÿé—œæˆ–ä¸Šå¸‚å…¬å¸æ˜¯æ˜æ™ºä¹‹é¸ã€‚', level: 'ç©©å®šæ ¼' },
            { stars: ['ç´«å¾®', 'å¤©åºœ'], name: 'ç´«åºœåŒå®®', desc: 'å¸ç‹åŠ å®°ç›¸ï¼Œä½ å¤©ç”Ÿå¸¶æœ‰é ˜å°æ°£å ´å’Œç®¡ç†æ‰èƒ½ï¼Œåšäº‹ç©©å¥åˆæœ‰é­„åŠ›ã€‚', advice: 'ä½ é©åˆåœ¨å¤§å¹³å°ç™¼æ®ï¼Œä¸è¦å±ˆå°±æ–¼å°æ ¼å±€ã€‚', level: 'è²´æ ¼' },
            { stars: ['å¤ªé™½', 'å¤ªé™°'], name: 'æ—¥æœˆä¸¦æ˜', desc: 'å¦‚æœå¤ªé™½å’Œå¤ªé™°éƒ½åœ¨å¥½ä½ç½®ï¼ˆå»Ÿæ—ºï¼‰ï¼Œä½ ç¦æ¾¤æ·±åšï¼Œä¸€ç”Ÿé †é‚ï¼Œç”·å¥³çš†å®œã€‚', advice: 'ä¿æŒè¬™éœå’Œæ„Ÿæ©å¿ƒæ…‹ï¼Œå¥½é‹æœƒä¸€ç›´æŒçºŒã€‚', level: 'å¤§å‰æ ¼' },
            { stars: ['æ­¦æ›²', 'è²ªç‹¼'], name: 'æ­¦è²ªæ ¼', desc: 'å…ˆè‹¦å¾Œç”œçš„æ ¼å±€ï¼å¹´è¼•æ™‚å¯èƒ½åƒè‹¦è¼ƒå¤šï¼Œä½†ä¸­å¹´å¾Œæœƒæœ‰å¾ˆå¥½çš„ç™¼å±•å’Œè²¡é‹ã€‚', advice: 'å¹´è¼•æ™‚ç›¡é‡å¤šå­¸ç¿’ã€ç´¯ç©ç»é©—ï¼Œ30æ­²å¾Œæœƒè¿ä¾†è±æ”¶æœŸã€‚', level: 'å…ˆè‹¦å¾Œç”œ' },
            { stars: ['å»‰è²', 'ä¸ƒæ®º'], name: 'å»‰æ®ºæ ¼', desc: 'ä½ å€‹æ€§å‰›çƒˆã€æœ‰æ­£ç¾©æ„Ÿï¼Œåšäº‹é›·å²é¢¨è¡Œã€‚é©åˆè»è­¦ã€æ³•å¾‹ã€é†«ç™‚ç­‰éœ€è¦æ±ºæ–·åŠ›çš„è¡Œæ¥­ã€‚', advice: 'æ³¨æ„æ§åˆ¶è„¾æ°£ï¼Œå­¸æœƒä»¥æŸ”å…‹å‰›ã€‚', level: 'å‰›å¼·æ ¼' },
            { stars: ['ç´«å¾®', 'è²ªç‹¼'], name: 'ç´«è²ªæ ¼', desc: 'ä½ æ—¢æœ‰å“å‘³åˆæœ‰ç¤¾äº¤èƒ½åŠ›ï¼Œé©åˆèµ°å¨›æ¨‚ã€æ–‡å‰µã€å¤–äº¤ç­‰è·¯ç·šã€‚æ¡ƒèŠ±é‹æ—ºã€‚', advice: 'å–„ç”¨ä½ çš„é­…åŠ›ä½†ä¸è¦æ²‰è¿·äº«æ¨‚ã€‚', level: 'æ¡ƒèŠ±æ ¼' },
            { stars: ['æ­¦æ›²', 'å¤©åºœ'], name: 'æ­¦åºœæ ¼', desc: 'è²¡æ˜ŸåŠ åº«æ˜Ÿï¼Œä½ å¤©ç”Ÿæœ‰ç†è²¡å¤©åˆ†ï¼Œä¸€ç”Ÿä¸ç¼ºéŒ¢ç”¨ï¼Œæ˜¯ç©©ç©©è³ºçš„é¡å‹ã€‚', advice: 'ç©©å¥æŠ•è³‡ï¼Œé¿å…æŠ•æ©Ÿå–å·§ã€‚', level: 'è²¡åº«æ ¼' },
            { stars: ['å¤ªé™½', 'å·¨é–€'], name: 'æ—¥å·¨æ ¼', desc: 'æœ‰å£æ‰æœ‰æ‰è¯ï¼Œåœ¨å¤ªé™½å»Ÿæ—ºæ™‚èƒ½è¨€å–„é“ã€ååˆ©é›™æ”¶ã€‚', advice: 'å–„ç”¨ä½ çš„å£æ‰ç‰¹é•·ï¼Œå¾äº‹æ•™å­¸ã€å‚³åª’ã€æ¼”è¬›éƒ½å¾ˆå¥½ã€‚', level: 'å£æ‰æ ¼' },
            { stars: ['å¤©åŒ', 'å¤©æ¢'], name: 'åŒæ¢æ ¼', desc: 'æœ‰ç¦æ°£ã€å—é•·è¼©é—œç…§ï¼Œé©åˆå…¬ç›Šã€å®—æ•™ã€é†«ç™‚ç­‰æœå‹™æ€§è³ªçš„å·¥ä½œã€‚', advice: 'ä½ çš„ç¦å ±ä¾†è‡ªæ–¼å¹«åŠ©åˆ¥äººï¼Œè¶ŠåŠ©äººè¶Šæœ‰ç¦ã€‚', level: 'ç¦æ°£æ ¼' },
            { stars: ['å»‰è²', 'å¤©ç›¸'], name: 'å»‰ç›¸æ ¼', desc: 'ä½ è¾¦äº‹èƒ½åŠ›å¼·ã€æœ‰åŸå‰‡åˆæ‡‚å”èª¿ï¼Œé©åˆè¡Œæ”¿ç®¡ç†å·¥ä½œã€‚', advice: 'ç™¼æ®ä½ çš„å”èª¿èƒ½åŠ›ï¼Œç•¶æ½¤æ»‘åŠ‘è€Œéç¡¬ç¢°ã€‚', level: 'ç®¡ç†æ ¼' },
            { stars: ['ç´«å¾®', 'ä¸ƒæ®º'], name: 'ç´«æ®ºæ ¼', desc: 'ä½ æœ‰å¸ç‹ä¹‹æ°£åˆæœ‰å°‡å¸¥ä¹‹é¢¨ï¼Œé©åˆé–‹å‰µå¤§äº‹æ¥­ã€‚', advice: 'è†½å¤§å¿ƒç´°ï¼Œé¸å°æ–¹å‘å°±å…¨åŠ›è¡åˆºã€‚', level: 'å¸å°‡æ ¼' },
            { stars: ['å¤©æ©Ÿ', 'å·¨é–€'], name: 'æ©Ÿå·¨æ ¼', desc: 'é ­è…¦è°æ˜åˆæœ‰è¾¯æ‰ï¼Œé©åˆç ”ç©¶ã€æ³•å¾‹ã€æ•™å­¸ã€è©•è«–å·¥ä½œã€‚', advice: 'æ³¨æ„å˜´å·´ä¸è¦å¤ªæ¯’ï¼Œæœ‰æ‰è¯ä¹Ÿè¦æœ‰ä¿®é¤Šã€‚', level: 'æ‰è¾¯æ ¼' },
            { stars: ['æ­¦æ›²', 'ä¸ƒæ®º'], name: 'æ­¦æ®ºæ ¼', desc: 'åšäº‹æœ‰é­„åŠ›æœ‰è¡Œå‹•åŠ›ï¼Œåœ¨è²¡å‹™æ–¹é¢æœ‰éäººçš„çœ¼å…‰ã€‚é©åˆé‡‘èã€æŠ•è³‡ã€‚', advice: 'æœæ–·æ˜¯å„ªå‹¢ä½†ä¹Ÿè¦é˜²è¡å‹•ï¼Œåšå¥½é¢¨æ§ã€‚', level: 'è¡Œå‹•æ ¼' },
            { stars: ['å¤ªé™°', 'å¤©åŒ'], name: 'åŒé™°æ ¼', desc: 'æº«æŸ”ç´°è†©ã€æœ‰è—è¡“å¤©åˆ†ï¼Œé©åˆæ–‡è—å‰µä½œå’Œè¨­è¨ˆé ˜åŸŸã€‚', advice: 'åˆ¥å¤ªåœ¨æ„ä»–äººè©•åƒ¹ï¼Œåšè‡ªå·±å–œæ­¡çš„äº‹æ‰æ˜¯æ­£é“ã€‚', level: 'æ–‡è—æ ¼' },
            { stars: ['æ­¦æ›²', 'ç ´è»'], name: 'æ­¦ç ´æ ¼', desc: 'æœ‰é–‹å‰µåŠ›å’Œè³ºéŒ¢èƒ½åŠ›ï¼Œä½†è²¡å‹™èµ·ä¼å¤§ã€‚é©åˆåœ¨é€†å¢ƒä¸­ç¿»èº«ã€‚', advice: 'è¨­å¥½åœæé»ï¼Œä¸è¦æŠŠæ‰€æœ‰é›è›‹æ”¾åŒä¸€å€‹ç±ƒå­ã€‚', level: 'é–‹å‰µæ ¼' },
            { stars: ['å¤©æ©Ÿ', 'å¤©æ¢'], name: 'æ©Ÿæ¢æ ¼', desc: 'è°æ˜æœ‰æ™ºæ…§ï¼Œé©åˆç­–åŠƒã€é¡§å•ã€å­¸è¡“ç ”ç©¶ã€‚', advice: 'æŠŠä½ çš„æ™ºæ…§è½‰åŒ–ç‚ºå¯¦éš›è¡Œå‹•ï¼Œåˆ¥åªæ˜¯ç©ºæƒ³ã€‚', level: 'æ™ºæ…§æ ¼' },
            { stars: ['å»‰è²', 'è²ªç‹¼'], name: 'å»‰è²ªæ ¼', desc: 'ä½ æœ‰ç¨ç‰¹çš„é­…åŠ›å’Œç¥ç¥•æ„Ÿï¼Œæ„Ÿæƒ…ç¶“æ­·è±å¯Œï¼Œé©åˆæ¼”è—ã€å…¬é—œè¡Œæ¥­ã€‚', advice: 'ä¿æŒå…§å¿ƒç´”æ·¨ï¼Œä¸è¦è¢«å¤–åœ¨èª˜æƒ‘å¸¶åã€‚', level: 'é­…åŠ›æ ¼' },
        ];

        function renderStarCombinations(palaces) {
            const ming = palaces.find(p => p.name === 'å‘½å®®');
            if (!ming) return '';

            const mingStars = (ming.majorStars || []).filter(s => s.name).map(s => s.name);
            // ä¹Ÿæª¢æŸ¥èº«å®®ã€é·ç§»å®®çš„çµ„åˆ
            const allStarNames = palaces.flatMap(p => (p.majorStars || []).filter(s => s.name).map(s => s.name));

            const foundCombos = [];

            STAR_COMBOS.forEach(combo => {
                // å‘½å®®ä¸­æœ‰æ­¤çµ„åˆ
                const inMing = combo.stars.every(s => mingStars.includes(s));
                // ä¸‰æ–¹å››æ­£ä¸­æœ‰æ­¤çµ„åˆï¼ˆåŒä¸€å€‹å®®ä½ï¼‰
                const inAnyPalace = palaces.some(p => {
                    const pStars = (p.majorStars || []).filter(s => s.name).map(s => s.name);
                    return combo.stars.every(s => pStars.includes(s));
                });

                if (inMing) {
                    foundCombos.push({ ...combo, location: 'å‘½å®®', priority: 1 });
                } else if (inAnyPalace) {
                    const pName = palaces.find(p => {
                        const pStars = (p.majorStars || []).filter(s => s.name).map(s => s.name);
                        return combo.stars.every(s => pStars.includes(s));
                    })?.name || '';
                    foundCombos.push({ ...combo, location: pName, priority: 2 });
                }
            });

            // ç‰¹æ®Šæ ¼å±€ï¼šæ®ºç ´ç‹¼ä¸‰æ˜Ÿåˆ†æ•£åœ¨å‘½å®®ä¸‰æ–¹ï¼ˆå‘½/è²¡/å®˜ï¼‰
            const mingP = palaces.find(p => p.name === 'å‘½å®®');
            const caiP = palaces.find(p => p.name === 'è²¡å¸›å®®');
            const guanP = palaces.find(p => p.name === 'å®˜ç¥¿å®®');
            if (mingP && caiP && guanP) {
                const trio = [mingP, caiP, guanP];
                const trioStars = trio.flatMap(p => (p.majorStars || []).filter(s => s.name).map(s => s.name));
                if (['ä¸ƒæ®º', 'ç ´è»', 'è²ªç‹¼'].every(s => trioStars.includes(s)) && !foundCombos.find(c => c.name === 'æ®ºç ´ç‹¼æ ¼')) {
                    foundCombos.push({
                        name: 'æ®ºç ´ç‹¼æ ¼ï¼ˆä¸‰æ–¹æœƒèšï¼‰', location: 'å‘½/è²¡/å®˜ä¸‰æ–¹',
                        desc: 'æ®ºç ´ç‹¼ä¸‰æ˜Ÿåˆ†æ•£åœ¨ä½ çš„å‘½å®®ä¸‰æ–¹ï¼ˆå‘½å®®ã€è²¡å¸›å®®ã€å®˜ç¥¿å®®ï¼‰ï¼Œä»£è¡¨ä½ çš„äººç”Ÿå……æ»¿æŒ‘æˆ°å’Œæ©Ÿé‡ã€‚ä½ æ˜¯é–‹å‰µå‹çš„äººæ‰ï¼Œé©åˆåœ¨è®ŠåŒ–çš„ç’°å¢ƒä¸­ç™¼æ®ã€‚',
                        advice: 'æ“æŠ±è®ŠåŒ–è€Œä¸æ˜¯æŠ—æ‹’å®ƒã€‚åœ¨äº‹æ¥­ä¸Šå‹‡æ–¼å˜—è©¦æ–°é ˜åŸŸï¼Œä½†è¦åšå¥½é¢¨éšªè©•ä¼°ã€‚',
                        level: 'å¤§æ ¼å±€', priority: 1
                    });
                }
            }

            if (foundCombos.length === 0) return '';

            foundCombos.sort((a, b) => a.priority - b.priority);

            let html = '<div class="glass explain-card"><h4>ğŸŒŒ å‘½ç›¤æ ¼å±€åˆ†æ</h4>';
            html += '<p style="font-size:0.82rem;color:var(--ink-muted);margin-bottom:12px">æ ¼å±€æ˜¯ç´«å¾®æ–—æ•¸æœ€ç²¾è¯çš„éƒ¨åˆ†ï¼Œä»£è¡¨ä½ çš„äººç”Ÿä¸»æ—‹å¾‹ã€‚ä»¥ä¸‹æ˜¯åœ¨ä½ å‘½ç›¤ä¸­åµæ¸¬åˆ°çš„æ ¼å±€ï¼š</p>';

            foundCombos.forEach(combo => {
                html += `<div style="background:rgba(0,0,0,0.03);border:1px solid rgba(0,0,0,0.05);border-radius:4px;padding:14px;margin-bottom:10px">`;
                html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">`;
                html += `<span style="background:var(--ink);color:var(--bg-paper);padding:2px 8px;border-radius:2px;font-size:0.75rem;font-weight:700">${combo.level}</span>`;
                html += `<strong style="color:var(--ink);font-size:1rem">${combo.name}</strong>`;
                html += `<span style="font-size:0.75rem;color:var(--ink-muted)">ï¼ˆ${combo.location}ï¼‰</span>`;
                html += `</div>`;
                html += `<div style="font-size:0.85rem;line-height:1.7;margin-bottom:8px;color:var(--ink-light)">${combo.desc}</div>`;
                html += `<div style="font-size:0.82rem;color:var(--accent);line-height:1.6">ğŸ’¡ <strong>å»ºè­°ï¼š</strong>${combo.advice}</div>`;
                html += `</div>`;
            });

            html += '</div>';
            return html;
        }

        // ============================================================
        // ç¶œåˆå‘½ç›¤ç¸½è©•
        // ============================================================
        function renderOverallSummary(palaces, astro) {
            const ming = palaces.find(p => p.name === 'å‘½å®®');
            const career = palaces.find(p => p.name === 'å®˜ç¥¿å®®');
            const wealth = palaces.find(p => p.name === 'è²¡å¸›å®®');
            const spouse = palaces.find(p => p.name === 'å¤«å¦»å®®');
            const health = palaces.find(p => p.name === 'ç–¾å„å®®');
            const fortune = palaces.find(p => p.name === 'ç¦å¾·å®®');

            // è¨ˆç®—å‰å‡¶æ˜Ÿæ¯”ä¾‹
            let totalGood = 0, totalBad = 0, totalHuaLu = 0, totalHuaJi = 0;
            palaces.forEach(p => {
                const allStars = [...(p.majorStars || []), ...(p.minorStars || []), ...(p.adjectiveStars || [])].filter(s => s.name);
                allStars.forEach(s => {
                    if (['å·¦è¼”', 'å³å¼¼', 'æ–‡æ˜Œ', 'æ–‡æ›²', 'å¤©é­', 'å¤©é‰', 'ç¥¿å­˜', 'å¤©é¦¬', 'ç´…é¸', 'å¤©å–œ'].includes(s.name)) totalGood++;
                    if (['æ“ç¾Š', 'é™€ç¾…', 'ç«æ˜Ÿ', 'éˆ´æ˜Ÿ', 'åœ°ç©º', 'åœ°åŠ«'].includes(s.name)) totalBad++;
                    if (s.mutagen === 'ç¥¿') totalHuaLu++;
                    if (s.mutagen === 'å¿Œ') totalHuaJi++;
                });
            });

            // è¨ˆç®—å‘½å®®ä¸»æ˜Ÿäº®åº¦åˆ†æ•¸
            let brightnessScore = 0;
            if (ming) {
                (ming.majorStars || []).forEach(s => {
                    if (s.brightness === 'å»Ÿ') brightnessScore += 3;
                    else if (s.brightness === 'æ—º') brightnessScore += 2;
                    else if (s.brightness === 'å¾—') brightnessScore += 1;
                    else if (s.brightness === 'é™·') brightnessScore -= 2;
                    else if (s.brightness === 'ä¸') brightnessScore -= 1;
                });
            }

            // ç¶œåˆè©•åˆ†
            let score = 70; // åŸºç¤åˆ†
            score += totalGood * 2;
            score -= totalBad * 2;
            score += totalHuaLu * 5;
            score -= totalHuaJi * 3;
            score += brightnessScore * 3;
            score = Math.max(50, Math.min(98, score));

            // åˆ¤æ–·äººç”Ÿé‡é»æ–¹å‘
            const directions = [];
            if (career) {
                const cStars = (career.majorStars || []).filter(s => s.name);
                if (cStars.some(s => s.brightness === 'å»Ÿ' || s.brightness === 'æ—º')) directions.push('ğŸ’¼ äº‹æ¥­ç™¼å±•æ½›åŠ›å¤§');
                if (cStars.some(s => s.mutagen === 'ç¥¿')) directions.push('ğŸ’¼ äº‹æ¥­æœ‰è²´äºº');
            }
            if (wealth) {
                const wStars = (wealth.majorStars || []).filter(s => s.name);
                if (wStars.some(s => ['æ­¦æ›²', 'å¤©åºœ', 'å¤ªé™°', 'ç¥¿å­˜'].includes(s.name))) directions.push('ğŸ’° è²¡é‹åº•å­å¥½');
                if (wStars.some(s => s.mutagen === 'ç¥¿')) directions.push('ğŸ’° è²¡é‹æœ‰åŠ æŒ');
            }
            if (spouse) {
                const sStars = (spouse.majorStars || []).filter(s => s.name);
                if (sStars.some(s => s.mutagen === 'ç¥¿' || s.mutagen === 'ç§‘')) directions.push('ğŸ’• æ„Ÿæƒ…é‹ä¸éŒ¯');
                if (sStars.some(s => s.mutagen === 'å¿Œ')) directions.push('ğŸ’• æ„Ÿæƒ…éœ€è¦ç¶“ç‡Ÿ');
            }

            // æ‰¾å‡ºéœ€è¦ç‰¹åˆ¥æ³¨æ„çš„å®®ä½
            const warnings = [];
            palaces.forEach(p => {
                const badInPalace = [...(p.minorStars || []), ...(p.adjectiveStars || [])].filter(s => ['æ“ç¾Š', 'é™€ç¾…', 'ç«æ˜Ÿ', 'éˆ´æ˜Ÿ'].includes(s.name));
                const huaJiInPalace = (p.majorStars || []).filter(s => s.mutagen === 'å¿Œ');
                if (badInPalace.length >= 2 || (huaJiInPalace.length > 0 && badInPalace.length > 0)) {
                    warnings.push(p.name);
                }
            });

            // å»ºæ§‹ HTML
            let html = '<div class="glass explain-card" style="border:1px solid rgba(0,0,0,0.1)">';
            html += '<h4 style="font-size:1.1rem">ğŸ“Š ç¶œåˆå‘½ç›¤ç¸½è©•</h4>';

            // åˆ†æ•¸é¡¯ç¤º
            // ä½¿ç”¨æ–°ç‰ˆå¢¨è‰²èª¿ï¼šåˆ†æ•¸é«˜ç”¨æ·±å¢¨è‰²+å¼·èª¿è‰²ï¼Œä½ç”¨æ·¡å¢¨è‰²
            const scoreColor = 'var(--ink)';
            html += `<div style="text-align:center;margin:16px 0">`;
            html += `<div style="font-size:2.5rem;font-weight:900;font-family:var(--font-serif);color:${scoreColor}">${score}</div>`;
            html += `<div style="font-size:0.85rem;color:var(--ink-muted)">å‘½ç›¤ç¶œåˆè©•åˆ†ï¼ˆæ»¿åˆ†100ï¼‰</div>`;
            html += `</div>`;

            // å‰å‡¶æ˜Ÿæ¯”ä¾‹
            html += `<div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">`;
            html += `<div style="flex:1;min-width:120px;background:rgba(0,0,0,0.03);padding:10px;border-radius:4px;text-align:center">`;
            html += `<div style="font-size:1.3rem;font-weight:700;color:var(--ink)">${totalGood}</div><div style="font-size:0.75rem;color:var(--ink-muted)">å‰æ˜Ÿæ•¸é‡</div></div>`;
            html += `<div style="flex:1;min-width:120px;background:rgba(0,0,0,0.03);padding:10px;border-radius:4px;text-align:center">`;
            html += `<div style="font-size:1.3rem;font-weight:700;color:var(--ink-light)">${totalBad}</div><div style="font-size:0.75rem;color:var(--ink-muted)">ç…æ˜Ÿæ•¸é‡</div></div>`;
            html += `<div style="flex:1;min-width:120px;background:rgba(166, 26, 26, 0.05);padding:10px;border-radius:4px;text-align:center">`;
            html += `<div style="font-size:1.3rem;font-weight:700;color:var(--accent)">${totalHuaLu}ç¥¿ / ${totalHuaJi}å¿Œ</div><div style="font-size:0.75rem;color:var(--ink-muted)">å››åŒ–åˆ†å¸ƒ</div></div>`;
            html += `</div>`;

            // äººç”Ÿé‡é»
            if (directions.length) {
                html += '<div style="margin-bottom:14px"><strong style="color:var(--ink)">ğŸŒŸ ä½ çš„å„ªå‹¢æ–¹å‘ï¼š</strong><br>';
                directions.forEach(d => { html += `<span style="display:inline-block;margin:4px 4px 4px 0;padding:4px 12px;background:rgba(0,0,0,0.05);border-radius:2px;font-size:0.82rem;color:var(--ink)">${d}</span>`; });
                html += '</div>';
            }

            // éœ€è¦æ³¨æ„çš„å®®ä½
            if (warnings.length) {
                html += '<div style="margin-bottom:14px"><strong style="color:var(--ink-light)">âš ï¸ éœ€è¦ç‰¹åˆ¥æ³¨æ„çš„å®®ä½ï¼š</strong><br>';
                html += `<span style="font-size:0.85rem;color:var(--ink-muted)">${warnings.join('ã€')} â€” é€™äº›å®®ä½ç…æ˜Ÿè¼ƒå¤šæˆ–æœ‰åŒ–å¿Œè¡çªï¼Œä»£è¡¨é€™äº›é¢å‘å¯èƒ½æœƒé‡åˆ°è¼ƒå¤šæŒ‘æˆ°ã€‚</span>`;
                html += '</div>';
            }

            // æ•´é«”å»ºè­°
            html += '<div style="margin-top:12px;padding:14px;background:rgba(0,0,0,0.03);border-radius:4px;border-left:3px solid var(--ink)">';
            html += '<strong style="color:var(--ink)">ğŸ“ æ•´é«”å»ºè­°ï¼š</strong><br>';
            html += '<span style="font-size:0.85rem;line-height:1.8;color:var(--ink-light)">';

            if (score >= 85) {
                html += 'ä½ çš„å‘½ç›¤æ•´é«”æ ¼å±€å¾ˆå¥½ï¼Œå‰æ˜Ÿå¤šã€ä¸»æ˜Ÿäº®åº¦é«˜ï¼Œä¸€ç”Ÿä¸­æœ‰å¾ˆå¤šæ©Ÿæœƒã€‚é‡é»æ˜¯è¦æ‡‚å¾—æŠŠæ¡æ™‚æ©Ÿï¼Œä¸è¦å› ç‚ºé‹æ°£å¥½å°±é¬†æ‡ˆã€‚æŒçºŒç²¾é€²è‡ªå·±çš„èƒ½åŠ›ï¼Œå¥½é‹æ‰èƒ½æŒä¹…ã€‚';
            } else if (score >= 75) {
                html += 'ä½ çš„å‘½ç›¤æœ‰ä¸éŒ¯çš„åŸºåº•ï¼Œæœ‰äº›æ–¹é¢å¾ˆçªå‡ºï¼Œæœ‰äº›æ–¹é¢éœ€è¦å¤šè²»å¿ƒã€‚å»ºè­°æŠŠç²¾åŠ›é›†ä¸­åœ¨å„ªå‹¢æ–¹å‘ä¸Šï¼Œå¼±å‹¢çš„éƒ¨åˆ†ç”¨åŠªåŠ›å’Œæ™ºæ…§ä¾†å½Œè£œã€‚è¨˜ä½ï¼šå‘½ç›¤æ˜¯åƒè€ƒï¼Œäººç”Ÿæ˜¯è‡ªå·±èµ°å‡ºä¾†çš„ã€‚';
            } else if (score >= 65) {
                html += 'ä½ çš„å‘½ç›¤æŒ‘æˆ°å’Œæ©Ÿæœƒä¸¦å­˜ã€‚ç…æ˜Ÿå¤šä¸ä»£è¡¨ä¸å¥½ï¼Œåè€Œä»£è¡¨ä½ æœ‰è¡å‹å’ŒéŸŒæ€§ã€‚é‡é»æ˜¯å­¸æœƒåœ¨é€†å¢ƒä¸­æˆé•·ï¼Œæ¯æ¬¡å›°é›£éƒ½æ˜¯è®“ä½ è®Šå¼·çš„æ©Ÿæœƒã€‚æ‰¾åˆ°è‡ªå·±çš„ç¯€å¥ï¼Œç©©æ­¥å‰é€²ã€‚';
            } else {
                html += 'ä½ çš„å‘½ç›¤è€ƒé©—æ¯”è¼ƒå¤šï¼Œä½†å¤äººèªªã€Œå¤§æˆè€…å¿…ç¶“è‹¦é›£ã€ã€‚ä½ çš„å‘½ç›¤ä»£è¡¨ä½ æœ‰æ›´å¼·éŸŒçš„å¿ƒç†ç´ è³ªã€‚å–„ç”¨åŒ–è§£ä¹‹é“ï¼šå¤šè¡Œå–„ç©å¾·ã€ä¿æŒè¬™éœã€ç¶“ç‡Ÿå¥½äººéš›é—œä¿‚ã€‚é€†å¢ƒä¸­æ›´è¦å …æŒï¼Œé¢¨é›¨å¾Œå¿…è¦‹å½©è™¹ã€‚';
            }

            html += '</span></div>';
            html += '</div>';

            return html;
        }

        // ============================================================
        // å£èªåŒ–æ˜Ÿæ›œè§£èªªè³‡æ–™åº«
        // ============================================================
        const STAR_PERSONALITY = {
            'ç´«å¾®': 'ä½ éª¨å­è£¡æœ‰ç¨®è€å¤§æ°£è³ªï¼Œå¤©ç”Ÿå°±æœ‰é ˜å°åŠ›ï¼Œä¸å¤ªé¡˜æ„å±ˆå±…äººä¸‹ã€‚åšäº‹æœ‰ä¸»è¦‹ï¼Œæœ‰æ™‚å€™æœƒé¡¯å¾—æ¯”è¼ƒé©•å‚²ï¼Œä½†å…¶å¯¦ä½ åªæ˜¯æ¨™æº–æ¯”è¼ƒé«˜ã€‚',
            'å¤©æ©Ÿ': 'ä½ è…¦è¢‹è½‰å¾—ç‰¹åˆ¥å¿«ï¼Œè°æ˜ã€åæ‡‰éˆæ•ï¼Œå¾ˆæœƒè§€å¯Ÿåˆ†æã€‚ä¸éæœ‰æ™‚å€™æƒ³å¤ªå¤šï¼Œå®¹æ˜“çŒ¶è±«ä¸æ±ºã€‚ä½ é©åˆéœ€è¦å‹•è…¦çš„å·¥ä½œã€‚',
            'å¤ªé™½': 'ä½ å€‹æ€§é–‹æœ—å¤§æ–¹ï¼Œåƒå¤ªé™½ä¸€æ¨£æº«æš–ï¼Œå–œæ­¡å¹«åŠ©åˆ¥äººã€‚ä¸éä¹Ÿå®¹æ˜“ç®¡å¤ªå¤šï¼ŒæŠŠè‡ªå·±æå¾—å¾ˆç´¯ã€‚ç”·å‘½é‡åˆ°å¤ªé™½é€šå¸¸äººç·£ä¸éŒ¯ï¼Œå¥³å‘½å‰‡æ˜¯å®¹æ˜“é‡åˆ°å¥½ç”·äººã€‚',
            'æ­¦æ›²': 'ä½ åšäº‹å¾ˆæœ‰é­„åŠ›ï¼ŒåŸ·è¡ŒåŠ›è¶…å¼·ï¼Œèªªåˆ°åšåˆ°ã€‚è·Ÿè²¡é‹æœ‰é—œçš„æ˜Ÿï¼Œæ‰€ä»¥ä½ è³ºéŒ¢çš„èƒ½åŠ›ä¸å·®ã€‚ç¼ºé»æ˜¯æœ‰æ™‚å€™å¤ªç›´æ¥ï¼Œè¬›è©±æ¯”è¼ƒè¡ã€‚',
            'å¤©åŒ': 'ä½ å€‹æ€§éš¨å’Œã€å–„è‰¯ï¼Œæ˜¯å¤§å®¶çš„é–‹å¿ƒæœã€‚æ¯”è¼ƒäº«å—ç”Ÿæ´»ï¼Œä¸å¤ªå–œæ­¡æœ‰å£“åŠ›çš„ç’°å¢ƒã€‚æœ‰æ™‚å€™æœƒè¢«èªªå¤ªæ‡¶æˆ–å¤ªæ…¢ï¼Œä½†ä½ åªæ˜¯æ¯”è¼ƒä½›ç³»ã€‚',
            'å»‰è²': 'ä½ æœ‰é»ç¥ç¥•æ„Ÿï¼Œå¤–è¡¨çœ‹èµ·ä¾†å†·å†·çš„ï¼Œä½†å…§å¿ƒå…¶å¯¦å¾ˆè±å¯Œã€‚åšäº‹èªçœŸè² è²¬ï¼Œæœ‰å®Œç¾ä¸»ç¾©å‚¾å‘ã€‚æ„Ÿæƒ…æ–¹é¢æ¯”è¼ƒè¤‡é›œï¼Œå®¹æ˜“ææ›–æ˜§ã€‚',
            'å¤©åºœ': 'ä½ ç©©é‡å¤§æ–¹ï¼Œå¾ˆæœƒç†è²¡å­˜éŒ¢ï¼Œæœ‰ç®¡å®¶çš„å¤©åˆ†ã€‚åšäº‹æœ‰æ¢æœ‰ç†ï¼Œä¸å–œæ­¡å†’éšªã€‚çµ¦äººä¸€ç¨®å¯é çš„æ„Ÿè¦ºï¼Œæ˜¯å¤§å®¶çœ¼ä¸­çš„å¥½å¥½å…ˆç”Ÿ/å°å§ã€‚',
            'å¤ªé™°': 'ä½ å…§å¿ƒç´°è†©æ•æ„Ÿï¼Œå…·æœ‰è—è¡“å¤©åˆ†ï¼Œå¯©ç¾çœ¼å…‰å¾ˆå¥½ã€‚æ¯”è¼ƒæ³¨é‡æ„Ÿè¦ºå’Œæ°›åœã€‚å¥³å‘½é‡å¤ªé™°é€šå¸¸é•·å¾—ä¸éŒ¯ï¼Œç”·å‘½å‰‡æ˜¯å€‹æ€§æ¯”è¼ƒæº«æŸ”ã€‚',
            'è²ªç‹¼': 'ä½ å¤šæ‰å¤šè—ã€äº¤éš›æ‰‹è…•ä¸€æµï¼Œä»€éº¼å ´åˆéƒ½èƒ½æ‡‰ä»˜ã€‚èˆˆè¶£å»£æ³›ä½†æœ‰æ™‚å€™ä¸å¤ å°ˆæ³¨ã€‚æ¡ƒèŠ±é‹ä¹Ÿæ¯”è¼ƒæ—ºï¼Œäººç”Ÿå¤šå½©å¤šå§¿ã€‚',
            'å·¨é–€': 'ä½ å¾ˆæœƒèªªè©±ä¹Ÿå¾ˆæœƒè³ªç–‘ï¼Œåˆ†æèƒ½åŠ›å¼·ã€‚é©åˆç•¶å¾‹å¸«ã€è€å¸«ã€è©•è«–å®¶ã€‚ç¼ºé»æ˜¯æœ‰æ™‚å€™å¤ªæ„›æŒ‘æ¯›ç—…ï¼Œäººéš›é—œä¿‚å®¹æ˜“æœ‰å£èˆŒæ˜¯éã€‚',
            'å¤©ç›¸': 'ä½ å¾…äººå’Œå–„ï¼Œå¾ˆæ“…é•·å”èª¿å’Œæœå‹™åˆ¥äººã€‚æ˜¯åœ˜éšŠè£¡çš„æ½¤æ»‘åŠ‘ï¼Œå¤§å®¶éƒ½å–œæ­¡ä½ ã€‚ä¸éæœ‰æ™‚å€™å¤ªåœ¨ä¹åˆ¥äººçœ‹æ³•ï¼Œå®¹æ˜“å¤±å»è‡ªæˆ‘ã€‚',
            'å¤©æ¢': 'ä½ æœ‰é•·è€…é¢¨ç¯„ï¼Œå–œæ­¡ç…§é¡§äººã€ç®¡æ•™äººã€‚æ­£ç¾©æ„Ÿå¼·ï¼Œé‡åˆ°ä¸å…¬çš„äº‹æƒ…æœƒæƒ³å‡ºæ‰‹ã€‚æœ‰é€¢å…‡åŒ–å‰çš„é«”è³ªï¼Œé‹æ°£åœ¨å±æ€¥æ™‚åˆ»ç‰¹åˆ¥å¥½ã€‚',
            'ä¸ƒæ®º': 'ä½ æœ‰å¼·çƒˆçš„ä¼åœ–å¿ƒå’Œè¡Œå‹•åŠ›ï¼Œä¸æ€•å›°é›£ï¼Œè¶ŠæŒ«è¶Šå‹‡ã€‚åšäº‹æœæ–·ï¼Œæœ‰é–‹å‰µç²¾ç¥ã€‚ç¼ºé»æ˜¯æœ‰æ™‚å€™è¡å‹•ï¼Œä¸ç•™é¤˜åœ°ã€‚',
            'ç ´è»': 'ä½ å–œæ­¡æ‰“ç ´å¸¸è¦ã€è¿½æ±‚è®ŠåŒ–ï¼Œæ˜¯å¤©ç”Ÿçš„æ”¹é©è€…ã€‚äººç”Ÿèµ·ä¼æ¯”è¼ƒå¤§ï¼Œä¸æ˜¯å¤§å¥½å°±æ˜¯å¤§å£ã€‚é©åˆåœ¨è®Šå‹•çš„ç’°å¢ƒä¸­ç™¼æ®ã€‚',
        };

        const STAR_CAREER = {
            'ç´«å¾®': 'é©åˆç•¶ä¸»ç®¡æˆ–è€é—†ï¼Œç®¡ç†éšå±¤æ˜¯ä½ çš„èˆå°',
            'å¤©æ©Ÿ': 'é©åˆé¡§å•ã€ç­–åŠƒã€ç§‘æŠ€ç›¸é—œå·¥ä½œï¼Œéœ€è¦å‹•è…¦çš„é ˜åŸŸ',
            'å¤ªé™½': 'é©åˆå…¬é—œã€æ•™è‚²ã€æ”¿æ²»ç­‰éœ€è¦æ‹‹é ­éœ²é¢çš„å·¥ä½œ',
            'æ­¦æ›²': 'é©åˆé‡‘èã€æ¥­å‹™é–‹ç™¼ã€è»è­¦ï¼Œè·Ÿæ•¸å­—å’Œè¡Œå‹•åŠ›æœ‰é—œ',
            'å¤©åŒ': 'é©åˆç¤¾å·¥ã€å¿ƒç†è«®å•†ã€æœå‹™æ¥­ï¼Œéœ€è¦è€å¿ƒå’ŒåŒç†å¿ƒçš„å·¥ä½œ',
            'å»‰è²': 'é©åˆæ³•å¾‹ã€å…¬å‹™é«”ç³»ã€ç¨½æ ¸ï¼Œç´°å¿ƒåš´è¬¹çš„å·¥ä½œ',
            'å¤©åºœ': 'é©åˆè²¡å‹™ã€è¡Œæ”¿ç®¡ç†ã€æˆ¿åœ°ç”¢ï¼Œç©©å®šå¯é çš„é ˜åŸŸ',
            'å¤ªé™°': 'é©åˆè¨­è¨ˆã€è—è¡“å‰µä½œã€æˆ¿åœ°ç”¢ï¼Œè·Ÿç¾å’Œæ„Ÿè¦ºæœ‰é—œ',
            'è²ªç‹¼': 'é©åˆæ¼”è—ã€è¡ŒéŠ·ã€é¤é£²å¨›æ¨‚ï¼Œéœ€è¦äººéš›æ‰‹è…•çš„è¡Œæ¥­',
            'å·¨é–€': 'é©åˆå¾‹å¸«ã€æ•™å¸«ã€å‚³åª’ã€æ¥­å‹™å£æ‰ç›¸é—œå·¥ä½œ',
            'å¤©ç›¸': 'é©åˆç§˜æ›¸ã€äººè³‡ã€å…¬é—œï¼Œå”èª¿æœå‹™å‹çš„è·ä½',
            'å¤©æ¢': 'é©åˆé†«ç”Ÿã€è€å¸«ã€ä¿éšªã€å®—æ•™ï¼Œç…§é¡§å’Œä¿è­·ç›¸é—œ',
            'ä¸ƒæ®º': 'é©åˆå‰µæ¥­ã€è»äº‹ã€é‹å‹•ã€å†’éšªå‹å·¥ä½œ',
            'ç ´è»': 'é©åˆé–‹æ‹“æ–°äº‹æ¥­ã€è‡ªç”±æ¥­ã€å‰µæ–°é ˜åŸŸ',
        };

        // å‰¯æ˜Ÿ/è¼”æ˜Ÿè§£èªª
        const MINOR_STAR_EXPLAIN = {
            'å·¦è¼”': { good: 'æœ‰è²´äººç›¸åŠ©ï¼Œåšäº‹å®¹æ˜“é‡åˆ°å¥½å¹«æ‰‹', bad: '', resolve: '' },
            'å³å¼¼': { good: 'äººç·£å¥½ï¼Œå®¹æ˜“å¾—åˆ°ä»–äººæ”¯æŒå’Œå”åŠ©', bad: '', resolve: '' },
            'æ–‡æ˜Œ': { good: 'æ–‡æ‰å¥½ï¼Œè€ƒé‹ä½³ï¼Œå­¸æ¥­é †åˆ©ï¼Œé©åˆæ–‡æ›¸ç›¸é—œå·¥ä½œ', bad: '', resolve: '' },
            'æ–‡æ›²': { good: 'è—è¡“å¤©åˆ†é«˜ï¼Œå£æ‰å¥½ï¼Œå…·æœ‰è¡¨æ¼”æ‰èƒ½', bad: 'åŒ–å¿Œæ™‚å®¹æ˜“æœ‰æ–‡æ›¸å·®éŒ¯ã€åˆç´„ç³¾ç´›', resolve: 'é‡è¦æ–‡ä»¶å¤šæª¢æŸ¥å¹¾éï¼Œåˆç´„æ‰¾å°ˆæ¥­äººå£«å¯©é–±' },
            'å¤©é­': { good: 'æœ‰ã€Œæ—¥è²´äººã€ï¼Œåœ¨ç™½å¤©æˆ–é™½æ€§å ´åˆå®¹æ˜“é‡åˆ°è²´äºº', bad: '', resolve: '' },
            'å¤©é‰': { good: 'æœ‰ã€Œå¤œè²´äººã€ï¼Œæš—ä¸­æœ‰äººå¹«å¿™ï¼Œé€¢å‡¶åŒ–å‰', bad: '', resolve: '' },
            'ç¥¿å­˜': { good: 'è²¡é‹ç©©å®šï¼Œæœ‰å­˜éŒ¢çš„èƒ½åŠ›ï¼Œæ˜¯å¤©ç”Ÿçš„ç†è²¡é«˜æ‰‹', bad: 'ä½†ç¥¿å­˜å‰å¾Œå¿…æœ‰æ“ç¾Šå’Œé™€ç¾…ï¼Œå®¹æ˜“æœ‰é˜»ç¤™', resolve: 'ç©©ç´®ç©©æ‰“ï¼Œä¸è¦æ±‚å¿«' },
            'å¤©é¦¬': { good: 'æœ‰å‹•æ…‹çš„æ©Ÿç·£ï¼Œé©åˆå‡ºå·®ã€è²¿æ˜“ã€è·‘å¤–å‹™', bad: 'åä¸ä½ï¼Œå®¹æ˜“æ¬å®¶æˆ–æ›å·¥ä½œ', resolve: 'æŠŠä¸å®‰å®šè½‰åŒ–ç‚ºè¡Œå‹•åŠ›' },
            'æ“ç¾Š': { good: 'åšäº‹æœ‰è¡å‹å’Œé­„åŠ›', bad: 'å®¹æ˜“è¡å‹•ã€è·Ÿäººèµ·è¡çªã€æ„å¤–å—å‚·ã€å®˜å¸ç³¾ç´›', resolve: 'åšäº‹å‰ä¸‰æ€ï¼Œæ§åˆ¶è„¾æ°£ï¼Œæ³¨æ„äº¤é€šå®‰å…¨ï¼Œæ³•å¾‹äº‹å‹™è¦è¬¹æ…' },
            'é™€ç¾…': { good: 'åšäº‹æœ‰éŸŒæ€§ã€ä¸æ”¾æ£„', bad: 'äº‹æƒ…å®¹æ˜“æ‹–å»¶ã€ç³¾çºã€åè¦†ï¼Œäººéš›æ˜“æœ‰å°äºº', resolve: 'è¨­å®šæ˜ç¢ºæ™‚é–“è¡¨ï¼Œæœæ–·è™•ç†æ‹–å»¶çš„äº‹ï¼Œé é›¢æ˜¯éä¹‹äºº' },
            'ç«æ˜Ÿ': { good: 'è¡Œå‹•åŠ›çˆ†è¡¨ï¼Œåšäº‹è¿…é€Ÿ', bad: 'è„¾æ°£æš´èºã€å®¹æ˜“æš´èµ·æš´è½ã€æ„å¤–äº‹æ•…', resolve: 'å­¸æœƒæ·±å‘¼å¸ï¼Œä¸‰æ€è€Œå¾Œè¡Œï¼Œè²·å¥½ä¿éšª' },
            'éˆ´æ˜Ÿ': { good: 'æœ‰ç‰¹æ®Šæ‰è¯ï¼Œå±æ©Ÿè™•ç†èƒ½åŠ›å¼·', bad: 'å®¹æ˜“æ‚¶æ‚¶ä¸æ¨‚ã€çˆ†ç™¼æ™‚å¾ˆå¯æ€•ã€æ…¢æ€§å•é¡Œç´¯ç©', resolve: 'å®šæœŸé‡‹æ”¾å£“åŠ›ï¼Œæ‰¾åˆ°æƒ…ç·’å‡ºå£ï¼Œæ³¨æ„æ…¢æ€§ç—…' },
            'åœ°ç©º': { good: 'æƒ³æ³•å¤©é¦¬è¡Œç©ºï¼Œå‰µæ„èƒ½åŠ›å¼·ï¼Œé©åˆè—è¡“å®—æ•™', bad: 'å®¹æ˜“ç©ºæƒ³ä¸å¯¦éš›ã€éŒ¢è²¡ç•™ä¸ä½ã€æŠ•è³‡è¸©é›·', resolve: 'è…³è¸å¯¦åœ°ï¼ŒæŠ•è³‡ä¿å®ˆç‚ºä¸»ï¼ŒæŠŠå‰µæ„è½‰åŒ–ç‚ºå¯¦éš›ç”¢å‡º' },
            'åœ°åŠ«': { good: 'çœ‹äº‹æƒ…é€šé€ï¼Œæ‚Ÿæ€§é«˜', bad: 'å®¹æ˜“çªç„¶æå¤±ã€æªæ‰‹ä¸åŠçš„è®Šæ•…ã€è²¡ç‰©è¢«åŠ«', resolve: 'æå‰åšå¥½é¢¨éšªç®¡ç†ï¼Œé‡è¦äº‹å‹™ç•™Plan Bï¼ŒéŒ¢ä¸éœ²ç™½' },
            'å¤©ç©º': { good: 'æ€æƒ³è¶…è„«ï¼Œé©åˆå­¸è¡“æˆ–å“²å­¸ç ”ç©¶', bad: 'å®¹æ˜“æƒ³å¤ªå¤šåšå¤ªå°‘ã€ç¾å¯¦æ„Ÿè–„å¼±', resolve: 'æ¯å¤©çµ¦è‡ªå·±è¨­å®šå…·é«”å°ç›®æ¨™' },
            'å¤©åˆ‘': { good: 'é©åˆæ³•å¾‹ã€è»è­¦ã€é†«ç™‚ç­‰åš´è¬¹è¡Œæ¥­', bad: 'å®¹æ˜“æ¶‰åŠå®˜å¸ã€åˆ‘äº‹ç³¾ç´›ã€è·å ´è¡çª', resolve: 'å®ˆæ³•å®ˆè¦çŸ©ï¼Œå·¥ä½œä¸Šç•™æ›¸é¢ç´€éŒ„' },
            'å¤©å§š': { good: 'æ¡ƒèŠ±æ—ºã€ç•°æ€§ç·£å¥½ã€äººè¦‹äººæ„›', bad: 'å®¹æ˜“æœ‰çˆ›æ¡ƒèŠ±ã€æ„Ÿæƒ…ç³¾ç´›', resolve: 'æ„Ÿæƒ…äº‹ä¿æŒç†æ€§ï¼Œé¿å…æš§æ˜§ä¸æ¸…' },
            'ç´…é¸': { good: 'æ­£æ¡ƒèŠ±ã€çµå©šé‹ã€å–œäº‹è¿‘', bad: '', resolve: '' },
            'å¤©å–œ': { good: 'æœ‰å–œæ…¶ä¹‹äº‹ã€å¿ƒæƒ…æ„‰å¿«', bad: '', resolve: '' },
            'è¯è“‹': { good: 'æœ‰è—è¡“å¤©åˆ†ã€å®—æ•™ç·£åˆ†ã€é©åˆç¨è™•å‰µä½œ', bad: 'å®¹æ˜“å­¤ç¨æ„Ÿã€ä¸è¢«ç†è§£', resolve: 'æ‰¾åˆ°å¿—åŒé“åˆçš„åœˆå­' },
            'å’¸æ± ': { good: 'æ¡ƒèŠ±æ—ºç››ã€æœ‰å¸å¼•åŠ›', bad: 'å®¹æ˜“æœ‰æ¡ƒè‰²æ˜¯é', resolve: 'æ„Ÿæƒ…ä¸Šä¿æŒåˆ†å¯¸' },
            'å¤©å“­': { good: 'æ„Ÿå—åŠ›å¼·ã€æœ‰åŒç†å¿ƒ', bad: 'å®¹æ˜“å‚·å¿ƒè½æ·šã€æ†‚é¬±', resolve: 'åŸ¹é¤Šæ­£é¢æ€è€ƒç¿’æ…£ï¼Œå¤šæ¥è§¸å¤§è‡ªç„¶' },
            'å¤©è™›': { good: 'æœ‰è™›åæˆ–è™›æ¦®çš„æ©Ÿæœƒ', bad: 'å®¹æ˜“æœ‰ä¸å¯¦éš›çš„æœŸæœ›ã€è¢«æ¬ºé¨™', resolve: 'å‡¡äº‹å¤šæ±‚è­‰ï¼Œä¸è¦åªçœ‹è¡¨é¢' },
            'å­¤è¾°': { good: 'ç¨ç«‹è‡ªä¸»ã€ä¸ä¾è³´ä»–äºº', bad: 'å®¹æ˜“æ„Ÿåˆ°å­¤å–®å¯‚å¯', resolve: 'ä¸»å‹•ç¶“ç‡Ÿäººéš›é—œä¿‚' },
            'å¯¡å®¿': { good: 'è€å¾—ä½å¯‚å¯ï¼Œé©åˆç ”ç©¶å‹å·¥ä½œ', bad: 'å®¹æ˜“ç¨ä¾†ç¨å¾€ã€æ™šå©š', resolve: 'å¤šåƒåŠ ç¤¾äº¤æ´»å‹•' },
        };

        // äº®åº¦å½±éŸ¿
        const BRIGHTNESS_EFFECT = {
            'å»Ÿ': 'äº®åº¦æœ€é«˜ï¼Œåœ¨é€™å€‹ä½ç½®ç™¼æ®æœ€å¤§å„ªå‹¢ï¼Œå‰ä¸ŠåŠ å‰',
            'æ—º': 'èƒ½é‡å¾ˆå¼·ï¼Œå¹¾ä¹èƒ½å®Œå…¨ç™¼æ®é€™é¡†æ˜Ÿçš„å¥½è™•',
            'å¾—': 'ç®—ä¸éŒ¯ï¼Œèƒ½ç™¼æ®å¤§éƒ¨åˆ†å„ªé»',
            'åˆ©': 'æ™®é€šåå¥½ï¼Œå‰å‡¶åƒåŠ',
            'å¹³': 'è¡¨ç¾ä¸­ç­‰ï¼Œå¥½å£éƒ½ä¸æ˜é¡¯',
            'ä¸': 'æ¯”è¼ƒå¼±å‹¢ï¼Œå„ªé»æ‰“æŠ˜',
            'é™·': 'äº®åº¦æœ€ä½ï¼Œå®¹æ˜“ç™¼æ®ç¼ºé»è€Œéå„ªé»ï¼Œè¦ç‰¹åˆ¥æ³¨æ„',
        };

        // é€šç”¨ï¼šåˆ†æä¸€å€‹å®®ä½çš„å®Œæ•´è³‡è¨Šï¼ˆå‰¯æ˜Ÿ+ç…æ˜Ÿ+å››åŒ–+äº®åº¦ï¼‰
        function getFullPalaceAnalysis(palace) {
            if (!palace) return '';
            let text = '';
            const minors = (palace.minorStars || []).filter(s => s.name);
            const adjs = (palace.adjectiveStars || []).filter(s => s.name);
            const allMinors = [...minors, ...adjs];

            // å‰¯æ˜Ÿèˆ‡ç…æ˜Ÿåˆ†æ
            const goodStars = [], badStars = [];
            allMinors.forEach(s => {
                const info = MINOR_STAR_EXPLAIN[s.name];
                if (info) {
                    if (info.good) goodStars.push({ name: s.name, ...info, mutagen: s.mutagen });
                    if (info.bad) badStars.push({ name: s.name, ...info, mutagen: s.mutagen });
                }
            });

            if (goodStars.length) {
                text += '<br><br>âœ¨ <strong>å‰æ˜ŸåŠ æŒï¼š</strong>';
                goodStars.forEach(s => {
                    text += `<br>â€¢ <strong>${s.name}</strong>ï¼š${s.good}`;
                });
            }
            if (badStars.length) {
                text += '<br><br>âš ï¸ <strong>éœ€è¦æ³¨æ„çš„æ˜Ÿæ›œï¼š</strong>';
                badStars.forEach(s => {
                    text += `<br>â€¢ <strong>${s.name}</strong>ï¼š${s.bad}`;
                    if (s.resolve) text += `<br>ã€€â†’ ğŸ’¡åŒ–è§£æ–¹å¼ï¼š${s.resolve}`;
                });
            }

            // äº®åº¦åˆ†æ
            const majorsWithBright = (palace.majorStars || []).filter(s => s.name && s.brightness);
            if (majorsWithBright.length) {
                text += '<br><br>ğŸ”† <strong>äº®åº¦åˆ†æï¼š</strong>';
                majorsWithBright.forEach(s => {
                    const effect = BRIGHTNESS_EFFECT[s.brightness] || '';
                    text += `<br>â€¢ ${s.name}ï¼ˆ${s.brightness}ï¼‰ï¼š${effect}`;
                });
            }

            return text;
        }

        function getPersonalityExplain(stars, palace) {
            if (stars.length === 0) return 'é€™å€‹å‘½å®®æ²’æœ‰ä¸»æ˜Ÿåé®ï¼Œè¡¨ç¤ºä½ çš„å€‹æ€§æ¯”è¼ƒå—åˆ°å°å®®ï¼ˆé·ç§»å®®ï¼‰çš„å½±éŸ¿ï¼Œå»ºè­°åƒè€ƒé·ç§»å®®çš„ä¸»æ˜Ÿã€‚é€™ç¨®å‘½æ ¼çš„äººé€šå¸¸æ¯”è¼ƒéˆæ´»å¤šè®Šï¼Œé©æ‡‰åŠ›å¼·ã€‚';
            let text = stars.map(s => `<strong>${s}</strong>ï¼š${STAR_PERSONALITY[s] || 'æ­¤æ˜Ÿåœ¨å‘½å®®ï¼Œè³¦äºˆä½ ç¨ç‰¹çš„å€‹æ€§ç‰¹è³ªã€‚'}`).join('<br><br>');
            // æª¢æŸ¥å››åŒ–
            const huaStars = (palace.majorStars || []).filter(s => s.mutagen);
            if (huaStars.length) {
                text += '<br><br>âš¡ <strong>å››åŒ–åŠ æŒï¼š</strong>';
                huaStars.forEach(s => {
                    if (s.mutagen === 'ç¥¿') text += `<br>â€¢ ${s.name}åŒ–ç¥¿ â€” é€™æ–¹é¢çš„é‹å‹¢ç‰¹åˆ¥é †é‚ï¼Œæ˜¯è€å¤©çµ¦ä½ çš„ç¦®ç‰©ã€‚å¯èƒ½æœƒæœ‰æ„å¤–çš„å¥½é‹æ°£æˆ–è²´äººå‡ºç¾ã€‚`;
                    if (s.mutagen === 'æ¬Š') text += `<br>â€¢ ${s.name}åŒ–æ¬Š â€” åšäº‹æœ‰ä¸»å°æ¬Šï¼Œæœ‰å¾ˆå¼·çš„æŒæ§æ¬²ã€‚<br>ã€€âš ï¸ å¯èƒ½ç™¼ç”Ÿï¼šå¤ªå¼·å‹¢å°è‡´äººéš›æ‘©æ“¦<br>ã€€ğŸ’¡ åŒ–è§£ï¼šé©ç•¶æ”¾æ‰‹ï¼Œå‚¾è½ä»–äººæ„è¦‹`;
                    if (s.mutagen === 'ç§‘') text += `<br>â€¢ ${s.name}åŒ–ç§‘ â€” æœ‰è²´äººç·£ï¼Œå­¸æ±è¥¿å¿«ï¼Œå®¹æ˜“å‡ºåã€è¢«çœ‹è¦‹ã€‚è€ƒè©¦é‹å’Œå­¸æ¥­é‹éƒ½ä¸éŒ¯ã€‚`;
                    if (s.mutagen === 'å¿Œ') text += `<br>â€¢ ${s.name}åŒ–å¿Œ â€” é€™æ–¹é¢å®¹æ˜“å¡é—œæˆ–éåº¦åŸ·è‘—ã€‚<br>ã€€âš ï¸ å¯èƒ½ç™¼ç”Ÿï¼šæŒ«æŠ˜æ„Ÿé‡ã€é‘½ç‰›è§’å°–ã€åŒä¸€ä»¶äº‹åè¦†é‡é˜»<br>ã€€ğŸ’¡ åŒ–è§£ï¼šå­¸æœƒæ”¾ä¸‹ï¼Œå…ˆè™•ç†å¥½è‡ªå·±çš„å¿ƒæ…‹ï¼Œé‡é˜»è½‰å½ä¸ç¡¬ç¢°`;
                });
            }
            // åŠ å…¥å®Œæ•´å‰¯æ˜Ÿ/ç…æ˜Ÿ/äº®åº¦åˆ†æ
            text += getFullPalaceAnalysis(palace);
            return text;
        }

        function getCareerExplain(stars, palace) {
            if (stars.length === 0) return 'å®˜ç¥¿å®®æ²’æœ‰ä¸»æ˜Ÿï¼Œä½ çš„äº‹æ¥­æ©Ÿæœƒæ¯”è¼ƒå¤šå…ƒï¼Œå¯èƒ½æœƒå¾äº‹ä¸åªä¸€ç¨®è¡Œæ¥­ï¼Œæˆ–è€…å—å¤§ç’°å¢ƒå½±éŸ¿è¼ƒå¤§ã€‚å»ºè­°æ‰¾åˆ°è‡ªå·±çš„èˆˆè¶£å†æ·±è€•ã€‚' + getFullPalaceAnalysis(palace);
            let text = stars.map(s => `<strong>${s}</strong>ï¼š${STAR_CAREER[s] || 'åœ¨äº‹æ¥­æ–¹é¢æœƒå¸¶ä¾†ç¨ç‰¹çš„è¡¨ç¾ã€‚'}`).join('<br><br>');
            // å››åŒ–å°äº‹æ¥­çš„å½±éŸ¿
            const huaStars = (palace.majorStars || []).filter(s => s.mutagen);
            if (huaStars.length) {
                text += '<br><br>âš¡ <strong>äº‹æ¥­å››åŒ–å½±éŸ¿ï¼š</strong>';
                huaStars.forEach(s => {
                    if (s.mutagen === 'ç¥¿') text += `<br>â€¢ ${s.name}åŒ–ç¥¿åœ¨å®˜ç¥¿å®® â€” äº‹æ¥­é‹æ¥µä½³ï¼Œå®¹æ˜“å¾—åˆ°å‡é·ã€åŠ è–ªï¼Œå·¥ä½œä¸Šæœ‰è²´äººã€‚`;
                    if (s.mutagen === 'æ¬Š') text += `<br>â€¢ ${s.name}åŒ–æ¬Šåœ¨å®˜ç¥¿å®® â€” äº‹æ¥­ä¸Šæœ‰æŒæ¬Šæ©Ÿæœƒï¼Œé©åˆç•¶ä¸»ç®¡ã€‚<br>ã€€âš ï¸ å¯èƒ½ç™¼ç”Ÿï¼šè·å ´æ¬ŠåŠ›é¬¥çˆ­<br>ã€€ğŸ’¡ åŒ–è§£ï¼šä»¥å¾·æœäººï¼Œå°‘æ¨¹æ•µ`;
                    if (s.mutagen === 'ç§‘') text += `<br>â€¢ ${s.name}åŒ–ç§‘åœ¨å®˜ç¥¿å®® â€” å°ˆæ¥­èƒ½åŠ›è¢«è‚¯å®šï¼Œé©åˆèµ°æŠ€è¡“è·¯ç·šæˆ–å­¸è¡“è·¯ç·šã€‚`;
                    if (s.mutagen === 'å¿Œ') text += `<br>â€¢ ${s.name}åŒ–å¿Œåœ¨å®˜ç¥¿å®® â€” äº‹æ¥­ä¸Šå®¹æ˜“è²»åŠ›ä¸è¨å¥½ã€‚<br>ã€€âš ï¸ å¯èƒ½ç™¼ç”Ÿï¼šå·¥ä½œå£“åŠ›å¤§ã€è·å ´æ˜¯éã€é¸éŒ¯è¡Œæ¥­ã€å‡é·å—é˜»<br>ã€€ğŸ’¡ åŒ–è§£ï¼šåšå¥½æœ¬åˆ†ä¸æ±‚è¡¨ç¾ï¼Œé¸å°ç”¢æ¥­æ¯”åŠªåŠ›æ›´é‡è¦ï¼Œè€ƒæ…®è½‰æ›è·‘é“`;
                });
            }
            text += getFullPalaceAnalysis(palace);
            return text;
        }

        function getWealthExplain(stars, palace) {
            if (stars.length === 0) return 'è²¡å¸›å®®æ²’æœ‰ä¸»æ˜Ÿï¼Œä¸ä»£è¡¨æ²’æœ‰éŒ¢ï¼åªæ˜¯è³ºéŒ¢çš„æ–¹å¼æ¯”è¼ƒä¸å›ºå®šï¼Œå¯èƒ½éœ€è¦é å¤šå…ƒæ”¶å…¥æˆ–å‰¯æ¥­ã€‚' + getFullPalaceAnalysis(palace);
            const explains = { 'ç´«å¾®': 'ä½ çš„è²¡é‹æ ¼å±€å¤§ï¼Œé©åˆåšå¤§äº‹æ¥­è³ºå¤§éŒ¢ï¼Œå°æ‰“å°é¬§ä½ æ²’èˆˆè¶£', 'å¤©æ©Ÿ': 'ä½ é è…¦è¢‹è³ºéŒ¢ï¼Œé©åˆæŠ•è³‡ç†è²¡ã€é¡§å•è«®è©¢ç­‰æ™ºæ…§å‹æ”¶å…¥', 'å¤ªé™½': 'ä½ çš„éŒ¢ä¾†å¾—å¤§æ–¹å»å¾—ä¹Ÿå¤§æ–¹ï¼Œä¸å¤ªæœƒå­˜éŒ¢ï¼Œä½†æ”¶å…¥ä¾†æºå»£', 'æ­¦æ›²': 'è²¡æ˜Ÿå…¥è²¡å¸›å®®ï¼Œé€™æ˜¯è²¡é‹å¾ˆå¥½çš„æ ¼å±€ï¼ä½ å¾ˆæœƒè³ºéŒ¢ä¹Ÿæœƒç†è²¡', 'å¤©åŒ': 'ä½ å°éŒ¢æ¯”è¼ƒéš¨ç·£ï¼Œä¸æœƒç‰¹åˆ¥å»è¿½é€è²¡å¯Œï¼Œä½†åŸºæœ¬ç”Ÿæ´»ä¸æˆå•é¡Œ', 'å»‰è²': 'ä½ è³ºéŒ¢çš„æ–¹å¼å¯èƒ½æ¯”è¼ƒè¤‡é›œï¼Œæœƒæ¶‰åŠå¤šç¨®æ”¶å…¥ä¾†æº', 'å¤©åºœ': 'ä½ å¾ˆæœƒå­˜éŒ¢ç†è²¡ï¼Œè²¡é‹ç©©å®šï¼Œé©åˆé•·æœŸæŠ•è³‡ä¸é©åˆæŠ•æ©Ÿ', 'å¤ªé™°': 'ä½ çš„è²¡é‹è·Ÿæˆ¿åœ°ç”¢ã€å¥³æ€§å¸‚å ´æœ‰é—œï¼Œé©åˆç©©æ‰ç©©æ‰“åœ°ç´¯ç©', 'è²ªç‹¼': 'ä½ çš„è²¡é‹è·Ÿäººéš›æœ‰é—œï¼Œæœƒé€éç¤¾äº¤å’Œæ‡‰é…¬å¸¶ä¾†è²¡æº', 'å·¨é–€': 'ä½ é å£æ‰å’Œå°ˆæ¥­çŸ¥è­˜è³ºéŒ¢ï¼Œé©åˆæ•™å­¸ã€è«®è©¢ã€ä»£è¨€', 'å¤©ç›¸': 'ä½ çš„è²¡é‹ä¸­ç­‰ç©©å®šï¼Œé©åˆè–ªæ°´æ—æˆ–æ­é…ä»–äººä¸€èµ·è³ºéŒ¢', 'å¤©æ¢': 'ä½ è·Ÿä¿éšªã€æ…ˆå–„ã€é†«ç™‚ç›¸é—œçš„è²¡é‹æ¯”è¼ƒå¥½', 'ä¸ƒæ®º': 'ä½ æ•¢è¡æ•¢æ‹¼ï¼Œå¯èƒ½å¤§è³ºå¤§è³ ï¼Œå»ºè­°æ§åˆ¶é¢¨éšª', 'ç ´è»': 'ä½ çš„è²¡é‹èµ·ä¼å¤§ï¼Œé©åˆåœ¨æ–°é ˜åŸŸé–‹æ‹“é€²å–' };
            let text = stars.map(s => `<strong>${s}</strong>ï¼š${explains[s] || 'åœ¨è²¡é‹æ–¹é¢å¸¶ä¾†ç‰¹æ®Šå½±éŸ¿ã€‚'}`).join('<br><br>');
            const huaStars = (palace.majorStars || []).filter(s => s.mutagen);
            if (huaStars.length) {
                text += '<br><br>âš¡ <strong>è²¡é‹å››åŒ–å½±éŸ¿ï¼š</strong>';
                huaStars.forEach(s => {
                    if (s.mutagen === 'ç¥¿') text += `<br>â€¢ ${s.name}åŒ–ç¥¿ â€” è²¡æºå»£é€²ï¼Œä»Šç”Ÿæœ‰ä¸éŒ¯çš„æ­£è²¡é‹ã€‚`;
                    if (s.mutagen === 'æ¬Š') text += `<br>â€¢ ${s.name}åŒ–æ¬Š â€” è³ºéŒ¢æœ‰é­„åŠ›ï¼ŒæŠ•è³‡æ±ºç­–æœæ–·ã€‚`;
                    if (s.mutagen === 'å¿Œ') text += `<br>â€¢ ${s.name}åŒ–å¿Œ â€” å®¹æ˜“ç ´è²¡æˆ–éŒ¢ä¾†äº†åˆèµ°ã€‚<br>ã€€âš ï¸ å¯èƒ½ç™¼ç”Ÿï¼šæŠ•è³‡å¤±åˆ©ã€è¢«å€’å¸³ã€å€ŸéŒ¢ä¸é‚„ã€è¡å‹•æ¶ˆè²»<br>ã€€ğŸ’¡ åŒ–è§£ï¼šé‡å…¥ç‚ºå‡ºï¼Œä¸åšæ“”ä¿äººï¼ŒæŠ•è³‡åªç”¨é–’éŒ¢ï¼Œé¤Šæˆè¨˜å¸³ç¿’æ…£`;
                });
            }
            text += getFullPalaceAnalysis(palace);
            return text;
        }

        function getSpouseExplain(stars, palace) {
            if (stars.length === 0) return 'å¤«å¦»å®®æ²’æœ‰ä¸»æ˜Ÿï¼Œæ„Ÿæƒ…æ–¹é¢å¯èƒ½æ¯”è¼ƒæ™šæ‰ç©©å®šï¼Œæˆ–è€…å¦ä¸€åŠçš„å€‹æ€§æ¯”è¼ƒéš¨å’Œã€ä¸å¼·å‹¢ã€‚' + getFullPalaceAnalysis(palace);
            const explains = { 'ç´«å¾®': 'ä½ çš„å¦ä¸€åŠå¯èƒ½åœ°ä½ä¸ä½æˆ–èƒ½åŠ›å¾ˆå¼·ï¼Œä½†ä¹Ÿå¯èƒ½æ¯”è¼ƒéœ¸é“', 'å¤©æ©Ÿ': 'ä½ è·Ÿå¦ä¸€åŠç›¸è™•åƒæœ‹å‹ï¼Œå¿ƒéˆç›¸é€šå¾ˆé‡è¦ï¼Œä½†ä¹Ÿå®¹æ˜“æƒ³å¤ªå¤š', 'å¤ªé™½': 'ç”·å‘½ä»£è¡¨ä½ æ˜¯å¥½ä¸ˆå¤«ï¼Œå¥³å‘½ä»£è¡¨æœƒé‡åˆ°é™½å…‰å‹çš„å°è±¡', 'æ­¦æ›²': 'æ„Ÿæƒ…ä¸Šæ¯”è¼ƒç›´ä¾†ç›´å»ï¼Œä¸å¤ªæµªæ¼«ä½†å¾ˆå¯¦åœ¨ï¼Œå®¹æ˜“æ™šå©š', 'å¤©åŒ': 'æ„Ÿæƒ…ç”œèœœå’Œè«§ï¼Œå¦ä¸€åŠå€‹æ€§æº«æŸ”é«”è²¼ã€å¾ˆå¥½ç›¸è™•', 'å»‰è²': 'æ„Ÿæƒ…æ¯”è¼ƒè¤‡é›œï¼Œå®¹æ˜“æœ‰æš—æˆ€æˆ–ä¸‰è§’é—œä¿‚çš„ç‹€æ³', 'å¤©åºœ': 'å¦ä¸€åŠå¾ˆç©©é‡å¯é ï¼Œå©šå§»ç”Ÿæ´»å®‰å®šï¼Œæ˜¯æŒå®¶å‹çš„', 'å¤ªé™°': 'å¦ä¸€åŠæº«æŸ”ç´°è†©æœ‰æ°£è³ªï¼Œä½†æœ‰æ™‚å¤ªæ•æ„Ÿéœ€è¦å¤šå“„', 'è²ªç‹¼': 'æ¡ƒèŠ±æ¯”è¼ƒæ—ºï¼Œæ„Ÿæƒ…ç¶“æ­·è±å¯Œï¼Œå¦ä¸€åŠå¯èƒ½å¾ˆæœ‰é­…åŠ›', 'å·¨é–€': 'è·Ÿå¦ä¸€åŠå®¹æ˜“å› ç‚ºæºé€šç”¢ç”Ÿæ‘©æ“¦ï¼Œå­¸æœƒå¥½å¥½èªªè©±å¾ˆé‡è¦', 'å¤©ç›¸': 'å¦ä¸€åŠå–„è‰¯é«”è²¼ï¼Œä½†å¯èƒ½å¤ªä¾è³´ä½ æˆ–å¤ªè½è©±', 'å¤©æ¢': 'å¯èƒ½æœƒé‡åˆ°å¹´ç´€å·®è·è¼ƒå¤§çš„å°è±¡æˆ–æ˜¯å¾ˆç…§é¡§ä½ çš„äºº', 'ä¸ƒæ®º': 'æ„Ÿæƒ…æ¯”è¼ƒè½Ÿè½Ÿçƒˆçƒˆï¼Œå¦ä¸€åŠå€‹æ€§å¼·ã€æœ‰ä¸»è¦‹', 'ç ´è»': 'æ„Ÿæƒ…èµ·ä¼å¤§ï¼Œå¯èƒ½ç¶“æ­·å¤šæ¬¡åˆ†åˆæ‰æ‰¾åˆ°å°çš„äºº' };
            let text = stars.map(s => `<strong>${s}</strong>ï¼š${explains[s] || 'åœ¨æ„Ÿæƒ…æ–¹é¢å¸¶ä¾†ç‰¹æ®Šå½±éŸ¿ã€‚'}`).join('<br><br>');
            const huaStars = (palace.majorStars || []).filter(s => s.mutagen);
            if (huaStars.length) {
                text += '<br><br>âš¡ <strong>æ„Ÿæƒ…å››åŒ–å½±éŸ¿ï¼š</strong>';
                huaStars.forEach(s => {
                    if (s.mutagen === 'ç¥¿') text += `<br>â€¢ ${s.name}åŒ–ç¥¿ â€” æ¡ƒèŠ±é‹å¥½ï¼Œæ„Ÿæƒ…ç”Ÿæ´»ç¾æ»¿ï¼Œå¦ä¸€åŠå°ä½ ä¸éŒ¯ã€‚`;
                    if (s.mutagen === 'æ¬Š') text += `<br>â€¢ ${s.name}åŒ–æ¬Š â€” æ„Ÿæƒ…ä¸­ä½ æˆ–å¦ä¸€åŠæŒæ§æ¬²è¼ƒå¼·ã€‚<br>ã€€âš ï¸ å¯èƒ½ç™¼ç”Ÿï¼šé›™æ–¹çˆ­ä¸»å°æ¬Šã€å€‹æ€§è¡çª<br>ã€€ğŸ’¡ åŒ–è§£ï¼šå­¸æœƒå¦¥å”ï¼Œæ‰¾åˆ°å¹³è¡¡é»`;
                    if (s.mutagen === 'å¿Œ') text += `<br>â€¢ ${s.name}åŒ–å¿Œ â€” æ„Ÿæƒ…å®¹æ˜“æœ‰æ³¢æŠ˜ã€‚<br>ã€€âš ï¸ å¯èƒ½ç™¼ç”Ÿï¼šæºé€šä¸è‰¯ã€å†·æˆ°ã€ç¬¬ä¸‰è€…ä»‹å…¥ã€åˆ†åˆ†åˆåˆ<br>ã€€ğŸ’¡ åŒ–è§£ï¼šå¤šæºé€šè¡¨é”æ„Ÿå—ï¼Œç¶“ç‡Ÿæ„Ÿæƒ…ä¸èƒ½åªé æ„Ÿè¦ºï¼Œå¿…è¦æ™‚å°‹æ±‚å°ˆæ¥­è«®å•†`;
                });
            }
            text += getFullPalaceAnalysis(palace);
            return text;
        }

        function getFortuneExplain(stars, palace) {
            if (stars.length === 0) return 'ç¦å¾·å®®æ²’æœ‰ä¸»æ˜Ÿè¡¨ç¤ºä½ çš„å…§å¿ƒæ¯”è¼ƒå®¹æ˜“å—ç’°å¢ƒå½±éŸ¿ï¼Œæœ‰æ™‚å€™æœƒè¦ºå¾—ç©ºè™›æˆ–æ‰¾ä¸åˆ°æ–¹å‘ï¼Œå»ºè­°åŸ¹é¤Šèˆˆè¶£æ„›å¥½ä¾†å……å¯¦è‡ªå·±ã€‚' + getFullPalaceAnalysis(palace);
            const explains = { 'ç´«å¾®': 'ä½ çš„ç²¾ç¥ä¸–ç•Œè±å¯Œï¼Œæœ‰å“å‘³æœ‰è¿½æ±‚ï¼Œä½†æœ‰æ™‚æœƒè¦ºå¾—é«˜è™•ä¸å‹å¯’', 'å¤©æ©Ÿ': 'ä½ å–œæ­¡æ€è€ƒäººç”Ÿå“²å­¸ï¼Œè…¦è¢‹åœä¸ä¸‹ä¾†ï¼Œå®¹æ˜“å¤±çœ æƒ³å¤ªå¤š', 'å¤ªé™½': 'ä½ æ˜¯å€‹æ¨‚è§€é–‹æœ—çš„äººï¼Œä½†å®¹æ˜“æ“å¿ƒå¤ªå¤šï¼Œå»ºè­°å­¸æœƒæ”¾é¬†', 'æ­¦æ›²': 'ä½ åšäº‹è¬›æ•ˆç‡ï¼Œä¸å–œæ­¡æµªè²»æ™‚é–“ï¼Œç”Ÿæ´»æ¯”è¼ƒè¦å¾‹ä½†æœ‰æ™‚å¤ªåš´è‚…', 'å¤©åŒ': 'ä½ å¾ˆæœƒäº«å—ç”Ÿæ´»ï¼ŒçŸ¥è¶³å¸¸æ¨‚ï¼Œæ˜¯æœ‹å‹åœˆè£¡çš„å¿«æ¨‚æ³‰æº', 'å»‰è²': 'ä½ å¤–å†·å…§ç†±ï¼Œå…§å¿ƒæˆ²å¾ˆå¤šï¼Œæœ‰æ™‚å€™æœƒé‘½ç‰›è§’å°–', 'å¤©åºœ': 'ä½ å¿ƒæ…‹ç©©å®šã€çŸ¥è¶³ï¼Œæ™šå¹´é‹å‹¢å¥½ï¼Œæ˜¯æœ‰ç¦æ°£çš„äºº', 'å¤ªé™°': 'ä½ æ„Ÿæ€§ç´°è†©ï¼Œå®¹æ˜“å—åˆ°ç¾çš„äº‹ç‰©æ„Ÿå‹•ï¼Œæœ‰è—è¡“æ¶µé¤Š', 'è²ªç‹¼': 'ä½ èˆˆè¶£å»£æ³›ã€å¥½åƒå¥½ç©ï¼Œäººç”Ÿå¤šå§¿å¤šå½©', 'å·¨é–€': 'ä½ æ€æ…®æ¯”è¼ƒå¤šï¼Œå®¹æ˜“æ“”å¿ƒç…©æƒ±ï¼Œå»ºè­°å¤šè·Ÿäººäº¤æµ', 'å¤©ç›¸': 'ä½ å¿ƒæ…‹å¹³å’Œæº«é †ï¼Œä¸å¤ªæœƒè·Ÿäººèµ·è¡çª', 'å¤©æ¢': 'ä½ æœ‰é•·è€…æ™ºæ…§ï¼Œçœ‹äº‹æƒ…çœ‹å¾—æ¯”è¼ƒé–‹ï¼Œæ™šå¹´æ¸…é–’æœ‰ç¦', 'ä¸ƒæ®º': 'ä½ å…§å¿ƒæœ‰è‚¡è¡å‹ï¼Œé–’ä¸ä¸‹ä¾†ï¼Œå–œæ­¡æŒ‘æˆ°è‡ªæˆ‘', 'ç ´è»': 'ä½ è¿½æ±‚åˆºæ¿€å’Œè®ŠåŒ–ï¼Œç”Ÿæ´»ä¸æœƒç„¡èŠä½†æœ‰æ™‚å€™å¤ªæŠ˜é¨°è‡ªå·±' };
            let text = stars.map(s => `<strong>${s}</strong>ï¼š${explains[s] || 'åœ¨ç²¾ç¥å±¤é¢å¸¶ä¾†ç‰¹æ®Šå½±éŸ¿ã€‚'}`).join('<br><br>');
            text += getFullPalaceAnalysis(palace);
            return text;
        }

        function getHealthExplain(stars, palace) {
            if (stars.length === 0) return 'ç–¾å„å®®æ²’æœ‰ä¸»æ˜Ÿï¼Œèº«é«”ç‹€æ³é€šå¸¸æ¯”è¼ƒå¹³ç©©ï¼Œä½†é‚„æ˜¯è¦æ³¨æ„åŸºæœ¬çš„ä½œæ¯å’Œé£²é£Ÿã€‚' + getFullPalaceAnalysis(palace);
            const explains = { 'ç´«å¾®': 'æ•´é«”å¥åº·ä¸éŒ¯ï¼Œä½†è¦æ³¨æ„è…¸èƒƒå’Œè„¾è‡Ÿæ–¹é¢çš„å•é¡Œ', 'å¤©æ©Ÿ': 'è‚è†½æ–¹é¢è¦æ³¨æ„ï¼Œä¹Ÿå®¹æ˜“æœ‰ç¥ç¶“è¡°å¼±æˆ–å¤±çœ çš„å›°æ“¾', 'å¤ªé™½': 'æ³¨æ„çœ¼ç›å’Œè¡€å£“ï¼Œå®¹æ˜“å› ç‚ºå¤ªæ“å‹è€Œå½±éŸ¿å¿ƒè¡€ç®¡', 'æ­¦æ›²': 'æ³¨æ„è‚ºéƒ¨å’Œå‘¼å¸ç³»çµ±ï¼Œä¹Ÿå®¹æ˜“æœ‰ç­‹éª¨æ–¹é¢çš„å•é¡Œ', 'å¤©åŒ': 'è¦æ³¨æ„è…è‡Ÿå’Œæ³Œå°¿ç³»çµ±ï¼Œä¹Ÿå®¹æ˜“æœ‰æ°´è…«çš„ç‹€æ³', 'å»‰è²': 'æ³¨æ„å¿ƒè‡Ÿè¡€æ¶²æ–¹é¢ï¼Œä¹Ÿå®¹æ˜“æœ‰çš®è†šæ•æ„Ÿçš„å•é¡Œ', 'å¤©åºœ': 'æ¶ˆåŒ–ç³»çµ±æ¯”è¼ƒå¼±ï¼Œå®¹æ˜“è„¹æ°£æˆ–è…¸èƒƒä¸é©', 'å¤ªé™°': 'è…è‡Ÿå’Œå…§åˆ†æ³Œè¦æ³¨æ„ï¼Œå¥³æ€§æœ‹å‹ç‰¹åˆ¥æ³¨æ„å©¦ç§‘', 'è²ªç‹¼': 'è‚è†½æ–¹é¢è¦æ³¨æ„ï¼Œä¹Ÿè¦å°å¿ƒç¸±æ…¾éåº¦å½±éŸ¿å¥åº·', 'å·¨é–€': 'è¦æ³¨æ„å£è…”å’Œçš®è†šï¼Œä¹Ÿå®¹æ˜“å› å£“åŠ›å½±éŸ¿æ¶ˆåŒ–ç³»çµ±', 'å¤©ç›¸': 'æ³¨æ„è…è‡Ÿå’Œçš®è†šï¼Œæ•´é«”ä¾†èªªå¥åº·ç‹€æ³ä¸­ç­‰', 'å¤©æ¢': 'æœ‰é€¢å…‡åŒ–å‰çš„é«”è³ªï¼Œå°ç—…ä¸æ–·ä½†å¤§ç—…ä¸æœƒæœ‰', 'ä¸ƒæ®º': 'è¦æ³¨æ„æ„å¤–å‚·å®³ï¼Œé‹å‹•æ™‚ç‰¹åˆ¥å°å¿ƒï¼Œä¹Ÿè¦æ³¨æ„å‘¼å¸ç³»çµ±', 'ç ´è»': 'èº«é«”èµ·ä¼å¤§ï¼Œå¥åº·å¥½å£å–æ±ºæ–¼ç”Ÿæ´»ç¿’æ…£ï¼Œæ³¨æ„è…è‡Ÿ' };
            let text = stars.map(s => `<strong>${s}</strong>ï¼š${explains[s] || 'å¥åº·æ–¹é¢éœ€è¦å¤šåŠ ç•™æ„ã€‚'}`).join('<br><br>');
            const huaStars = (palace.majorStars || []).filter(s => s.mutagen);
            if (huaStars.length) {
                text += '<br><br>âš¡ <strong>å¥åº·å››åŒ–æé†’ï¼š</strong>';
                huaStars.forEach(s => {
                    if (s.mutagen === 'å¿Œ') text += `<br>â€¢ ${s.name}åŒ–å¿Œåœ¨ç–¾å„å®® â€” èº«é«”è¼ƒå¼±çš„éƒ¨ä½ã€‚<br>ã€€âš ï¸ å¯èƒ½ç™¼ç”Ÿï¼šæ…¢æ€§ç—…ã€åè¦†ç™¼ä½œçš„è€æ¯›ç—…ã€éœ€è¦å‹•æ‰‹è¡“<br>ã€€ğŸ’¡ åŒ–è§£ï¼šå®šæœŸå¥åº·æª¢æŸ¥ï¼Œé¤Šæˆé‹å‹•ç¿’æ…£ï¼Œä¸è¦å¿½è¦–èº«é«”çš„å°è­¦è¨Š`;
                    if (s.mutagen === 'ç¥¿') text += `<br>â€¢ ${s.name}åŒ–ç¥¿ â€” æ•´é«”å¥åº·åº•å­ä¸éŒ¯ï¼Œæ¢å¾©åŠ›å¼·ã€‚`;
                });
            }
            text += getFullPalaceAnalysis(palace);
            return text;
        }

        // å››åŒ–ç¸½è¦½
        function renderHuaSummary(palaces) {
            let huaItems = [];
            palaces.forEach(p => {
                [...(p.majorStars || []), ...(p.minorStars || [])].forEach(s => {
                    if (s.mutagen) huaItems.push({ star: s.name, hua: s.mutagen, palace: p.name });
                });
            });
            if (huaItems.length === 0) return '';
            let html = '<div class="glass explain-card"><h4>ğŸ”„ å››åŒ–åˆ†å¸ƒä¸€è¦½</h4><p>ä½ çš„å‘½ç›¤ä¸­ï¼Œå››åŒ–çš„åˆ†å¸ƒå¦‚ä¸‹ï¼š<br><br>';
            huaItems.forEach(h => {
                const icon = h.hua === 'ç¥¿' ? 'ğŸŸ¢' : h.hua === 'æ¬Š' ? 'ğŸ”´' : h.hua === 'ç§‘' ? 'ğŸ”µ' : 'âš«';
                html += `${icon} <strong>${h.star}</strong> åŒ–<strong>${h.hua}</strong> â†’ è½åœ¨<strong>${h.palace}</strong><br>`;
            });
            html += '<br>åŒ–ç¥¿è½åœ¨å“ªå€‹å®®ä½ï¼Œé‚£å€‹é¢å‘å°±ç‰¹åˆ¥é †åˆ©ï¼›åŒ–å¿Œè½åœ¨å“ªè£¡ï¼Œå°±è¦ç‰¹åˆ¥æ³¨æ„é‚£å€‹é¢å‘çš„å•é¡Œã€‚</p></div>';
            return html;
        }

        // ---------- å¤§é™åˆ†æ ----------
        function renderDecade(astro) {
            const container = document.getElementById('decade-content');
            const palaces = astro.palaces || [];
            let html = '<div class="glass" style="padding:16px;margin-bottom:12px"><h4 style="font-family:var(--font-serif);color:var(--gold);margin-bottom:10px">ğŸ“… ä»€éº¼æ˜¯å¤§é™ï¼Ÿ</h4><p style="font-size:0.82rem;color:var(--text-secondary);line-height:1.7">å¤§é™å°±æ˜¯ä½ äººç”Ÿçš„ã€Œå¤§åŠ‡æœ¬ã€ï¼Œæ¯åå¹´æ›ä¸€å€‹ä¸»é¡Œã€‚æ¯”å¦‚èªª 23~32 æ­²é€™åå¹´çš„é‡å¿ƒå¯èƒ½åœ¨äº‹æ¥­è¡åˆºï¼Œ33~42 æ­²å¯èƒ½è½‰å‘å®¶åº­ã€‚çœ‹å¤§é™å¯ä»¥äº†è§£ä½ æ¯å€‹åå¹´çš„äººç”Ÿé‡é»ã€‚</p></div>';

            palaces.forEach(p => {
                if (p.decpiod || p.ages) {
                    const range = p.ages ? `${p.ages[0]}~${p.ages[p.ages.length - 1]}æ­²` : '';
                    const majorStars = (p.majorStars || []).filter(s => s.name).map(s => s.name).join('ã€');
                    html += `<div class="glass fortune-period">
                <div class="period-title">${p.name} å¤§é™ ${range}</div>
                <div class="period-detail">
                    ä¸»æ˜Ÿï¼š${majorStars || 'ç„¡ä¸»æ˜Ÿ'}
                    ${p.decpiod ? `<br>å¤©å¹²ï¼š${p.heavenlyStemOfPalace || ''}` : ''}
                </div>
            </div>`;
                }
            });

            container.innerHTML = html;
        }

        // ---------- æµå¹´é‹å‹¢ ----------
        function initYearlySelector(astro) {
            const sel = document.getElementById('yearly-select');
            const currentYear = new Date().getFullYear();
            sel.innerHTML = '';
            for (let y = currentYear - 2; y <= currentYear + 5; y++) {
                sel.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}å¹´</option>`;
            }
            renderYearly();
        }

        function renderYearly() {
            const year = parseInt(document.getElementById('yearly-select').value);
            const container = document.getElementById('yearly-content');
            const astro = appState.astrolabe;
            if (!astro) return;

            try {
                // æ­£ç¢ºç”¨æ³•ï¼šhoroscope(dateString, timeIndex)
                let horoscope;
                try {
                    horoscope = astro.horoscope(`${year}-1-1`, 0);
                } catch (err) {
                    console.warn('æµå¹´è¨ˆç®—å¤±æ•—:', err);
                    container.innerHTML = `<div class="glass" style="padding:16px"><p style="color:var(--text-secondary);font-size:0.85rem">ç„¡æ³•è¨ˆç®— ${year} å¹´æµå¹´é‹å‹¢ï¼Œå¯èƒ½æ˜¯æ—¥æœŸè¶…å‡ºç¯„åœã€‚</p></div>`;
                    return;
                }

                if (!horoscope) {
                    throw new Error('ç„¡æ³•å–å¾—æµå¹´è³‡æ–™');
                }

                const y = horoscope.yearly;
                const d = horoscope.decadal;

                let html = `<div class="glass" style="padding:16px;margin-bottom:12px">
                <h4 style="font-family:var(--font-serif);color:var(--gold);margin-bottom:8px">ğŸ‰ ${year}å¹´ æµå¹´é‹å‹¢</h4>
                <p style="font-size:0.82rem;color:var(--text-secondary);line-height:1.7">
                    æµå¹´å°±åƒæ˜¯æ¯ä¸€å¹´çš„ã€Œå¹´åº¦ä¸»é¡Œæ›²ã€ã€‚ä¸åŒå¹´ä»½æœƒå•Ÿå‹•ä½ å‘½ç›¤ä¸­ä¸åŒçš„èƒ½é‡ï¼Œè®“ä½ åœ¨é‚£ä¸€å¹´çš„æŸäº›æ–¹é¢æ¯”è¼ƒé †æˆ–æ¯”è¼ƒéœ€è¦æ³¨æ„ã€‚
                </p>
            </div>`;

                // å¤§é™è³‡è¨Š
                if (d) {
                    html += `<div class="glass fortune-period">
                    <div class="period-title">ğŸ“… æ‰€åœ¨å¤§é™ï¼š${d.heavenlyStem || ''}${d.earthlyBranch || ''}</div>
                    <div class="period-detail">å¤§é™å››åŒ–ï¼š${(d.mutagen || []).join('ã€') || 'ç„¡'}</div>
                    <div class="period-detail">å¤§é™åäºŒå®®æ’åˆ—ï¼š${(d.palaceNames || []).join('â†’') || 'â€”'}</div>
                </div>`;
                }

                // æµå¹´è³‡è¨Š
                if (y) {
                    html += `<div class="glass fortune-period">
                    <div class="period-title">ğŸŒŸ ${year}å¹´ æµå¹´å¹²æ”¯ï¼š${y.heavenlyStem || ''}${y.earthlyBranch || ''}</div>
                    <div class="period-detail">æµå¹´å››åŒ–ï¼š${(y.mutagen || []).join('ã€') || 'ç„¡'}</div>
                    <div class="period-detail">æµå¹´åäºŒå®®æ’åˆ—ï¼š${(y.palaceNames || []).join('â†’') || 'â€”'}</div>
                </div>`;

                    // æµè€€
                    if (y.yearlyDecStar) {
                        const jq = (y.yearlyDecStar.jiangqian12 || []).join('ã€');
                        const sq = (y.yearlyDecStar.suiqian12 || []).join('ã€');
                        if (jq || sq) {
                            html += `<div class="glass fortune-period">
                            <div class="period-title">âœ¨ æµå¹´æ˜Ÿæ›œ</div>
                            ${jq ? `<div class="period-detail">å°‡å‰åäºŒæ˜Ÿï¼š${jq}</div>` : ''}
                            ${sq ? `<div class="period-detail">æ­²å‰åäºŒæ˜Ÿï¼š${sq}</div>` : ''}
                        </div>`;
                        }
                    }
                }

                // æµå¹´å°é™
                if (horoscope.age) {
                    html += `<div class="glass fortune-period">
                    <div class="period-title">ğŸ‚ è™›æ­²ï¼š${horoscope.age.nominalAge || 'â€”'} æ­²</div>
                </div>`;
                }

                html += `<div class="glass explain-card" style="margin-top:12px">
                <p style="font-size:0.82rem;line-height:1.7">
                    ğŸ’¡ <strong>æ€éº¼çœ‹æµå¹´ï¼Ÿ</strong><br>
                    é‡é»çœ‹ã€Œæµå¹´å››åŒ–ã€è½åœ¨å“ªäº›å®®ä½ã€‚åŒ–ç¥¿ä»£è¡¨æœ‰åˆ©ã€åŒ–æ¬Šä»£è¡¨æŒæ§åŠ›å¼·ã€åŒ–ç§‘ä»£è¡¨è²´äººé‹ã€åŒ–å¿Œä»£è¡¨é˜»ç¤™ã€‚ä¾‹å¦‚åŒ–ç¥¿è½åœ¨è²¡å¸›å®®å°±è¡¨ç¤ºä»Šå¹´è²¡é‹ä¸éŒ¯ã€‚
                </p>
            </div>`;

                container.innerHTML = html;
            } catch (e) {
                console.error('æµå¹´åˆ†æéŒ¯èª¤:', e);
                container.innerHTML = `<div class="glass" style="padding:16px"><p style="color:var(--text-secondary);font-size:0.85rem">æµå¹´åˆ†æåŠŸèƒ½è¼‰å…¥å¤±æ•—ï¼š${e.message || 'æœªçŸ¥éŒ¯èª¤'}ã€‚è«‹å˜—è©¦å…¶ä»–å¹´ä»½ã€‚</p></div>`;
            }

        }

        // ---------- æµæœˆåˆ†æ ----------
        function initMonthlySelector(astro) {
            const sel = document.getElementById('monthly-year');
            const currentYear = new Date().getFullYear();
            sel.innerHTML = '';
            for (let y = currentYear - 1; y <= currentYear + 2; y++) {
                sel.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}å¹´</option>`;
            }
        }

        function updateMonthlyOptions() { renderMonthly(); }

        function renderMonthly() {
            const year = parseInt(document.getElementById('monthly-year').value);
            const month = parseInt(document.getElementById('monthly-month').value);
            const container = document.getElementById('monthly-content');
            const astro = appState.astrolabe;
            if (!astro) return;

            try {
                // æ­£ç¢ºç”¨æ³•ï¼šhoroscope(dateString, timeIndex)
                const horoscope = astro.horoscope(`${year}-${month}-1`, 0);
                const m = horoscope.monthly;
                const y = horoscope.yearly;

                let html = `<div class="glass" style="padding:16px;margin-bottom:12px">
            <h4 style="font-family:var(--font-serif);color:var(--gold);margin-bottom:8px">ğŸ“† ${year}å¹´${month}æœˆ æµæœˆåˆ†æ</h4>
            <p style="font-size:0.82rem;color:var(--text-secondary);line-height:1.7">
                æµæœˆæ˜¯æŠŠæµå¹´å†ç´°åˆ†åˆ°æ¯å€‹æœˆã€‚å®ƒå¯ä»¥å¹«åŠ©ä½ äº†è§£æ¯å€‹æœˆé©åˆåšä»€éº¼ã€è¦é¿é–‹ä»€éº¼ã€‚å°¤å…¶æ˜¯åšé‡å¤§æ±ºå®šï¼ˆæ›å·¥ä½œã€çµå©šã€æŠ•è³‡ï¼‰æ™‚å¯ä»¥åƒè€ƒã€‚
            </p>
        </div>`;

                // æµå¹´æ¦‚è¦½ï¼ˆä½œç‚ºèƒŒæ™¯ï¼‰
                if (y) {
                    html += `<div class="glass fortune-period">
                    <div class="period-title">ğŸŒŸ ${year}å¹´æµå¹´ï¼š${y.heavenlyStem || ''}${y.earthlyBranch || ''}</div>
                    <div class="period-detail">æµå¹´å››åŒ–ï¼š${(y.mutagen || []).join('ã€') || 'ç„¡'}</div>
                </div>`;
                }

                // æµæœˆè©³æƒ…
                if (m) {
                    html += `<div class="glass fortune-period">
                    <div class="period-title">ğŸ“… ${month}æœˆæµæœˆå¹²æ”¯ï¼š${m.heavenlyStem || ''}${m.earthlyBranch || ''}</div>
                    <div class="period-detail">æµæœˆå››åŒ–ï¼š${(m.mutagen || []).join('ã€') || 'ç„¡'}</div>
                    <div class="period-detail">æµæœˆåäºŒå®®æ’åˆ—ï¼š${(m.palaceNames || []).join('â†’') || 'â€”'}</div>
                </div>`;
                }

                html += `<div class="glass explain-card" style="margin-top:12px">
                <p style="font-size:0.82rem;line-height:1.7">
                    ğŸ’¡ <strong>æ€éº¼çœ‹æµæœˆï¼Ÿ</strong><br>
                    æµæœˆå››åŒ–å°±åƒã€Œæœˆåº¦æç¤ºã€ã€‚çœ‹æµæœˆåŒ–ç¥¿åœ¨å“ªå®®å°±æ˜¯é€™å€‹æœˆçš„æ©Ÿæœƒï¼ŒåŒ–å¿Œåœ¨å“ªå®®å°±è¦ç‰¹åˆ¥æ³¨æ„ã€‚é…åˆæµå¹´ä¸€èµ·çœ‹æ›´æº–ç¢ºã€‚
                </p>
            </div>`;

                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<div class="glass" style="padding:16px"><p style="color:var(--text-secondary);font-size:0.85rem">æµæœˆè³‡è¨Šè¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p></div>';
            }
        }

        // ---------- ä¸‰æ–¹å››æ­£ ----------
        function initRelationsSelector(astro) {
            const sel = document.getElementById('relations-palace');
            const palaces = astro.palaces || [];
            sel.innerHTML = '';
            palaces.forEach((p, i) => {
                sel.innerHTML += `<option value="${i}">${p.name}</option>`;
            });
            renderRelations();
        }

        function renderRelations() {
            const idx = parseInt(document.getElementById('relations-palace').value);
            const container = document.getElementById('relations-content');
            const astro = appState.astrolabe;
            if (!astro) return;

            const palaces = astro.palaces || [];
            const palace = palaces[idx];
            if (!palace) return;

            // ä¸‰æ–¹å››æ­£ï¼šæœ¬å®® + å°å®® + ä¸‰åˆå®®ï¼ˆå‰4å¾Œ4çš„ä½ç½®ï¼‰
            const total = palaces.length;
            const oppositeIdx = (idx + 6) % total;
            const triIdx1 = (idx + 4) % total;
            const triIdx2 = (idx + 8) % total;

            const opposite = palaces[oppositeIdx];
            const tri1 = palaces[triIdx1];
            const tri2 = palaces[triIdx2];

            const getStarNames = p => (p.majorStars || []).filter(s => s.name).map(s => {
                let n = `<strong>${s.name}</strong>`;
                if (s.mutagen) n += `<span class="star-hua ${s.mutagen === 'ç¥¿' ? 'hua-lu' : s.mutagen === 'æ¬Š' ? 'hua-quan' : s.mutagen === 'ç§‘' ? 'hua-ke' : 'hua-ji'}">${s.mutagen}</span>`;
                return n;
            }).join('ã€') || 'ç„¡ä¸»æ˜Ÿ';

            let html = `<div class="glass" style="padding:16px;margin-bottom:12px">
        <h4 style="font-family:var(--font-serif);color:var(--gold);margin-bottom:8px">ğŸ”º ä»€éº¼æ˜¯ä¸‰æ–¹å››æ­£ï¼Ÿ</h4>
        <p style="font-size:0.82rem;color:var(--text-secondary);line-height:1.7">
            ä¸‰æ–¹å››æ­£æ˜¯ç´«å¾®æ–—æ•¸çš„é€²éšçœ‹æ³•ã€‚ç°¡å–®èªªå°±æ˜¯çœ‹ä¸€å€‹å®®ä½ä¸èƒ½åªçœ‹å®ƒè‡ªå·±ï¼Œé‚„è¦çœ‹å®ƒã€Œå‰å¾Œå·¦å³ã€çš„é„°å±…ã€‚å°±åƒè©•ä¼°ä¸€é–“æˆ¿å­ï¼Œé™¤äº†çœ‹æˆ¿å­æœ¬èº«ï¼Œé‚„è¦çœ‹å‘¨åœçš„ç’°å¢ƒä¸€æ¨£ã€‚
        </p>
    </div>`;

            html += `<div class="glass fortune-period">
        <div class="period-title">ğŸ“ æœ¬å®®ï¼š${palace.name}</div>
        <div class="period-detail">ä¸»æ˜Ÿï¼š${getStarNames(palace)}</div>
    </div>`;

            html += `<div class="glass fortune-period">
        <div class="period-title">ğŸª å°å®®ï¼š${opposite.name}</div>
        <div class="period-detail">ä¸»æ˜Ÿï¼š${getStarNames(opposite)}<br>
        <span style="font-size:0.78rem;color:var(--text-secondary)">å°å®®çš„èƒ½é‡æœƒã€Œç…§å°„ã€éä¾†å½±éŸ¿æœ¬å®®ï¼Œå°¤å…¶æœ¬å®®æ²’æœ‰ä¸»æ˜Ÿæ™‚å½±éŸ¿æ›´å¤§ã€‚</span></div>
    </div>`;

            html += `<div class="glass fortune-period">
        <div class="period-title">ğŸ”» ä¸‰åˆå®®ï¼š${tri1.name}</div>
        <div class="period-detail">ä¸»æ˜Ÿï¼š${getStarNames(tri1)}</div>
    </div>`;

            html += `<div class="glass fortune-period">
        <div class="period-title">ğŸ”» ä¸‰åˆå®®ï¼š${tri2.name}</div>
        <div class="period-detail">ä¸»æ˜Ÿï¼š${getStarNames(tri2)}</div>
    </div>`;

            html += `<div class="glass explain-card" style="margin-top:12px">
        <p style="font-size:0.82rem;line-height:1.7">
            ğŸ’¡ <strong>æ€éº¼çœ‹ï¼Ÿ</strong><br>
            æŠŠæœ¬å®®ã€å°å®®å’Œå…©å€‹ä¸‰åˆå®®çš„æ˜Ÿæ›œå…¨éƒ¨æ”¾åœ¨ä¸€èµ·çœ‹ã€‚å¦‚æœå‰æ˜Ÿï¼ˆç¥¿ã€æ¬Šã€ç§‘ï¼‰å¤šï¼Œé‚£é€™å€‹å®®ä½ä»£è¡¨çš„äººç”Ÿé¢å‘å°±æ¯”è¼ƒé †åˆ©ã€‚
            å¦‚æœç…æ˜Ÿæˆ–å¿Œæ˜Ÿå¤šï¼Œå°±è¡¨ç¤ºé€™æ–¹é¢éœ€è¦å¤šè²»å¿ƒæ€ã€‚ä¸éä¹Ÿä¸ç”¨å¤ªæ“”å¿ƒï¼Œå‘½ç›¤æ˜¯æé†’ä½ ã€ŒçŸ¥é“æœƒæœ‰è€ƒé©—ï¼Œå°±èƒ½æå‰æº–å‚™ã€ã€‚
        </p>
    </div>`;

            container.innerHTML = html;
        }

        // ---------- å®®ä½è©³æƒ… Modal ----------
        function showPalaceDetail(idx) {
            const astro = appState.astrolabe;
            if (!astro) return;
            const palace = astro.palaces[idx];
            if (!palace) return;

            const modal = document.getElementById('palace-modal');
            const body = document.getElementById('palace-modal-body');

            const majorStars = (palace.majorStars || []).filter(s => s.name);
            const minorStars = (palace.minorStars || []).filter(s => s.name);
            const adjStars = (palace.adjectiveStars || []).filter(s => s.name);

            let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <h3 style="font-family:var(--font-serif);font-size:1.2rem;color:var(--gold)">${palace.name}</h3>
        <button onclick="closePalaceModal()" style="background:rgba(255,255,255,0.1);border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.1rem">âœ•</button>
    </div>`;

            html += `<div style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:16px">
        å¤©å¹²åœ°æ”¯ï¼š${palace.heavenlyStemOfPalace || ''}${palace.earthlyBranchOfPalace || ''}
    </div>`;

            if (majorStars.length) {
                html += '<div style="margin-bottom:14px"><div style="font-size:0.8rem;color:var(--purple-light);font-weight:700;margin-bottom:8px">â­ ä¸»æ˜Ÿ</div>';
                majorStars.forEach(s => {
                    html += `<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.06)">
                <span style="color:#ff9f43;font-weight:700">${s.name}</span>
                ${s.brightness ? `<span style="font-size:0.75rem;color:var(--text-secondary)">${s.brightness}</span>` : ''}
                ${s.mutagen ? `<span class="star-hua ${s.mutagen === 'ç¥¿' ? 'hua-lu' : s.mutagen === 'æ¬Š' ? 'hua-quan' : s.mutagen === 'ç§‘' ? 'hua-ke' : 'hua-ji'}" style="font-size:0.8rem">åŒ–${s.mutagen}</span>` : ''}
            </div>`;
                    // åŠ å…¥å£èªè§£èªª
                    if (STAR_PERSONALITY[s.name]) {
                        html += `<div style="font-size:0.78rem;color:var(--text-secondary);padding:6px 0;line-height:1.6">${STAR_PERSONALITY[s.name]}</div>`;
                    }
                });
                html += '</div>';
            }

            if (minorStars.length) {
                html += '<div style="margin-bottom:14px"><div style="font-size:0.8rem;color:#74b9ff;font-weight:700;margin-bottom:8px">âœ¦ å‰¯æ˜Ÿ</div>';
                minorStars.forEach(s => {
                    html += `<div style="display:flex;align-items:center;gap:8px;padding:4px 0">
                <span style="color:#74b9ff">${s.name}</span>
                ${s.mutagen ? `<span class="star-hua ${s.mutagen === 'ç¥¿' ? 'hua-lu' : s.mutagen === 'æ¬Š' ? 'hua-quan' : s.mutagen === 'ç§‘' ? 'hua-ke' : 'hua-ji'}">${s.mutagen}</span>` : ''}
            </div>`;
                });
                html += '</div>';
            }

            if (adjStars.length) {
                html += '<div><div style="font-size:0.8rem;color:var(--text-secondary);font-weight:700;margin-bottom:8px">â—‡ é›œæ›œ</div>';
                html += `<div style="display:flex;flex-wrap:wrap;gap:6px">`;
                adjStars.forEach(s => {
                    html += `<span style="font-size:0.75rem;padding:4px 8px;background:rgba(255,255,255,0.06);border-radius:6px">${s.name}</span>`;
                });
                html += '</div></div>';
            }

            body.innerHTML = html;
            modal.classList.add('show');
        }

        function closePalaceModal() {
            document.getElementById('palace-modal').classList.remove('show');
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰
        document.getElementById('palace-modal').addEventListener('click', function (e) {
            if (e.target === this) closePalaceModal();
        });

        // ============================================================
        // æ­·å²ç´€éŒ„ï¼ˆlocalStorageï¼‰
        // ============================================================
        function loadHistory() {
            try {
                appState.history = JSON.parse(localStorage.getItem('zwds_history') || '[]');
            } catch (e) { appState.history = []; }
            renderHistory();
        }

        function saveChart() {
            if (!appState.birthData) { showToast('æ²’æœ‰å¯å„²å­˜çš„å‘½ç›¤'); return; }
            const record = {
                id: 'c_' + Date.now(),
                birthData: { ...appState.birthData },
                createdAt: new Date().toISOString(),
                label: `${appState.birthData.date} ${HOUR_NAMES[appState.birthData.hour]} ${appState.birthData.gender}å‘½`
            };
            appState.history.unshift(record);
            if (appState.history.length > 50) appState.history = appState.history.slice(0, 50);
            localStorage.setItem('zwds_history', JSON.stringify(appState.history));

            // è‹¥æœ‰å¾Œç«¯å°±ä¹Ÿå„²å­˜ä¸€ä»½
            saveToServer(record);

            showToast('å·²å„²å­˜åˆ°æ­·å²ç´€éŒ„ï¼');
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if (appState.history.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:30px 0">å°šç„¡ç´€éŒ„ï¼Œå¿«å»æ’ç›¤å§ ğŸ”®</p>';
                return;
            }
            list.innerHTML = appState.history.map(h => `
        <div class="glass history-item" onclick="reloadChart('${h.id}')">
            <div class="history-meta">
                <div class="name">${h.label}</div>
                <div class="date">${new Date(h.createdAt).toLocaleDateString('zh-TW')}</div>
            </div>
            <button class="history-delete" onclick="event.stopPropagation();deleteHistory('${h.id}')">
                <i data-lucide="trash-2" style="width:16px;height:16px"></i>
            </button>
        </div>
    `).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function reloadChart(id) {
            const record = appState.history.find(h => h.id === id);
            if (!record) return;
            const bd = record.birthData;
            document.getElementById('birth-date').value = bd.date;
            document.getElementById('birth-hour').value = bd.hour;
            document.getElementById('birth-gender').value = bd.gender;
            if (bd.isLunar !== appState.isLunar) toggleCalendar();
            if (bd.isLeap) document.getElementById('is-leap-month').checked = true;
            generateChart();
        }

        function deleteHistory(id) {
            appState.history = appState.history.filter(h => h.id !== id);
            localStorage.setItem('zwds_history', JSON.stringify(appState.history));
            renderHistory();
            showToast('å·²åˆªé™¤');
        }

        // ============================================================
        // å¾Œç«¯ API é€šè¨Šï¼ˆVercel Serverlessï¼‰
        // ============================================================
        async function saveToServer(record) {
            if (!API_BASE || !appState.user.userId) return;
            try {
                await fetch(`${API_BASE}/api/charts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: appState.user.userId, ...record })
                });
            } catch (e) { console.warn('å„²å­˜åˆ°ä¼ºæœå™¨å¤±æ•—', e); }
        }

        async function loadFromServer() {
            if (!API_BASE || !appState.user.userId) return;
            try {
                const res = await fetch(`${API_BASE}/api/charts?userId=${appState.user.userId}`);
                const data = await res.json();
                if (Array.isArray(data) && data.length) {
                    // åˆä½µä¼ºæœå™¨èˆ‡æœ¬æ©Ÿç´€éŒ„
                    const localIds = new Set(appState.history.map(h => h.id));
                    data.forEach(d => { if (!localIds.has(d.id)) appState.history.push(d); });
                    appState.history.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    localStorage.setItem('zwds_history', JSON.stringify(appState.history));
                    renderHistory();
                }
            } catch (e) { console.warn('å¾ä¼ºæœå™¨è®€å–å¤±æ•—', e); }
        }

        async function saveUserToServer() {
            if (!API_BASE || !appState.user.userId) return;
            try {
                await fetch(`${API_BASE}/api/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appState.user)
                });
            } catch (e) { console.warn('å„²å­˜ä½¿ç”¨è€…è³‡æ–™å¤±æ•—', e); }
        }

        // ============================================================
        // åˆå§‹åŒ–
        // ============================================================
        window.onload = async function () {
            initStarCanvas();
            loadHistory();

            // LIFF åˆå§‹åŒ–
            if (LIFF_ID && LIFF_ID !== 'YOUR_LIFF_ID') {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }
                    const profile = await liff.getProfile();
                    appState.user = {
                        userId: profile.userId,
                        displayName: profile.displayName,
                        pictureUrl: profile.pictureUrl || ''
                    };
                } catch (e) {
                    console.error('LIFF åˆå§‹åŒ–å¤±æ•—', e);
                }
            }

            // æ›´æ–°ä½¿ç”¨è€…ä»‹é¢
            const nameDisp = document.getElementById('user-name-display');
            const avatarEl = document.getElementById('user-avatar');
            if (appState.user.displayName && appState.user.displayName !== 'è¨ªå®¢') {
                nameDisp.textContent = appState.user.displayName;
            }
            if (appState.user.pictureUrl) {
                avatarEl.src = appState.user.pictureUrl;
                avatarEl.classList.remove('hidden');
            }

            // è®€å–ä¼ºæœå™¨è³‡æ–™
            await loadFromServer();
            saveUserToServer();

            // åˆå§‹åŒ–åœ–ç¤º
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // ç§»é™¤ Loading
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 600);
            }
        };
    </script>
</body>

</html>