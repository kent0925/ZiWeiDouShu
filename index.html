<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç´«å¾®æ–—æ•¸ â”€ å‘½ç†æ’ç›¤</title>
    <meta name="description" content="ç´«å¾®æ–—æ•¸ç·šä¸Šæ’ç›¤ï¼Œè¼¸å…¥å‡ºç”Ÿè³‡æ–™å³å¯ç²å¾—å®Œæ•´å‘½ç›¤åˆ†æèˆ‡å£èªåŒ–è§£èªªã€‚">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iztro/dist/iztro.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0c0a1a;
            --bg-card: rgba(255, 255, 255, 0.06);
            --purple-deep: #2d1b69;
            --purple-mid: #5b3cc4;
            --purple-light: #8b6ce7;
            --gold: #f0c040;
            --gold-soft: #e8d48b;
            --text-primary: #f0eef8;
            --text-secondary: #a8a0c0;
            --glass-border: rgba(255, 255, 255, 0.12);
            --radius: 16px;
            --font-serif: 'Noto Serif TC', serif;
            --font-sans: 'Noto Sans TC', sans-serif;
        }

        html {
            font-size: 15px;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100dvh;
            overflow-x: hidden;
            position: relative;
        }

        /* æ˜Ÿç©ºèƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at 50% 0%, rgba(91, 60, 196, 0.25) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 100%, rgba(45, 27, 105, 0.3) 0%, transparent 50%);
            z-index: 0;
            pointer-events: none;
        }

        #star-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        .app-container {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            padding: 16px;
            min-height: 100dvh;
        }

        /* ç»ç’ƒå¡ç‰‡ */
        .glass {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: var(--radius);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
        }

        /* Loading å‹•ç•« */
        #loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: linear-gradient(135deg, #0c0a1a 0%, #1a1040 50%, #0c0a1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s ease;
        }

        .taiji {
            width: 80px;
            height: 80px;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }

        .animate-fade {
            animation: fadeIn 0.5s ease both;
        }

        /* æŒ‰éˆ• */
        .btn-primary {
            background: linear-gradient(135deg, var(--purple-mid), var(--purple-light));
            color: #fff;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: transform 0.15s, box-shadow 0.3s;
            box-shadow: 0 4px 20px rgba(91, 60, 196, 0.4);
        }

        .btn-primary:active {
            transform: scale(0.97);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.14);
        }

        .btn-gold {
            background: linear-gradient(135deg, #d4a012, #f0c040, #d4a012);
            color: #1a1040;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 20px rgba(240, 192, 64, 0.3);
            transition: transform 0.15s;
        }

        .btn-gold:active {
            transform: scale(0.97);
        }

        /* è¡¨å–® */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: var(--font-sans);
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus {
            border-color: var(--purple-light);
        }

        .form-select option {
            background: #1a1040;
            color: #fff;
        }

        /* åˆ‡æ›é–‹é—œ */
        .toggle-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--purple-mid);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(22px);
        }

        /* é é¢è¦–åœ– */
        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.4s ease both;
        }

        /* Header */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            margin-bottom: 12px;
        }

        .app-header h1 {
            font-family: var(--font-serif);
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gold), var(--gold-soft));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            object-fit: cover;
        }

        /* é¦–é å¡ç‰‡ */
        .home-card {
            padding: 24px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            margin-bottom: 14px;
        }

        .home-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(91, 60, 196, 0.2);
        }

        .home-card .card-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .home-card h3 {
            font-family: var(--font-serif);
            font-size: 1.15rem;
            margin-bottom: 6px;
        }

        .home-card p {
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* å‘½ç›¤ç¶²æ ¼ */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
            margin: 16px 0;
        }

        .palace-cell {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 6px 4px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            font-size: 0.65rem;
            position: relative;
            transition: background 0.2s;
            cursor: pointer;
        }

        .palace-cell:hover {
            background: rgba(139, 108, 231, 0.15);
        }

        .palace-cell.highlight {
            background: rgba(240, 192, 64, 0.12);
            border-color: var(--gold);
        }

        .palace-name {
            text-align: center;
            font-weight: 700;
            font-size: 0.7rem;
            color: var(--gold);
            margin-bottom: 3px;
            font-family: var(--font-serif);
        }

        .palace-stem {
            text-align: center;
            font-size: 0.6rem;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .star-list {
            flex: 1;
        }

        .star-item {
            display: flex;
            align-items: center;
            gap: 2px;
            line-height: 1.4;
        }

        .star-name {
            color: var(--text-primary);
            font-size: 0.62rem;
        }

        .star-name.major {
            color: #ff9f43;
            font-weight: 700;
            font-size: 0.68rem;
        }

        .star-name.minor {
            color: #74b9ff;
        }

        .star-bright {
            font-size: 0.5rem;
            color: var(--text-secondary);
        }

        .star-hua {
            font-size: 0.55rem;
            font-weight: 700;
            padding: 0 2px;
            border-radius: 2px;
        }

        .hua-lu {
            color: #2ed573;
        }

        .hua-quan {
            color: #ff6b6b;
        }

        .hua-ke {
            color: #48dbfb;
        }

        .hua-ji {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.15);
        }

        /* å‘½ç›¤æ‘˜è¦ */
        .chart-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 16px 0;
        }

        .summary-item {
            text-align: center;
            padding: 12px 8px;
        }

        .summary-item .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .summary-item .value {
            font-family: var(--font-serif);
            font-size: 1rem;
            font-weight: 700;
            color: var(--gold);
        }

        /* è§£èªªå€ */
        .explain-section {
            margin: 16px 0;
        }

        .explain-card {
            padding: 16px;
            margin-bottom: 12px;
        }

        .explain-card h4 {
            font-family: var(--font-serif);
            font-size: 0.95rem;
            color: var(--gold);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .explain-card p {
            font-size: 0.85rem;
            line-height: 1.75;
            color: var(--text-secondary);
        }

        .explain-card p strong {
            color: var(--text-primary);
        }

        /* é€²éšåŠŸèƒ½é¸æ“‡ */
        .feature-tabs {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 8px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .feature-tabs::-webkit-scrollbar {
            display: none;
        }

        .feature-tab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            white-space: nowrap;
            cursor: pointer;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid transparent;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .feature-tab.active {
            background: rgba(91, 60, 196, 0.25);
            border-color: var(--purple-light);
            color: var(--text-primary);
        }

        /* æ­·å²ç´€éŒ„ */
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .history-meta {
            flex: 1;
        }

        .history-meta .name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .history-meta .date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .history-delete {
            color: #ff6b6b;
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
        }

        /* Toast */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-60px);
            background: rgba(45, 27, 105, 0.95);
            color: #fff;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 10000;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s;
            opacity: 0;
            pointer-events: none;
        }

        #toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* é‹é™å€åŸŸ */
        .fortune-period {
            padding: 14px 16px;
            margin-bottom: 10px;
        }

        .fortune-period .period-title {
            font-family: var(--font-serif);
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--purple-light);
            margin-bottom: 6px;
        }

        .fortune-period .period-detail {
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* å®®ä½è©³æƒ… Modal */
        #palace-modal {
            position: fixed;
            inset: 0;
            z-index: 500;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(6px);
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        #palace-modal.show {
            display: flex;
        }

        .palace-modal-content {
            background: linear-gradient(180deg, #1a1040, #0c0a1a);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            width: 100%;
            max-width: 480px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px 20px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 380px) {
            .palace-cell {
                min-height: 68px;
                padding: 4px 2px;
            }

            .star-name {
                font-size: 0.58rem;
            }

            .palace-name {
                font-size: 0.65rem;
            }
        }

        /* éš±è— class */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <canvas id="star-canvas"></canvas>
    <div id="toast"></div>

    <!-- Loading -->
    <div id="loading-overlay">
        <svg class="taiji" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="48" fill="none" stroke="rgba(240,192,64,0.3)" stroke-width="2" />
            <path d="M50 2 A48 48 0 0 1 50 98 A24 24 0 0 0 50 50 A24 24 0 0 1 50 2" fill="rgba(240,192,64,0.8)" />
            <path d="M50 98 A48 48 0 0 1 50 2 A24 24 0 0 0 50 50 A24 24 0 0 1 50 98" fill="rgba(139,108,231,0.8)" />
            <circle cx="50" cy="26" r="5" fill="rgba(139,108,231,0.8)" />
            <circle cx="50" cy="74" r="5" fill="rgba(240,192,64,0.8)" />
        </svg>
        <p
            style="margin-top:20px;color:var(--gold);font-family:var(--font-serif);font-size:1.1rem;animation:pulse 1.5s infinite">
            ç´«å¾®æ–—æ•¸</p>
        <p style="margin-top:6px;color:var(--text-secondary);font-size:0.8rem">è¼‰å…¥ä¸­...</p>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div style="display:flex;align-items:center;gap:10px">
                <button id="btn-back" class="hidden" onclick="goBack()"
                    style="background:none;border:none;color:var(--text-primary);cursor:pointer;padding:4px">
                    <i data-lucide="arrow-left" style="width:22px;height:22px"></i>
                </button>
                <h1 id="header-title">ç´«å¾®æ–—æ•¸</h1>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
                <span id="user-name-display" style="font-size:0.8rem;color:var(--text-secondary)"></span>
                <img id="user-avatar" class="user-avatar hidden" src="" alt="é ­åƒ">
            </div>
        </header>

        <!-- ========== é¦–é  ========== -->
        <div id="view-home" class="view active">
            <div style="text-align:center;padding:20px 0 30px">
                <p
                    style="font-family:var(--font-serif);font-size:1.6rem;font-weight:900;background:linear-gradient(135deg,var(--gold),#fff,var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent">
                    è§€æ˜Ÿå•å‘½</p>
                <p style="font-size:0.82rem;color:var(--text-secondary);margin-top:6px">æ¢ç´¢ä½ çš„ç´«å¾®å‘½ç›¤ï¼Œäº†è§£å‘½é‹çš„å¯†ç¢¼</p>
            </div>

            <div class="glass home-card" onclick="showView('view-form')">
                <div class="card-icon">ğŸ”®</div>
                <h3>é–‹å§‹æ’ç›¤</h3>
                <p>è¼¸å…¥å‡ºç”Ÿå¹´æœˆæ—¥èˆ‡æ™‚è¾°ï¼Œç«‹å³ç”¢ç”Ÿå°ˆå±¬ç´«å¾®å‘½ç›¤ï¼ŒåŒ…å«åäºŒå®®ä½ã€ä¸»å‰¯æ˜Ÿæ›œèˆ‡å››åŒ–åˆ†æ</p>
            </div>

            <div class="glass home-card" onclick="showView('view-history')">
                <div class="card-icon">ğŸ“œ</div>
                <h3>æ­·å²ç´€éŒ„</h3>
                <p>æŸ¥çœ‹éå»æ’éçš„å‘½ç›¤ç´€éŒ„ï¼Œéš¨æ™‚å›é¡§åˆ†æ</p>
            </div>

            <div class="glass home-card" onclick="showView('view-about')">
                <div class="card-icon">ğŸ“–</div>
                <h3>é—œæ–¼ç´«å¾®æ–—æ•¸</h3>
                <p>äº†è§£ä»€éº¼æ˜¯ç´«å¾®æ–—æ•¸ã€åäºŒå®®ä½ä»£è¡¨ä»€éº¼ã€å››åŒ–æ€éº¼çœ‹</p>
            </div>
        </div>

        <!-- ========== æ’ç›¤è¡¨å–® ========== -->
        <div id="view-form" class="view">
            <div class="glass" style="padding:24px">
                <h2
                    style="font-family:var(--font-serif);font-size:1.15rem;color:var(--gold);margin-bottom:18px;display:flex;align-items:center;gap:8px">
                    <i data-lucide="sparkles" style="width:20px;height:20px"></i> è¼¸å…¥å‡ºç”Ÿè³‡æ–™
                </h2>

                <div class="form-group">
                    <label class="form-label">æ—¥æ›†é¡å‹</label>
                    <div class="toggle-row">
                        <span style="font-size:0.9rem" id="cal-label">â˜€ï¸ åœ‹æ›†ï¼ˆé™½æ›†ï¼‰</span>
                        <div class="toggle-switch" id="cal-toggle" onclick="toggleCalendar()"></div>
                        <span style="font-size:0.85rem;color:var(--text-secondary)" id="cal-hint">é»æ“Šåˆ‡æ›è¾²æ›†</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="birth-date">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="date" id="birth-date" class="form-input" value="1990-01-01">
                </div>

                <div class="form-group" id="leap-group" style="display:none">
                    <label class="form-label">
                        <input type="checkbox" id="is-leap-month" style="margin-right:6px"> æ˜¯é–æœˆ
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label" for="birth-hour">å‡ºç”Ÿæ™‚è¾°</label>
                    <select id="birth-hour" class="form-select">
                        <option value="0">æ—©å­æ™‚ï¼ˆ00:00~01:00ï¼‰</option>
                        <option value="1">ä¸‘æ™‚ï¼ˆ01:00~03:00ï¼‰</option>
                        <option value="2">å¯…æ™‚ï¼ˆ03:00~05:00ï¼‰</option>
                        <option value="3">å¯æ™‚ï¼ˆ05:00~07:00ï¼‰</option>
                        <option value="4">è¾°æ™‚ï¼ˆ07:00~09:00ï¼‰</option>
                        <option value="5">å·³æ™‚ï¼ˆ09:00~11:00ï¼‰</option>
                        <option value="6">åˆæ™‚ï¼ˆ11:00~13:00ï¼‰</option>
                        <option value="7">æœªæ™‚ï¼ˆ13:00~15:00ï¼‰</option>
                        <option value="8">ç”³æ™‚ï¼ˆ15:00~17:00ï¼‰</option>
                        <option value="9">é…‰æ™‚ï¼ˆ17:00~19:00ï¼‰</option>
                        <option value="10">æˆŒæ™‚ï¼ˆ19:00~21:00ï¼‰</option>
                        <option value="11">äº¥æ™‚ï¼ˆ21:00~23:00ï¼‰</option>
                        <option value="12">æ™šå­æ™‚ï¼ˆ23:00~00:00ï¼‰</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="birth-gender">æ€§åˆ¥</label>
                    <select id="birth-gender" class="form-select">
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                    </select>
                </div>

                <button class="btn-gold" onclick="generateChart()" id="btn-generate">
                    <span style="display:flex;align-items:center;justify-content:center;gap:8px">
                        <i data-lucide="compass" style="width:20px;height:20px"></i> é–‹å§‹æ’ç›¤
                    </span>
                </button>
            </div>
        </div>

        <!-- ========== å‘½ç›¤çµæœ ========== -->
        <div id="view-result" class="view">
            <div id="chart-summary-section" class="glass" style="padding:16px;margin-bottom:14px">
                <h3 style="font-family:var(--font-serif);font-size:1rem;color:var(--gold);margin-bottom:12px;text-align:center"
                    id="result-title">å‘½ç›¤çµæœ</h3>
                <div class="chart-summary" id="chart-summary"></div>
            </div>

            <!-- é€²éšåŠŸèƒ½ Tabs -->
            <div class="feature-tabs" id="feature-tabs">
                <div class="feature-tab active" data-tab="chart" onclick="switchTab('chart')">å‘½ç›¤ç¸½è¦½</div>
                <div class="feature-tab" data-tab="explain" onclick="switchTab('explain')">å£èªè§£èªª</div>
                <div class="feature-tab" data-tab="decade" onclick="switchTab('decade')">å¤§é™åˆ†æ</div>
                <div class="feature-tab" data-tab="yearly" onclick="switchTab('yearly')">æµå¹´é‹å‹¢</div>
                <div class="feature-tab" data-tab="monthly" onclick="switchTab('monthly')">æµæœˆç´°çœ‹</div>
                <div class="feature-tab" data-tab="relations" onclick="switchTab('relations')">ä¸‰æ–¹å››æ­£</div>
            </div>

            <!-- Tab: å‘½ç›¤ -->
            <div id="tab-chart" class="tab-content">
                <div class="chart-grid" id="chart-grid"></div>
            </div>

            <!-- Tab: å£èªè§£èªª -->
            <div id="tab-explain" class="tab-content hidden">
                <div class="explain-section" id="explain-content"></div>
            </div>

            <!-- Tab: å¤§é™ -->
            <div id="tab-decade" class="tab-content hidden">
                <div id="decade-content"></div>
            </div>

            <!-- Tab: æµå¹´ -->
            <div id="tab-yearly" class="tab-content hidden">
                <div class="form-group" style="margin:12px 0">
                    <label class="form-label">é¸æ“‡æµå¹´å¹´ä»½</label>
                    <select id="yearly-select" class="form-select" onchange="renderYearly()"></select>
                </div>
                <div id="yearly-content"></div>
            </div>

            <!-- Tab: æµæœˆ -->
            <div id="tab-monthly" class="tab-content hidden">
                <div style="display:flex;gap:8px;margin:12px 0">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">å¹´ä»½</label>
                        <select id="monthly-year" class="form-select" onchange="updateMonthlyOptions()"></select>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">æœˆä»½</label>
                        <select id="monthly-month" class="form-select" onchange="renderMonthly()">
                            <option value="1">æ­£æœˆ</option>
                            <option value="2">äºŒæœˆ</option>
                            <option value="3">ä¸‰æœˆ</option>
                            <option value="4">å››æœˆ</option>
                            <option value="5">äº”æœˆ</option>
                            <option value="6">å…­æœˆ</option>
                            <option value="7">ä¸ƒæœˆ</option>
                            <option value="8">å…«æœˆ</option>
                            <option value="9">ä¹æœˆ</option>
                            <option value="10">åæœˆ</option>
                            <option value="11">å†¬æœˆ</option>
                            <option value="12">è‡˜æœˆ</option>
                        </select>
                    </div>
                </div>
                <div id="monthly-content"></div>
            </div>

            <!-- Tab: ä¸‰æ–¹å››æ­£ -->
            <div id="tab-relations" class="tab-content hidden">
                <div class="form-group" style="margin:12px 0">
                    <label class="form-label">é¸æ“‡å®®ä½æŸ¥çœ‹ä¸‰æ–¹å››æ­£</label>
                    <select id="relations-palace" class="form-select" onchange="renderRelations()"></select>
                </div>
                <div id="relations-content"></div>
            </div>

            <div style="display:flex;gap:10px;margin-top:16px">
                <button class="btn-secondary" style="flex:1" onclick="saveChart()">
                    <span style="display:flex;align-items:center;justify-content:center;gap:6px">
                        <i data-lucide="save" style="width:16px;height:16px"></i> å„²å­˜ç´€éŒ„
                    </span>
                </button>
                <button class="btn-secondary" style="flex:1" onclick="showView('view-form')">
                    <span style="display:flex;align-items:center;justify-content:center;gap:6px">
                        <i data-lucide="rotate-ccw" style="width:16px;height:16px"></i> é‡æ–°æ’ç›¤
                    </span>
                </button>
            </div>
        </div>

        <!-- ========== æ­·å²ç´€éŒ„ ========== -->
        <div id="view-history" class="view">
            <div class="glass" style="padding:20px">
                <h2
                    style="font-family:var(--font-serif);font-size:1.1rem;color:var(--gold);margin-bottom:14px;display:flex;align-items:center;gap:8px">
                    <i data-lucide="scroll-text" style="width:20px;height:20px"></i> æ­·å²ç´€éŒ„
                </h2>
                <div id="history-list">
                    <p style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:30px 0">å°šç„¡ç´€éŒ„</p>
                </div>
            </div>
        </div>

        <!-- ========== é—œæ–¼ ========== -->
        <div id="view-about" class="view">
            <div class="glass explain-card">
                <h4>ğŸŒŸ ä»€éº¼æ˜¯ç´«å¾®æ–—æ•¸ï¼Ÿ</h4>
                <p>ç°¡å–®ä¾†èªªï¼Œç´«å¾®æ–—æ•¸å°±åƒæ˜¯ä½ å‡ºç”Ÿé‚£ä¸€åˆ»çš„ã€Œæ˜Ÿç©ºå¿«ç…§ã€ã€‚å¤äººè§€å¯Ÿå¤©ä¸Šæ˜Ÿè¾°çš„æ’åˆ—ï¼Œç™¼å±•å‡ºé€™å¥—å‘½ç†ç³»çµ±ã€‚
                    <strong>å®ƒç”¨åäºŒå€‹å®®ä½ä¾†æè¿°ä½ äººç”Ÿçš„å„å€‹é¢å‘</strong>ï¼Œåƒæ˜¯ä½ çš„å€‹æ€§ã€äº‹æ¥­ã€æ„Ÿæƒ…ã€è²¡é‹ç­‰ç­‰ã€‚æ¯å€‹å®®ä½è£¡é¢æœƒæœ‰ä¸åŒçš„æ˜Ÿæ˜Ÿï¼ˆæˆ‘å€‘å«ã€Œæ˜Ÿæ›œã€ï¼‰ï¼Œé€™äº›æ˜Ÿæ˜Ÿçš„çµ„åˆå°±æ±ºå®šäº†é‚£å€‹é¢å‘çš„ç‰¹è³ªã€‚
                </p>
            </div>
            <div class="glass explain-card">
                <h4>ğŸ“ åäºŒå®®ä½æ˜¯ä»€éº¼ï¼Ÿ</h4>
                <p>ä½ å¯ä»¥æŠŠåäºŒå®®æƒ³åƒæˆäººç”Ÿçš„åäºŒå€‹èˆå°ï¼š<br>
                    <strong>å‘½å®®</strong>ï¼ä½ é€™å€‹äººçš„æ ¸å¿ƒå€‹æ€§<br>
                    <strong>å…„å¼Ÿå®®</strong>ï¼è·Ÿå…„å¼Ÿå§å¦¹ã€æœ‹å‹çš„é—œä¿‚<br>
                    <strong>å¤«å¦»å®®</strong>ï¼æ„Ÿæƒ…è·Ÿå©šå§»ç‹€æ³<br>
                    <strong>å­å¥³å®®</strong>ï¼è·Ÿå°å­©çš„ç·£åˆ†ã€æ¡ƒèŠ±<br>
                    <strong>è²¡å¸›å®®</strong>ï¼è³ºéŒ¢çš„æ–¹å¼è·Ÿè²¡é‹<br>
                    <strong>ç–¾å„å®®</strong>ï¼èº«é«”å¥åº·<br>
                    <strong>é·ç§»å®®</strong>ï¼å‡ºå¤–é‹ã€äººéš›é—œä¿‚<br>
                    <strong>äº¤å‹å®®</strong>ï¼æœ‹å‹è·Ÿåˆä½œå¤¥ä¼´<br>
                    <strong>å®˜ç¥¿å®®</strong>ï¼å·¥ä½œè·Ÿäº‹æ¥­<br>
                    <strong>ç”°å®…å®®</strong>ï¼å®¶åº­è·Ÿæˆ¿ç”¢<br>
                    <strong>ç¦å¾·å®®</strong>ï¼ç²¾ç¥å±¤é¢ã€æœ‰æ²’æœ‰ç¦æ°£<br>
                    <strong>çˆ¶æ¯å®®</strong>ï¼è·Ÿé•·è¼©çš„é—œä¿‚ã€è®€æ›¸é‹
                </p>
            </div>
            <div class="glass explain-card">
                <h4>âœ¨ å››åŒ–æ˜¯ä»€éº¼ï¼Ÿ</h4>
                <p>å››åŒ–å°±åƒæ˜¯æ˜Ÿæ˜Ÿè¢«ã€ŒåŠ æŒã€äº†ç‰¹æ®Šèƒ½é‡ï¼š<br>
                    <strong style="color:#2ed573">ç¥¿</strong>ï¼å¥½é‹åŠ å€ã€é †é †åˆ©åˆ©ï¼Œå°±åƒæ‹¿åˆ°å¥½ç‰Œ<br>
                    <strong style="color:#ff6b6b">æ¬Š</strong>ï¼æœ‰æ¬ŠåŠ›ã€æœ‰æŒæ§åŠ›ï¼Œä½†ä¹Ÿæ¯”è¼ƒå¼·å‹¢<br>
                    <strong style="color:#48dbfb">ç§‘</strong>ï¼æœ‰åæ°£ã€æœ‰è²´äººç›¸åŠ©ï¼Œè°æ˜æ‰æ™º<br>
                    <strong style="color:#ff4757">å¿Œ</strong>ï¼å¡é—œã€éœ€è¦ç‰¹åˆ¥æ³¨æ„çš„åœ°æ–¹ï¼Œä½†ä¸ä¸€å®šæ˜¯å£äº‹ï¼Œæœ‰æ™‚å€™æ˜¯å› ç‚ºå¤ªåœ¨ä¹æ‰€ä»¥å®¹æ˜“é‘½ç‰›è§’å°–
                </p>
            </div>
        </div>
    </div>

    <!-- å®®ä½è©³æƒ… Modal -->
    <div id="palace-modal">
        <div class="palace-modal-content" id="palace-modal-body"></div>
    </div>

    <script>
        // ============================================================
        // å…¨åŸŸè¨­å®š
        // ============================================================
        const LIFF_ID = "YOUR_LIFF_ID"; // â† è«‹æ›¿æ›æˆæ‚¨çš„ LIFF ID
        const API_BASE = ""; // â† éƒ¨ç½² Vercel å¾Œå¡«å…¥ï¼Œä¾‹å¦‚ https://your-app.vercel.app

        // ä½¿ç”¨è€…ç‹€æ…‹
        const appState = {
            user: { userId: '', displayName: 'è¨ªå®¢', pictureUrl: '' },
            astrolabe: null,        // iztro ç”¢ç”Ÿçš„æ˜Ÿç›¤ç‰©ä»¶
            birthData: null,        // ç›®å‰æ’ç›¤ç”¨çš„å‡ºç”Ÿè³‡æ–™
            isLunar: false,         // æ˜¯å¦ä½¿ç”¨è¾²æ›†
            history: [],            // æœ¬æ©Ÿæ­·å²ç´€éŒ„
            viewStack: ['view-home']
        };

        // ============================================================
        // æ˜Ÿç©ºèƒŒæ™¯å‹•ç•«
        // ============================================================
        function initStarCanvas() {
            const c = document.getElementById('star-canvas');
            const ctx = c.getContext('2d');
            let stars = [];
            function resize() { c.width = window.innerWidth; c.height = window.innerHeight; }
            resize(); window.addEventListener('resize', resize);
            for (let i = 0; i < 120; i++) {
                stars.push({ x: Math.random() * c.width, y: Math.random() * c.height, r: Math.random() * 1.5 + 0.3, speed: Math.random() * 0.3 + 0.05, opacity: Math.random() });
            }
            function draw() {
                ctx.clearRect(0, 0, c.width, c.height);
                stars.forEach(s => {
                    s.opacity += (Math.random() - 0.5) * 0.02;
                    s.opacity = Math.max(0.1, Math.min(1, s.opacity));
                    s.y -= s.speed; if (s.y < 0) { s.y = c.height; s.x = Math.random() * c.width; }
                    ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(200,190,255,${s.opacity * 0.6})`; ctx.fill();
                });
                requestAnimationFrame(draw);
            }
            draw();
        }

        // ============================================================
        // å·¥å…·å‡½å¼
        // ============================================================
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const back = document.getElementById('btn-back');
            if (id === 'view-home') {
                back.classList.add('hidden');
                appState.viewStack = ['view-home'];
            } else {
                back.classList.remove('hidden');
                if (appState.viewStack[appState.viewStack.length - 1] !== id) appState.viewStack.push(id);
            }
            // æ›´æ–°æ¨™é¡Œ
            const titles = { 'view-home': 'ç´«å¾®æ–—æ•¸', 'view-form': 'æ’ç›¤è¼¸å…¥', 'view-result': 'å‘½ç›¤çµæœ', 'view-history': 'æ­·å²ç´€éŒ„', 'view-about': 'èªè­˜ç´«å¾®æ–—æ•¸' };
            document.getElementById('header-title').textContent = titles[id] || 'ç´«å¾®æ–—æ•¸';
            window.scrollTo(0, 0);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function goBack() {
            appState.viewStack.pop();
            const prev = appState.viewStack[appState.viewStack.length - 1] || 'view-home';
            showView(prev);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.querySelectorAll('.feature-tab').forEach(el => el.classList.toggle('active', el.dataset.tab === tabId));
        }

        function toggleCalendar() {
            appState.isLunar = !appState.isLunar;
            const tog = document.getElementById('cal-toggle');
            const label = document.getElementById('cal-label');
            const hint = document.getElementById('cal-hint');
            const leapGrp = document.getElementById('leap-group');
            tog.classList.toggle('active', appState.isLunar);
            if (appState.isLunar) {
                label.textContent = 'ğŸŒ™ è¾²æ›†'; hint.textContent = 'é»æ“Šåˆ‡æ›åœ‹æ›†';
                leapGrp.style.display = 'block';
            } else {
                label.textContent = 'â˜€ï¸ åœ‹æ›†ï¼ˆé™½æ›†ï¼‰'; hint.textContent = 'é»æ“Šåˆ‡æ›è¾²æ›†';
                leapGrp.style.display = 'none';
            }
        }

        // ============================================================
        // åäºŒæ™‚è¾°åç¨±å°ç…§
        // ============================================================
        const HOUR_NAMES = ['æ—©å­æ™‚', 'ä¸‘æ™‚', 'å¯…æ™‚', 'å¯æ™‚', 'è¾°æ™‚', 'å·³æ™‚', 'åˆæ™‚', 'æœªæ™‚', 'ç”³æ™‚', 'é…‰æ™‚', 'æˆŒæ™‚', 'äº¥æ™‚', 'æ™šå­æ™‚'];

        // ============================================================
        // æ ¸å¿ƒæ’ç›¤
        // ============================================================
        function generateChart() {
            const dateStr = document.getElementById('birth-date').value;
            const hour = parseInt(document.getElementById('birth-hour').value);
            const gender = document.getElementById('birth-gender').value;

            if (!dateStr) { showToast('è«‹å¡«å¯«å‡ºç”Ÿæ—¥æœŸ'); return; }

            try {
                let astrolabe;
                if (appState.isLunar) {
                    // è¾²æ›†æ’ç›¤ï¼šéœ€è¦æŠŠæ—¥æœŸè½‰æˆè¾²æ›†æ ¼å¼
                    const [y, m, d] = dateStr.split('-');
                    const lunarDate = `${y}-${m}-${d}`;
                    const isLeap = document.getElementById('is-leap-month').checked;
                    astrolabe = iztro.astro.byLunar(lunarDate, hour, gender, isLeap, true, 'zh-TW');
                } else {
                    astrolabe = iztro.astro.bySolar(dateStr, hour, gender, true, 'zh-TW');
                }

                appState.astrolabe = astrolabe;
                appState.birthData = { date: dateStr, hour, gender, isLunar: appState.isLunar, isLeap: document.getElementById('is-leap-month').checked };

                renderChartResult();
                showView('view-result');
                showToast('æ’ç›¤å®Œæˆï¼');
            } catch (e) {
                console.error('æ’ç›¤éŒ¯èª¤', e);
                showToast('æ’ç›¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥æœŸæ˜¯å¦æ­£ç¢º');
            }
        }

        // ============================================================
        // æ¸²æŸ“å‘½ç›¤çµæœ
        // ============================================================

        // ç´«å¾®æ–—æ•¸çš„å®®ä½åœ¨æ˜Ÿç›¤ä¸­çš„æ’åˆ—é †åºï¼ˆå¾å·¦ä¸‹è§’é€†æ™‚é‡ï¼‰
        // å‚³çµ±æ’åˆ—ï¼šå·³åˆæœªç”³ / è¾°.é…‰ / å¯.æˆŒ / å¯…ä¸‘å­äº¥
        // å°æ‡‰åˆ° 4x4 grid (row-major)ï¼š
        // [å·³, åˆ, æœª, ç”³]  â†’ row 0
        // [è¾°,       , é…‰]  â†’ row 1
        // [å¯,       , æˆŒ]  â†’ row 2
        // [å¯…, ä¸‘, å­, äº¥]  â†’ row 3
        const GRID_POSITIONS = [
            // [paletIdx, gridRow, gridCol] â€” palaceIdx æ˜¯ iztro palaces é™£åˆ—çš„ç´¢å¼•
            // iztro çš„ palaces é †åºæ˜¯å›ºå®šå¾å‘½å®®é–‹å§‹çš„åäºŒå®®
            // æˆ‘å€‘éœ€è¦æ ¹æ“šåœ°æ”¯ä½ç½®ä¾†æ’åˆ—
        ];

        function renderChartResult() {
            const astro = appState.astrolabe;
            if (!astro) return;

            // 1. æ¸²æŸ“æ‘˜è¦è³‡è¨Š
            renderSummary(astro);

            // 2. æ¸²æŸ“åäºŒå®®ä½å‘½ç›¤
            renderChartGrid(astro);

            // 3. æ¸²æŸ“å£èªåŒ–è§£èªª
            renderExplanation(astro);

            // 4. æ¸²æŸ“å¤§é™
            renderDecade(astro);

            // 5. åˆå§‹åŒ–æµå¹´/æµæœˆé¸æ“‡å™¨
            initYearlySelector(astro);
            initMonthlySelector(astro);

            // 6. åˆå§‹åŒ–ä¸‰æ–¹å››æ­£å®®ä½é¸æ“‡å™¨
            initRelationsSelector(astro);

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // ---------- æ‘˜è¦ ----------
        function renderSummary(astro) {
            const palaces = astro.palaces || [];
            // æ‰¾åˆ°å‘½å®®
            const mingPalace = palaces.find(p => p.name === 'å‘½å®®') || palaces[0];
            // æ‰¾åˆ°èº«å®®
            const shenPalace = palaces.find(p => p.name === 'èº«å®®') || palaces.find(p => {
                // å¾ˆå¤šæƒ…æ³èº«å®®æœƒæ¨™è¨»åœ¨å…¶ä»–å®®ä½ä¸Š
                return p.name && p.name.includes('èº«å®®');
            });

            // å‘½å®®ä¸»æ˜Ÿ
            const mingStars = mingPalace ? (mingPalace.majorStars || []).filter(s => s.name).map(s => s.name).join('ã€') : 'â€”';

            const summary = document.getElementById('chart-summary');
            const dateInfo = appState.birthData;

            summary.innerHTML = `
        <div class="summary-item glass">
            <div class="label">å‘½å®®ä¸»æ˜Ÿ</div>
            <div class="value">${mingStars || 'â€”'}</div>
        </div>
        <div class="summary-item glass">
            <div class="label">äº”è¡Œå±€</div>
            <div class="value">${astro.fiveElementsClass || 'â€”'}</div>
        </div>
        <div class="summary-item glass">
            <div class="label">å‘½ä¸»</div>
            <div class="value">${astro.soul || 'â€”'}</div>
        </div>
        <div class="summary-item glass">
            <div class="label">èº«ä¸»</div>
            <div class="value">${astro.body || 'â€”'}</div>
        </div>
    `;

            document.getElementById('result-title').textContent =
                `${dateInfo.date} ${HOUR_NAMES[dateInfo.hour]} ${dateInfo.gender}å‘½`;
        }

        // ---------- åäºŒå®®æ ¼å‘½ç›¤ ----------
        function renderChartGrid(astro) {
            const palaces = astro.palaces || [];
            const grid = document.getElementById('chart-grid');

            // åœ°æ”¯é †åºèˆ‡ç¶²æ ¼ä½ç½®å°ç…§
            // å‚³çµ±ç´«å¾®æ–—æ•¸ç›¤çš„æ’åˆ—æ–¹å¼ï¼Œä»¥åœ°æ”¯ä½ç½®ç‚ºæº–ï¼š
            const DIZHI_GRID = {
                'å·³': [0, 0], 'åˆ': [0, 1], 'æœª': [0, 2], 'ç”³': [0, 3],
                'è¾°': [1, 0], 'é…‰': [1, 3],
                'å¯': [2, 0], 'æˆŒ': [2, 3],
                'å¯…': [3, 0], 'ä¸‘': [3, 1], 'å­': [3, 2], 'äº¥': [3, 3]
            };

            // å»ºç«‹ 4x4 é™£åˆ—ï¼ˆä¸­é–“4æ ¼ç•™ç©ºï¼‰
            const cells = Array.from({ length: 4 }, () => Array.from({ length: 4 }, () => null));

            palaces.forEach((p, idx) => {
                // å–å¾—å®®ä½çš„åœ°æ”¯
                const earthlyBranch = p.earthlyBranchOfPalace || '';
                const pos = DIZHI_GRID[earthlyBranch];
                if (pos) cells[pos[0]][pos[1]] = { palace: p, idx };
            });

            let html = '';
            for (let r = 0; r < 4; r++) {
                for (let c = 0; c < 4; c++) {
                    const cell = cells[r][c];
                    if (!cell) {
                        // ä¸­é–“å€åŸŸ â€” é¡¯ç¤ºæ ¸å¿ƒè³‡è¨Š
                        if (r === 1 && c === 1) {
                            html += `<div class="palace-cell" style="grid-column:span 2;grid-row:span 2;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(91,60,196,0.08);border-color:rgba(139,108,231,0.2);min-height:160px">
                        <div style="font-family:var(--font-serif);font-size:1rem;color:var(--gold);margin-bottom:6px">ç´«å¾®æ–—æ•¸å‘½ç›¤</div>
                        <div style="font-size:0.72rem;color:var(--text-secondary);line-height:1.6;text-align:center">
                            ${appState.birthData.date}<br>
                            ${HOUR_NAMES[appState.birthData.hour]}<br>
                            ${appState.birthData.gender}å‘½<br>
                            ${astro.fiveElementsClass || ''}
                        </div>
                    </div>`;
                        }
                        // è·³é (1,2) (2,1) (2,2) â€” å·²è¢« span è¦†è“‹
                        continue;
                    }

                    const p = cell.palace;
                    const isMing = p.name === 'å‘½å®®';
                    const majorStars = (p.majorStars || []).filter(s => s.name);
                    const minorStars = (p.minorStars || []).filter(s => s.name);
                    const adjStars = (p.adjectiveStars || []).filter(s => s.name);

                    html += `<div class="palace-cell ${isMing ? 'highlight' : ''}" onclick="showPalaceDetail(${cell.idx})">
                <div class="palace-name">${p.name || ''}</div>
                <div class="palace-stem">${p.heavenlyStemOfPalace || ''}${p.earthlyBranchOfPalace || ''}</div>
                <div class="star-list">`;

                    // ä¸»æ˜Ÿï¼ˆæ©˜è‰²ç²—é«”ï¼‰
                    majorStars.forEach(s => {
                        html += `<div class="star-item"><span class="star-name major">${s.name}</span>`;
                        if (s.brightness) html += `<span class="star-bright">${s.brightness}</span>`;
                        html += renderHuaTag(s);
                        html += `</div>`;
                    });

                    // å‰¯æ˜Ÿï¼ˆè—è‰²ï¼‰â€” åªé¡¯ç¤ºå‰3å€‹é¿å…å¤ªæ“ 
                    minorStars.slice(0, 3).forEach(s => {
                        html += `<div class="star-item"><span class="star-name minor">${s.name}</span>`;
                        html += renderHuaTag(s);
                        html += `</div>`;
                    });

                    html += `</div></div>`;
                }
            }

            grid.innerHTML = html;
        }

        // æ¸²æŸ“å››åŒ–æ¨™è¨˜
        function renderHuaTag(star) {
            if (!star.mutagen) return '';
            const huaMap = { 'ç¥¿': 'hua-lu', 'æ¬Š': 'hua-quan', 'ç§‘': 'hua-ke', 'å¿Œ': 'hua-ji' };
            const cls = huaMap[star.mutagen] || '';
            return `<span class="star-hua ${cls}">${star.mutagen}</span>`;
        }

        // ---------- å£èªåŒ–è§£èªª ----------
        function renderExplanation(astro) {
            const palaces = astro.palaces || [];
            const container = document.getElementById('explain-content');

            // æ‰¾åˆ°å‘½å®®
            const ming = palaces.find(p => p.name === 'å‘½å®®');
            const career = palaces.find(p => p.name === 'å®˜ç¥¿å®®');
            const wealth = palaces.find(p => p.name === 'è²¡å¸›å®®');
            const spouse = palaces.find(p => p.name === 'å¤«å¦»å®®');
            const fortune = palaces.find(p => p.name === 'ç¦å¾·å®®');
            const health = palaces.find(p => p.name === 'ç–¾å„å®®');

            let html = '';

            // å‘½å®®è§£èªª
            if (ming) {
                const stars = (ming.majorStars || []).filter(s => s.name).map(s => s.name);
                html += explainCard('ğŸ  å‘½å®® â€” ä½ æ˜¯ä»€éº¼æ¨£çš„äººï¼Ÿ', getPersonalityExplain(stars, ming));
            }

            // äº‹æ¥­é‹
            if (career) {
                const stars = (career.majorStars || []).filter(s => s.name).map(s => s.name);
                html += explainCard('ğŸ’¼ å®˜ç¥¿å®® â€” ä½ é©åˆåšä»€éº¼å·¥ä½œï¼Ÿ', getCareerExplain(stars, career));
            }

            // è²¡é‹
            if (wealth) {
                const stars = (wealth.majorStars || []).filter(s => s.name).map(s => s.name);
                html += explainCard('ğŸ’° è²¡å¸›å®® â€” ä½ çš„è²¡é‹æ€éº¼æ¨£ï¼Ÿ', getWealthExplain(stars, wealth));
            }

            // æ„Ÿæƒ…
            if (spouse) {
                const stars = (spouse.majorStars || []).filter(s => s.name).map(s => s.name);
                html += explainCard('ğŸ’• å¤«å¦»å®® â€” ä½ çš„æ„Ÿæƒ…è§€', getSpouseExplain(stars, spouse));
            }

            // ç¦å¾·
            if (fortune) {
                const stars = (fortune.majorStars || []).filter(s => s.name).map(s => s.name);
                html += explainCard('ğŸ§˜ ç¦å¾·å®® â€” ä½ çš„å…§å¿ƒä¸–ç•Œ', getFortuneExplain(stars, fortune));
            }

            // å¥åº·
            if (health) {
                const stars = (health.majorStars || []).filter(s => s.name).map(s => s.name);
                html += explainCard('ğŸ¥ ç–¾å„å®® â€” å¥åº·è¦æ³¨æ„ä»€éº¼ï¼Ÿ', getHealthExplain(stars, health));
            }

            // å››åŒ–ç‰¹åˆ¥æé†’
            html += renderHuaSummary(palaces);

            container.innerHTML = html;
        }

        function explainCard(title, content) {
            return `<div class="glass explain-card"><h4>${title}</h4><p>${content}</p></div>`;
        }

        // ============================================================
        // å£èªåŒ–æ˜Ÿæ›œè§£èªªè³‡æ–™åº«
        // ============================================================
        const STAR_PERSONALITY = {
            'ç´«å¾®': 'ä½ éª¨å­è£¡æœ‰ç¨®è€å¤§æ°£è³ªï¼Œå¤©ç”Ÿå°±æœ‰é ˜å°åŠ›ï¼Œä¸å¤ªé¡˜æ„å±ˆå±…äººä¸‹ã€‚åšäº‹æœ‰ä¸»è¦‹ï¼Œæœ‰æ™‚å€™æœƒé¡¯å¾—æ¯”è¼ƒé©•å‚²ï¼Œä½†å…¶å¯¦ä½ åªæ˜¯æ¨™æº–æ¯”è¼ƒé«˜ã€‚',
            'å¤©æ©Ÿ': 'ä½ è…¦è¢‹è½‰å¾—ç‰¹åˆ¥å¿«ï¼Œè°æ˜ã€åæ‡‰éˆæ•ï¼Œå¾ˆæœƒè§€å¯Ÿåˆ†æã€‚ä¸éæœ‰æ™‚å€™æƒ³å¤ªå¤šï¼Œå®¹æ˜“çŒ¶è±«ä¸æ±ºã€‚ä½ é©åˆéœ€è¦å‹•è…¦çš„å·¥ä½œã€‚',
            'å¤ªé™½': 'ä½ å€‹æ€§é–‹æœ—å¤§æ–¹ï¼Œåƒå¤ªé™½ä¸€æ¨£æº«æš–ï¼Œå–œæ­¡å¹«åŠ©åˆ¥äººã€‚ä¸éä¹Ÿå®¹æ˜“ç®¡å¤ªå¤šï¼ŒæŠŠè‡ªå·±æå¾—å¾ˆç´¯ã€‚ç”·å‘½é‡åˆ°å¤ªé™½é€šå¸¸äººç·£ä¸éŒ¯ï¼Œå¥³å‘½å‰‡æ˜¯å®¹æ˜“é‡åˆ°å¥½ç”·äººã€‚',
            'æ­¦æ›²': 'ä½ åšäº‹å¾ˆæœ‰é­„åŠ›ï¼ŒåŸ·è¡ŒåŠ›è¶…å¼·ï¼Œèªªåˆ°åšåˆ°ã€‚è·Ÿè²¡é‹æœ‰é—œçš„æ˜Ÿï¼Œæ‰€ä»¥ä½ è³ºéŒ¢çš„èƒ½åŠ›ä¸å·®ã€‚ç¼ºé»æ˜¯æœ‰æ™‚å€™å¤ªç›´æ¥ï¼Œè¬›è©±æ¯”è¼ƒè¡ã€‚',
            'å¤©åŒ': 'ä½ å€‹æ€§éš¨å’Œã€å–„è‰¯ï¼Œæ˜¯å¤§å®¶çš„é–‹å¿ƒæœã€‚æ¯”è¼ƒäº«å—ç”Ÿæ´»ï¼Œä¸å¤ªå–œæ­¡æœ‰å£“åŠ›çš„ç’°å¢ƒã€‚æœ‰æ™‚å€™æœƒè¢«èªªå¤ªæ‡¶æˆ–å¤ªæ…¢ï¼Œä½†ä½ åªæ˜¯æ¯”è¼ƒä½›ç³»ã€‚',
            'å»‰è²': 'ä½ æœ‰é»ç¥ç¥•æ„Ÿï¼Œå¤–è¡¨çœ‹èµ·ä¾†å†·å†·çš„ï¼Œä½†å…§å¿ƒå…¶å¯¦å¾ˆè±å¯Œã€‚åšäº‹èªçœŸè² è²¬ï¼Œæœ‰å®Œç¾ä¸»ç¾©å‚¾å‘ã€‚æ„Ÿæƒ…æ–¹é¢æ¯”è¼ƒè¤‡é›œï¼Œå®¹æ˜“ææ›–æ˜§ã€‚',
            'å¤©åºœ': 'ä½ ç©©é‡å¤§æ–¹ï¼Œå¾ˆæœƒç†è²¡å­˜éŒ¢ï¼Œæœ‰ç®¡å®¶çš„å¤©åˆ†ã€‚åšäº‹æœ‰æ¢æœ‰ç†ï¼Œä¸å–œæ­¡å†’éšªã€‚çµ¦äººä¸€ç¨®å¯é çš„æ„Ÿè¦ºï¼Œæ˜¯å¤§å®¶çœ¼ä¸­çš„å¥½å¥½å…ˆç”Ÿ/å°å§ã€‚',
            'å¤ªé™°': 'ä½ å…§å¿ƒç´°è†©æ•æ„Ÿï¼Œå…·æœ‰è—è¡“å¤©åˆ†ï¼Œå¯©ç¾çœ¼å…‰å¾ˆå¥½ã€‚æ¯”è¼ƒæ³¨é‡æ„Ÿè¦ºå’Œæ°›åœã€‚å¥³å‘½é‡å¤ªé™°é€šå¸¸é•·å¾—ä¸éŒ¯ï¼Œç”·å‘½å‰‡æ˜¯å€‹æ€§æ¯”è¼ƒæº«æŸ”ã€‚',
            'è²ªç‹¼': 'ä½ å¤šæ‰å¤šè—ã€äº¤éš›æ‰‹è…•ä¸€æµï¼Œä»€éº¼å ´åˆéƒ½èƒ½æ‡‰ä»˜ã€‚èˆˆè¶£å»£æ³›ä½†æœ‰æ™‚å€™ä¸å¤ å°ˆæ³¨ã€‚æ¡ƒèŠ±é‹ä¹Ÿæ¯”è¼ƒæ—ºï¼Œäººç”Ÿå¤šå½©å¤šå§¿ã€‚',
            'å·¨é–€': 'ä½ å¾ˆæœƒèªªè©±ä¹Ÿå¾ˆæœƒè³ªç–‘ï¼Œåˆ†æèƒ½åŠ›å¼·ã€‚é©åˆç•¶å¾‹å¸«ã€è€å¸«ã€è©•è«–å®¶ã€‚ç¼ºé»æ˜¯æœ‰æ™‚å€™å¤ªæ„›æŒ‘æ¯›ç—…ï¼Œäººéš›é—œä¿‚å®¹æ˜“æœ‰å£èˆŒæ˜¯éã€‚',
            'å¤©ç›¸': 'ä½ å¾…äººå’Œå–„ï¼Œå¾ˆæ“…é•·å”èª¿å’Œæœå‹™åˆ¥äººã€‚æ˜¯åœ˜éšŠè£¡çš„æ½¤æ»‘åŠ‘ï¼Œå¤§å®¶éƒ½å–œæ­¡ä½ ã€‚ä¸éæœ‰æ™‚å€™å¤ªåœ¨ä¹åˆ¥äººçœ‹æ³•ï¼Œå®¹æ˜“å¤±å»è‡ªæˆ‘ã€‚',
            'å¤©æ¢': 'ä½ æœ‰é•·è€…é¢¨ç¯„ï¼Œå–œæ­¡ç…§é¡§äººã€ç®¡æ•™äººã€‚æ­£ç¾©æ„Ÿå¼·ï¼Œé‡åˆ°ä¸å…¬çš„äº‹æƒ…æœƒæƒ³å‡ºæ‰‹ã€‚æœ‰é€¢å…‡åŒ–å‰çš„é«”è³ªï¼Œé‹æ°£åœ¨å±æ€¥æ™‚åˆ»ç‰¹åˆ¥å¥½ã€‚',
            'ä¸ƒæ®º': 'ä½ æœ‰å¼·çƒˆçš„ä¼åœ–å¿ƒå’Œè¡Œå‹•åŠ›ï¼Œä¸æ€•å›°é›£ï¼Œè¶ŠæŒ«è¶Šå‹‡ã€‚åšäº‹æœæ–·ï¼Œæœ‰é–‹å‰µç²¾ç¥ã€‚ç¼ºé»æ˜¯æœ‰æ™‚å€™è¡å‹•ï¼Œä¸ç•™é¤˜åœ°ã€‚',
            'ç ´è»': 'ä½ å–œæ­¡æ‰“ç ´å¸¸è¦ã€è¿½æ±‚è®ŠåŒ–ï¼Œæ˜¯å¤©ç”Ÿçš„æ”¹é©è€…ã€‚äººç”Ÿèµ·ä¼æ¯”è¼ƒå¤§ï¼Œä¸æ˜¯å¤§å¥½å°±æ˜¯å¤§å£ã€‚é©åˆåœ¨è®Šå‹•çš„ç’°å¢ƒä¸­ç™¼æ®ã€‚',
        };

        const STAR_CAREER = {
            'ç´«å¾®': 'é©åˆç•¶ä¸»ç®¡æˆ–è€é—†ï¼Œç®¡ç†éšå±¤æ˜¯ä½ çš„èˆå°',
            'å¤©æ©Ÿ': 'é©åˆé¡§å•ã€ç­–åŠƒã€ç§‘æŠ€ç›¸é—œå·¥ä½œï¼Œéœ€è¦å‹•è…¦çš„é ˜åŸŸ',
            'å¤ªé™½': 'é©åˆå…¬é—œã€æ•™è‚²ã€æ”¿æ²»ç­‰éœ€è¦æ‹‹é ­éœ²é¢çš„å·¥ä½œ',
            'æ­¦æ›²': 'é©åˆé‡‘èã€æ¥­å‹™é–‹ç™¼ã€è»è­¦ï¼Œè·Ÿæ•¸å­—å’Œè¡Œå‹•åŠ›æœ‰é—œ',
            'å¤©åŒ': 'é©åˆç¤¾å·¥ã€å¿ƒç†è«®å•†ã€æœå‹™æ¥­ï¼Œéœ€è¦è€å¿ƒå’ŒåŒç†å¿ƒçš„å·¥ä½œ',
            'å»‰è²': 'é©åˆæ³•å¾‹ã€å…¬å‹™é«”ç³»ã€ç¨½æ ¸ï¼Œç´°å¿ƒåš´è¬¹çš„å·¥ä½œ',
            'å¤©åºœ': 'é©åˆè²¡å‹™ã€è¡Œæ”¿ç®¡ç†ã€æˆ¿åœ°ç”¢ï¼Œç©©å®šå¯é çš„é ˜åŸŸ',
            'å¤ªé™°': 'é©åˆè¨­è¨ˆã€è—è¡“å‰µä½œã€æˆ¿åœ°ç”¢ï¼Œè·Ÿç¾å’Œæ„Ÿè¦ºæœ‰é—œ',
            'è²ªç‹¼': 'é©åˆæ¼”è—ã€è¡ŒéŠ·ã€é¤é£²å¨›æ¨‚ï¼Œéœ€è¦äººéš›æ‰‹è…•çš„è¡Œæ¥­',
            'å·¨é–€': 'é©åˆå¾‹å¸«ã€æ•™å¸«ã€å‚³åª’ã€æ¥­å‹™å£æ‰ç›¸é—œå·¥ä½œ',
            'å¤©ç›¸': 'é©åˆç§˜æ›¸ã€äººè³‡ã€å…¬é—œï¼Œå”èª¿æœå‹™å‹çš„è·ä½',
            'å¤©æ¢': 'é©åˆé†«ç”Ÿã€è€å¸«ã€ä¿éšªã€å®—æ•™ï¼Œç…§é¡§å’Œä¿è­·ç›¸é—œ',
            'ä¸ƒæ®º': 'é©åˆå‰µæ¥­ã€è»äº‹ã€é‹å‹•ã€å†’éšªå‹å·¥ä½œ',
            'ç ´è»': 'é©åˆé–‹æ‹“æ–°äº‹æ¥­ã€è‡ªç”±æ¥­ã€å‰µæ–°é ˜åŸŸ',
        };

        function getPersonalityExplain(stars, palace) {
            if (stars.length === 0) return 'é€™å€‹å‘½å®®æ²’æœ‰ä¸»æ˜Ÿåé®ï¼Œè¡¨ç¤ºä½ çš„å€‹æ€§æ¯”è¼ƒå—åˆ°å°å®®ï¼ˆé·ç§»å®®ï¼‰çš„å½±éŸ¿ï¼Œå»ºè­°åƒè€ƒé·ç§»å®®çš„ä¸»æ˜Ÿã€‚é€™ç¨®å‘½æ ¼çš„äººé€šå¸¸æ¯”è¼ƒéˆæ´»å¤šè®Šï¼Œé©æ‡‰åŠ›å¼·ã€‚';
            let text = stars.map(s => `<strong>${s}</strong>ï¼š${STAR_PERSONALITY[s] || 'æ­¤æ˜Ÿåœ¨å‘½å®®ï¼Œè³¦äºˆä½ ç¨ç‰¹çš„å€‹æ€§ç‰¹è³ªã€‚'}`).join('<br><br>');
            // æª¢æŸ¥å››åŒ–
            const huaStars = (palace.majorStars || []).filter(s => s.mutagen);
            if (huaStars.length) {
                text += '<br><br>âš¡ <strong>å››åŒ–åŠ æŒï¼š</strong>';
                huaStars.forEach(s => {
                    if (s.mutagen === 'ç¥¿') text += `<br>ä½ çš„${s.name}åŒ–ç¥¿ï¼Œè¡¨ç¤ºé€™æ–¹é¢çš„é‹å‹¢ç‰¹åˆ¥é †é‚ï¼Œæ˜¯è€å¤©çµ¦ä½ çš„ç¦®ç‰©ã€‚`;
                    if (s.mutagen === 'æ¬Š') text += `<br>ä½ çš„${s.name}åŒ–æ¬Šï¼Œåšäº‹æœ‰ä¸»å°æ¬Šï¼Œä½†ä¹Ÿè¦æ³¨æ„ä¸è¦å¤ªå¼·å‹¢ã€‚`;
                    if (s.mutagen === 'ç§‘') text += `<br>ä½ çš„${s.name}åŒ–ç§‘ï¼Œæœ‰è²´äººç·£ï¼Œå­¸æ±è¥¿å¾ˆå¿«ï¼Œå®¹æ˜“å‡ºåã€‚`;
                    if (s.mutagen === 'å¿Œ') text += `<br>ä½ çš„${s.name}åŒ–å¿Œï¼Œé€™æ–¹é¢å®¹æ˜“å¡é—œæˆ–å¤ªåŸ·è‘—ï¼Œè¦å­¸æœƒæ”¾ä¸‹ã€‚`;
                });
            }
            return text;
        }

        function getCareerExplain(stars, palace) {
            if (stars.length === 0) return 'å®˜ç¥¿å®®æ²’æœ‰ä¸»æ˜Ÿï¼Œä½ çš„äº‹æ¥­æ©Ÿæœƒæ¯”è¼ƒå¤šå…ƒï¼Œå¯èƒ½æœƒå¾äº‹ä¸åªä¸€ç¨®è¡Œæ¥­ï¼Œæˆ–è€…å—å¤§ç’°å¢ƒå½±éŸ¿è¼ƒå¤§ã€‚å»ºè­°æ‰¾åˆ°è‡ªå·±çš„èˆˆè¶£å†æ·±è€•ã€‚';
            return stars.map(s => `<strong>${s}</strong>ï¼š${STAR_CAREER[s] || 'åœ¨äº‹æ¥­æ–¹é¢æœƒå¸¶ä¾†ç¨ç‰¹çš„è¡¨ç¾ã€‚'}`).join('<br><br>');
        }

        function getWealthExplain(stars, palace) {
            if (stars.length === 0) return 'è²¡å¸›å®®æ²’æœ‰ä¸»æ˜Ÿï¼Œä¸ä»£è¡¨æ²’æœ‰éŒ¢ï¼åªæ˜¯è³ºéŒ¢çš„æ–¹å¼æ¯”è¼ƒä¸å›ºå®šï¼Œå¯èƒ½éœ€è¦é å¤šå…ƒæ”¶å…¥æˆ–å‰¯æ¥­ã€‚';
            const explains = { 'ç´«å¾®': 'ä½ çš„è²¡é‹æ ¼å±€å¤§ï¼Œé©åˆåšå¤§äº‹æ¥­è³ºå¤§éŒ¢ï¼Œå°æ‰“å°é¬§ä½ æ²’èˆˆè¶£', 'å¤©æ©Ÿ': 'ä½ é è…¦è¢‹è³ºéŒ¢ï¼Œé©åˆæŠ•è³‡ç†è²¡ã€é¡§å•è«®è©¢ç­‰æ™ºæ…§å‹æ”¶å…¥', 'å¤ªé™½': 'ä½ çš„éŒ¢ä¾†å¾—å¤§æ–¹å»å¾—ä¹Ÿå¤§æ–¹ï¼Œä¸å¤ªæœƒå­˜éŒ¢ï¼Œä½†æ”¶å…¥ä¾†æºå»£', 'æ­¦æ›²': 'è²¡æ˜Ÿå…¥è²¡å¸›å®®ï¼Œé€™æ˜¯è²¡é‹å¾ˆå¥½çš„æ ¼å±€ï¼ä½ å¾ˆæœƒè³ºéŒ¢ä¹Ÿæœƒç†è²¡', 'å¤©åŒ': 'ä½ å°éŒ¢æ¯”è¼ƒéš¨ç·£ï¼Œä¸æœƒç‰¹åˆ¥å»è¿½é€è²¡å¯Œï¼Œä½†åŸºæœ¬ç”Ÿæ´»ä¸æˆå•é¡Œ', 'å»‰è²': 'ä½ è³ºéŒ¢çš„æ–¹å¼å¯èƒ½æ¯”è¼ƒè¤‡é›œï¼Œæœƒæ¶‰åŠå¤šç¨®æ”¶å…¥ä¾†æº', 'å¤©åºœ': 'ä½ å¾ˆæœƒå­˜éŒ¢ç†è²¡ï¼Œè²¡é‹ç©©å®šï¼Œé©åˆé•·æœŸæŠ•è³‡ä¸é©åˆæŠ•æ©Ÿ', 'å¤ªé™°': 'ä½ çš„è²¡é‹è·Ÿæˆ¿åœ°ç”¢ã€å¥³æ€§å¸‚å ´æœ‰é—œï¼Œé©åˆç©©æ‰ç©©æ‰“åœ°ç´¯ç©', 'è²ªç‹¼': 'ä½ çš„è²¡é‹è·Ÿäººéš›æœ‰é—œï¼Œæœƒé€éç¤¾äº¤å’Œæ‡‰é…¬å¸¶ä¾†è²¡æº', 'å·¨é–€': 'ä½ é å£æ‰å’Œå°ˆæ¥­çŸ¥è­˜è³ºéŒ¢ï¼Œé©åˆæ•™å­¸ã€è«®è©¢ã€ä»£è¨€', 'å¤©ç›¸': 'ä½ çš„è²¡é‹ä¸­ç­‰ç©©å®šï¼Œé©åˆè–ªæ°´æ—æˆ–æ­é…ä»–äººä¸€èµ·è³ºéŒ¢', 'å¤©æ¢': 'ä½ è·Ÿä¿éšªã€æ…ˆå–„ã€é†«ç™‚ç›¸é—œçš„è²¡é‹æ¯”è¼ƒå¥½', 'ä¸ƒæ®º': 'ä½ æ•¢è¡æ•¢æ‹¼ï¼Œå¯èƒ½å¤§è³ºå¤§è³ ï¼Œå»ºè­°æ§åˆ¶é¢¨éšª', 'ç ´è»': 'ä½ çš„è²¡é‹èµ·ä¼å¤§ï¼Œé©åˆåœ¨æ–°é ˜åŸŸé–‹æ‹“é€²å–' };
            return stars.map(s => `<strong>${s}</strong>ï¼š${explains[s] || 'åœ¨è²¡é‹æ–¹é¢å¸¶ä¾†ç‰¹æ®Šå½±éŸ¿ã€‚'}`).join('<br><br>');
        }

        function getSpouseExplain(stars, palace) {
            if (stars.length === 0) return 'å¤«å¦»å®®æ²’æœ‰ä¸»æ˜Ÿï¼Œæ„Ÿæƒ…æ–¹é¢å¯èƒ½æ¯”è¼ƒæ™šæ‰ç©©å®šï¼Œæˆ–è€…å¦ä¸€åŠçš„å€‹æ€§æ¯”è¼ƒéš¨å’Œã€ä¸å¼·å‹¢ã€‚';
            const explains = { 'ç´«å¾®': 'ä½ çš„å¦ä¸€åŠå¯èƒ½åœ°ä½ä¸ä½æˆ–èƒ½åŠ›å¾ˆå¼·ï¼Œä½†ä¹Ÿå¯èƒ½æ¯”è¼ƒéœ¸é“', 'å¤©æ©Ÿ': 'ä½ è·Ÿå¦ä¸€åŠç›¸è™•åƒæœ‹å‹ï¼Œå¿ƒéˆç›¸é€šå¾ˆé‡è¦ï¼Œä½†ä¹Ÿå®¹æ˜“æƒ³å¤ªå¤š', 'å¤ªé™½': 'ç”·å‘½ä»£è¡¨ä½ æ˜¯å¥½ä¸ˆå¤«ï¼Œå¥³å‘½ä»£è¡¨æœƒé‡åˆ°é™½å…‰å‹çš„å°è±¡', 'æ­¦æ›²': 'æ„Ÿæƒ…ä¸Šæ¯”è¼ƒç›´ä¾†ç›´å»ï¼Œä¸å¤ªæµªæ¼«ä½†å¾ˆå¯¦åœ¨ï¼Œå®¹æ˜“æ™šå©š', 'å¤©åŒ': 'æ„Ÿæƒ…ç”œèœœå’Œè«§ï¼Œå¦ä¸€åŠå€‹æ€§æº«æŸ”é«”è²¼ã€å¾ˆå¥½ç›¸è™•', 'å»‰è²': 'æ„Ÿæƒ…æ¯”è¼ƒè¤‡é›œï¼Œå®¹æ˜“æœ‰æš—æˆ€æˆ–ä¸‰è§’é—œä¿‚çš„ç‹€æ³', 'å¤©åºœ': 'å¦ä¸€åŠå¾ˆç©©é‡å¯é ï¼Œå©šå§»ç”Ÿæ´»å®‰å®šï¼Œæ˜¯æŒå®¶å‹çš„', 'å¤ªé™°': 'å¦ä¸€åŠæº«æŸ”ç´°è†©æœ‰æ°£è³ªï¼Œä½†æœ‰æ™‚å¤ªæ•æ„Ÿéœ€è¦å¤šå“„', 'è²ªç‹¼': 'æ¡ƒèŠ±æ¯”è¼ƒæ—ºï¼Œæ„Ÿæƒ…ç¶“æ­·è±å¯Œï¼Œå¦ä¸€åŠå¯èƒ½å¾ˆæœ‰é­…åŠ›', 'å·¨é–€': 'è·Ÿå¦ä¸€åŠå®¹æ˜“å› ç‚ºæºé€šç”¢ç”Ÿæ‘©æ“¦ï¼Œå­¸æœƒå¥½å¥½èªªè©±å¾ˆé‡è¦', 'å¤©ç›¸': 'å¦ä¸€åŠå–„è‰¯é«”è²¼ï¼Œä½†å¯èƒ½å¤ªä¾è³´ä½ æˆ–å¤ªè½è©±', 'å¤©æ¢': 'å¯èƒ½æœƒé‡åˆ°å¹´ç´€å·®è·è¼ƒå¤§çš„å°è±¡æˆ–æ˜¯å¾ˆç…§é¡§ä½ çš„äºº', 'ä¸ƒæ®º': 'æ„Ÿæƒ…æ¯”è¼ƒè½Ÿè½Ÿçƒˆçƒˆï¼Œå¦ä¸€åŠå€‹æ€§å¼·ã€æœ‰ä¸»è¦‹', 'ç ´è»': 'æ„Ÿæƒ…èµ·ä¼å¤§ï¼Œå¯èƒ½ç¶“æ­·å¤šæ¬¡åˆ†åˆæ‰æ‰¾åˆ°å°çš„äºº' };
            return stars.map(s => `<strong>${s}</strong>ï¼š${explains[s] || 'åœ¨æ„Ÿæƒ…æ–¹é¢å¸¶ä¾†ç‰¹æ®Šå½±éŸ¿ã€‚'}`).join('<br><br>');
        }

        function getFortuneExplain(stars, palace) {
            if (stars.length === 0) return 'ç¦å¾·å®®æ²’æœ‰ä¸»æ˜Ÿè¡¨ç¤ºä½ çš„å…§å¿ƒæ¯”è¼ƒå®¹æ˜“å—ç’°å¢ƒå½±éŸ¿ï¼Œæœ‰æ™‚å€™æœƒè¦ºå¾—ç©ºè™›æˆ–æ‰¾ä¸åˆ°æ–¹å‘ï¼Œå»ºè­°åŸ¹é¤Šèˆˆè¶£æ„›å¥½ä¾†å……å¯¦è‡ªå·±ã€‚';
            const explains = { 'ç´«å¾®': 'ä½ çš„ç²¾ç¥ä¸–ç•Œè±å¯Œï¼Œæœ‰å“å‘³æœ‰è¿½æ±‚ï¼Œä½†æœ‰æ™‚æœƒè¦ºå¾—é«˜è™•ä¸å‹å¯’', 'å¤©æ©Ÿ': 'ä½ å–œæ­¡æ€è€ƒäººç”Ÿå“²å­¸ï¼Œè…¦è¢‹åœä¸ä¸‹ä¾†ï¼Œå®¹æ˜“å¤±çœ æƒ³å¤ªå¤š', 'å¤ªé™½': 'ä½ æ˜¯å€‹æ¨‚è§€é–‹æœ—çš„äººï¼Œä½†å®¹æ˜“æ“å¿ƒå¤ªå¤šï¼Œå»ºè­°å­¸æœƒæ”¾é¬†', 'æ­¦æ›²': 'ä½ åšäº‹è¬›æ•ˆç‡ï¼Œä¸å–œæ­¡æµªè²»æ™‚é–“ï¼Œç”Ÿæ´»æ¯”è¼ƒè¦å¾‹ä½†æœ‰æ™‚å¤ªåš´è‚…', 'å¤©åŒ': 'ä½ å¾ˆæœƒäº«å—ç”Ÿæ´»ï¼ŒçŸ¥è¶³å¸¸æ¨‚ï¼Œæ˜¯æœ‹å‹åœˆè£¡çš„å¿«æ¨‚æ³‰æº', 'å»‰è²': 'ä½ å¤–å†·å…§ç†±ï¼Œå…§å¿ƒæˆ²å¾ˆå¤šï¼Œæœ‰æ™‚å€™æœƒé‘½ç‰›è§’å°–', 'å¤©åºœ': 'ä½ å¿ƒæ…‹ç©©å®šã€çŸ¥è¶³ï¼Œæ™šå¹´é‹å‹¢å¥½ï¼Œæ˜¯æœ‰ç¦æ°£çš„äºº', 'å¤ªé™°': 'ä½ æ„Ÿæ€§ç´°è†©ï¼Œå®¹æ˜“å—åˆ°ç¾çš„äº‹ç‰©æ„Ÿå‹•ï¼Œæœ‰è—è¡“æ¶µé¤Š', 'è²ªç‹¼': 'ä½ èˆˆè¶£å»£æ³›ã€å¥½åƒå¥½ç©ï¼Œäººç”Ÿå¤šå§¿å¤šå½©', 'å·¨é–€': 'ä½ æ€æ…®æ¯”è¼ƒå¤šï¼Œå®¹æ˜“æ“”å¿ƒç…©æƒ±ï¼Œå»ºè­°å¤šè·Ÿäººäº¤æµ', 'å¤©ç›¸': 'ä½ å¿ƒæ…‹å¹³å’Œæº«é †ï¼Œä¸å¤ªæœƒè·Ÿäººèµ·è¡çª', 'å¤©æ¢': 'ä½ æœ‰é•·è€…æ™ºæ…§ï¼Œçœ‹äº‹æƒ…çœ‹å¾—æ¯”è¼ƒé–‹ï¼Œæ™šå¹´æ¸…é–’æœ‰ç¦', 'ä¸ƒæ®º': 'ä½ å…§å¿ƒæœ‰è‚¡è¡å‹ï¼Œé–’ä¸ä¸‹ä¾†ï¼Œå–œæ­¡æŒ‘æˆ°è‡ªæˆ‘', 'ç ´è»': 'ä½ è¿½æ±‚åˆºæ¿€å’Œè®ŠåŒ–ï¼Œç”Ÿæ´»ä¸æœƒç„¡èŠä½†æœ‰æ™‚å€™å¤ªæŠ˜é¨°è‡ªå·±' };
            return stars.map(s => `<strong>${s}</strong>ï¼š${explains[s] || 'åœ¨ç²¾ç¥å±¤é¢å¸¶ä¾†ç‰¹æ®Šå½±éŸ¿ã€‚'}`).join('<br><br>');
        }

        function getHealthExplain(stars, palace) {
            if (stars.length === 0) return 'ç–¾å„å®®æ²’æœ‰ä¸»æ˜Ÿï¼Œèº«é«”ç‹€æ³é€šå¸¸æ¯”è¼ƒå¹³ç©©ï¼Œä½†é‚„æ˜¯è¦æ³¨æ„åŸºæœ¬çš„ä½œæ¯å’Œé£²é£Ÿã€‚';
            const explains = { 'ç´«å¾®': 'æ•´é«”å¥åº·ä¸éŒ¯ï¼Œä½†è¦æ³¨æ„è…¸èƒƒå’Œè„¾è‡Ÿæ–¹é¢çš„å•é¡Œ', 'å¤©æ©Ÿ': 'è‚è†½æ–¹é¢è¦æ³¨æ„ï¼Œä¹Ÿå®¹æ˜“æœ‰ç¥ç¶“è¡°å¼±æˆ–å¤±çœ çš„å›°æ“¾', 'å¤ªé™½': 'æ³¨æ„çœ¼ç›å’Œè¡€å£“ï¼Œå®¹æ˜“å› ç‚ºå¤ªæ“å‹è€Œå½±éŸ¿å¿ƒè¡€ç®¡', 'æ­¦æ›²': 'æ³¨æ„è‚ºéƒ¨å’Œå‘¼å¸ç³»çµ±ï¼Œä¹Ÿå®¹æ˜“æœ‰ç­‹éª¨æ–¹é¢çš„å•é¡Œ', 'å¤©åŒ': 'è¦æ³¨æ„è…è‡Ÿå’Œæ³Œå°¿ç³»çµ±ï¼Œä¹Ÿå®¹æ˜“æœ‰æ°´è…«çš„ç‹€æ³', 'å»‰è²': 'æ³¨æ„å¿ƒè‡Ÿè¡€æ¶²æ–¹é¢ï¼Œä¹Ÿå®¹æ˜“æœ‰çš®è†šæ•æ„Ÿçš„å•é¡Œ', 'å¤©åºœ': 'æ¶ˆåŒ–ç³»çµ±æ¯”è¼ƒå¼±ï¼Œå®¹æ˜“è„¹æ°£æˆ–è…¸èƒƒä¸é©', 'å¤ªé™°': 'è…è‡Ÿå’Œå…§åˆ†æ³Œè¦æ³¨æ„ï¼Œå¥³æ€§æœ‹å‹ç‰¹åˆ¥æ³¨æ„å©¦ç§‘', 'è²ªç‹¼': 'è‚è†½æ–¹é¢è¦æ³¨æ„ï¼Œä¹Ÿè¦å°å¿ƒç¸±æ…¾éåº¦å½±éŸ¿å¥åº·', 'å·¨é–€': 'è¦æ³¨æ„å£è…”å’Œçš®è†šï¼Œä¹Ÿå®¹æ˜“å› å£“åŠ›å½±éŸ¿æ¶ˆåŒ–ç³»çµ±', 'å¤©ç›¸': 'æ³¨æ„è…è‡Ÿå’Œçš®è†šï¼Œæ•´é«”ä¾†èªªå¥åº·ç‹€æ³ä¸­ç­‰', 'å¤©æ¢': 'æœ‰é€¢å…‡åŒ–å‰çš„é«”è³ªï¼Œå°ç—…ä¸æ–·ä½†å¤§ç—…ä¸æœƒæœ‰', 'ä¸ƒæ®º': 'è¦æ³¨æ„æ„å¤–å‚·å®³ï¼Œé‹å‹•æ™‚ç‰¹åˆ¥å°å¿ƒï¼Œä¹Ÿè¦æ³¨æ„å‘¼å¸ç³»çµ±', 'ç ´è»': 'èº«é«”èµ·ä¼å¤§ï¼Œå¥åº·å¥½å£å–æ±ºæ–¼ç”Ÿæ´»ç¿’æ…£ï¼Œæ³¨æ„è…è‡Ÿ' };
            return stars.map(s => `<strong>${s}</strong>ï¼š${explains[s] || 'å¥åº·æ–¹é¢éœ€è¦å¤šåŠ ç•™æ„ã€‚'}`).join('<br><br>');
        }

        // å››åŒ–ç¸½è¦½
        function renderHuaSummary(palaces) {
            let huaItems = [];
            palaces.forEach(p => {
                [...(p.majorStars || []), ...(p.minorStars || [])].forEach(s => {
                    if (s.mutagen) huaItems.push({ star: s.name, hua: s.mutagen, palace: p.name });
                });
            });
            if (huaItems.length === 0) return '';
            let html = '<div class="glass explain-card"><h4>ğŸ”„ å››åŒ–åˆ†å¸ƒä¸€è¦½</h4><p>ä½ çš„å‘½ç›¤ä¸­ï¼Œå››åŒ–çš„åˆ†å¸ƒå¦‚ä¸‹ï¼š<br><br>';
            huaItems.forEach(h => {
                const icon = h.hua === 'ç¥¿' ? 'ğŸŸ¢' : h.hua === 'æ¬Š' ? 'ğŸ”´' : h.hua === 'ç§‘' ? 'ğŸ”µ' : 'âš«';
                html += `${icon} <strong>${h.star}</strong> åŒ–<strong>${h.hua}</strong> â†’ è½åœ¨<strong>${h.palace}</strong><br>`;
            });
            html += '<br>åŒ–ç¥¿è½åœ¨å“ªå€‹å®®ä½ï¼Œé‚£å€‹é¢å‘å°±ç‰¹åˆ¥é †åˆ©ï¼›åŒ–å¿Œè½åœ¨å“ªè£¡ï¼Œå°±è¦ç‰¹åˆ¥æ³¨æ„é‚£å€‹é¢å‘çš„å•é¡Œã€‚</p></div>';
            return html;
        }

        // ---------- å¤§é™åˆ†æ ----------
        function renderDecade(astro) {
            const container = document.getElementById('decade-content');
            const palaces = astro.palaces || [];
            let html = '<div class="glass" style="padding:16px;margin-bottom:12px"><h4 style="font-family:var(--font-serif);color:var(--gold);margin-bottom:10px">ğŸ“… ä»€éº¼æ˜¯å¤§é™ï¼Ÿ</h4><p style="font-size:0.82rem;color:var(--text-secondary);line-height:1.7">å¤§é™å°±æ˜¯ä½ äººç”Ÿçš„ã€Œå¤§åŠ‡æœ¬ã€ï¼Œæ¯åå¹´æ›ä¸€å€‹ä¸»é¡Œã€‚æ¯”å¦‚èªª 23~32 æ­²é€™åå¹´çš„é‡å¿ƒå¯èƒ½åœ¨äº‹æ¥­è¡åˆºï¼Œ33~42 æ­²å¯èƒ½è½‰å‘å®¶åº­ã€‚çœ‹å¤§é™å¯ä»¥äº†è§£ä½ æ¯å€‹åå¹´çš„äººç”Ÿé‡é»ã€‚</p></div>';

            palaces.forEach(p => {
                if (p.decpiod || p.ages) {
                    const range = p.ages ? `${p.ages[0]}~${p.ages[p.ages.length - 1]}æ­²` : '';
                    const majorStars = (p.majorStars || []).filter(s => s.name).map(s => s.name).join('ã€');
                    html += `<div class="glass fortune-period">
                <div class="period-title">${p.name} å¤§é™ ${range}</div>
                <div class="period-detail">
                    ä¸»æ˜Ÿï¼š${majorStars || 'ç„¡ä¸»æ˜Ÿ'}
                    ${p.decpiod ? `<br>å¤©å¹²ï¼š${p.heavenlyStemOfPalace || ''}` : ''}
                </div>
            </div>`;
                }
            });

            container.innerHTML = html;
        }

        // ---------- æµå¹´é‹å‹¢ ----------
        function initYearlySelector(astro) {
            const sel = document.getElementById('yearly-select');
            const currentYear = new Date().getFullYear();
            sel.innerHTML = '';
            for (let y = currentYear - 2; y <= currentYear + 5; y++) {
                sel.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}å¹´</option>`;
            }
            renderYearly();
        }

        function renderYearly() {
            const year = parseInt(document.getElementById('yearly-select').value);
            const container = document.getElementById('yearly-content');
            const astro = appState.astrolabe;
            if (!astro) return;

            try {
                const horoscope = astro.horoscope(year, 1, 1, 0);
                if (horoscope && horoscope.yearly) {
                    const y = horoscope.yearly;
                    let html = `<div class="glass" style="padding:16px;margin-bottom:12px">
                <h4 style="font-family:var(--font-serif);color:var(--gold);margin-bottom:8px">ğŸ‰ ${year}å¹´ æµå¹´é‹å‹¢</h4>
                <p style="font-size:0.82rem;color:var(--text-secondary);line-height:1.7">
                    æµå¹´å°±åƒæ˜¯æ¯ä¸€å¹´çš„ã€Œå¹´åº¦ä¸»é¡Œæ›²ã€ã€‚ä¸åŒå¹´ä»½æœƒå•Ÿå‹•ä½ å‘½ç›¤ä¸­ä¸åŒçš„èƒ½é‡ï¼Œè®“ä½ åœ¨é‚£ä¸€å¹´çš„æŸäº›æ–¹é¢æ¯”è¼ƒé †æˆ–æ¯”è¼ƒéœ€è¦æ³¨æ„ã€‚
                </p>
            </div>`;

                    // å˜—è©¦å–å¾—æµå¹´è³‡è¨Š
                    if (y.palpiodName) {
                        html += `<div class="glass fortune-period"><div class="period-title">æµå¹´å®®ä½ï¼š${y.palpiodName}</div></div>`;
                    }
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="glass" style="padding:16px"><p style="color:var(--text-secondary);font-size:0.85rem">æ­¤å¹´ä»½çš„æµå¹´è³‡è¨Šæš«æ™‚ç„¡æ³•å–å¾—ï¼Œè«‹å˜—è©¦å…¶ä»–å¹´ä»½ã€‚</p></div>';
                }
            } catch (e) {
                container.innerHTML = '<div class="glass" style="padding:16px"><p style="color:var(--text-secondary);font-size:0.85rem">æµå¹´åˆ†æåŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p></div>';
            }
        }

        // ---------- æµæœˆåˆ†æ ----------
        function initMonthlySelector(astro) {
            const sel = document.getElementById('monthly-year');
            const currentYear = new Date().getFullYear();
            sel.innerHTML = '';
            for (let y = currentYear - 1; y <= currentYear + 2; y++) {
                sel.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}å¹´</option>`;
            }
        }

        function updateMonthlyOptions() { renderMonthly(); }

        function renderMonthly() {
            const year = parseInt(document.getElementById('monthly-year').value);
            const month = parseInt(document.getElementById('monthly-month').value);
            const container = document.getElementById('monthly-content');
            const astro = appState.astrolabe;
            if (!astro) return;

            try {
                const horoscope = astro.horoscope(year, month, 1, 0);
                let html = `<div class="glass" style="padding:16px">
            <h4 style="font-family:var(--font-serif);color:var(--gold);margin-bottom:8px">ğŸ“† ${year}å¹´${month}æœˆ æµæœˆåˆ†æ</h4>
            <p style="font-size:0.82rem;color:var(--text-secondary);line-height:1.7">
                æµæœˆæ˜¯æŠŠæµå¹´å†ç´°åˆ†åˆ°æ¯å€‹æœˆã€‚å®ƒå¯ä»¥å¹«åŠ©ä½ äº†è§£æ¯å€‹æœˆé©åˆåšä»€éº¼ã€è¦é¿é–‹ä»€éº¼ã€‚å°¤å…¶æ˜¯åšé‡å¤§æ±ºå®šï¼ˆæ›å·¥ä½œã€çµå©šã€æŠ•è³‡ï¼‰æ™‚å¯ä»¥åƒè€ƒã€‚
            </p>
        </div>`;
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<div class="glass" style="padding:16px"><p style="color:var(--text-secondary);font-size:0.85rem">æµæœˆè³‡è¨Šè¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p></div>';
            }
        }

        // ---------- ä¸‰æ–¹å››æ­£ ----------
        function initRelationsSelector(astro) {
            const sel = document.getElementById('relations-palace');
            const palaces = astro.palaces || [];
            sel.innerHTML = '';
            palaces.forEach((p, i) => {
                sel.innerHTML += `<option value="${i}">${p.name}</option>`;
            });
            renderRelations();
        }

        function renderRelations() {
            const idx = parseInt(document.getElementById('relations-palace').value);
            const container = document.getElementById('relations-content');
            const astro = appState.astrolabe;
            if (!astro) return;

            const palaces = astro.palaces || [];
            const palace = palaces[idx];
            if (!palace) return;

            // ä¸‰æ–¹å››æ­£ï¼šæœ¬å®® + å°å®® + ä¸‰åˆå®®ï¼ˆå‰4å¾Œ4çš„ä½ç½®ï¼‰
            const total = palaces.length;
            const oppositeIdx = (idx + 6) % total;
            const triIdx1 = (idx + 4) % total;
            const triIdx2 = (idx + 8) % total;

            const opposite = palaces[oppositeIdx];
            const tri1 = palaces[triIdx1];
            const tri2 = palaces[triIdx2];

            const getStarNames = p => (p.majorStars || []).filter(s => s.name).map(s => {
                let n = `<strong>${s.name}</strong>`;
                if (s.mutagen) n += `<span class="star-hua ${s.mutagen === 'ç¥¿' ? 'hua-lu' : s.mutagen === 'æ¬Š' ? 'hua-quan' : s.mutagen === 'ç§‘' ? 'hua-ke' : 'hua-ji'}">${s.mutagen}</span>`;
                return n;
            }).join('ã€') || 'ç„¡ä¸»æ˜Ÿ';

            let html = `<div class="glass" style="padding:16px;margin-bottom:12px">
        <h4 style="font-family:var(--font-serif);color:var(--gold);margin-bottom:8px">ğŸ”º ä»€éº¼æ˜¯ä¸‰æ–¹å››æ­£ï¼Ÿ</h4>
        <p style="font-size:0.82rem;color:var(--text-secondary);line-height:1.7">
            ä¸‰æ–¹å››æ­£æ˜¯ç´«å¾®æ–—æ•¸çš„é€²éšçœ‹æ³•ã€‚ç°¡å–®èªªå°±æ˜¯çœ‹ä¸€å€‹å®®ä½ä¸èƒ½åªçœ‹å®ƒè‡ªå·±ï¼Œé‚„è¦çœ‹å®ƒã€Œå‰å¾Œå·¦å³ã€çš„é„°å±…ã€‚å°±åƒè©•ä¼°ä¸€é–“æˆ¿å­ï¼Œé™¤äº†çœ‹æˆ¿å­æœ¬èº«ï¼Œé‚„è¦çœ‹å‘¨åœçš„ç’°å¢ƒä¸€æ¨£ã€‚
        </p>
    </div>`;

            html += `<div class="glass fortune-period">
        <div class="period-title">ğŸ“ æœ¬å®®ï¼š${palace.name}</div>
        <div class="period-detail">ä¸»æ˜Ÿï¼š${getStarNames(palace)}</div>
    </div>`;

            html += `<div class="glass fortune-period">
        <div class="period-title">ğŸª å°å®®ï¼š${opposite.name}</div>
        <div class="period-detail">ä¸»æ˜Ÿï¼š${getStarNames(opposite)}<br>
        <span style="font-size:0.78rem;color:var(--text-secondary)">å°å®®çš„èƒ½é‡æœƒã€Œç…§å°„ã€éä¾†å½±éŸ¿æœ¬å®®ï¼Œå°¤å…¶æœ¬å®®æ²’æœ‰ä¸»æ˜Ÿæ™‚å½±éŸ¿æ›´å¤§ã€‚</span></div>
    </div>`;

            html += `<div class="glass fortune-period">
        <div class="period-title">ğŸ”» ä¸‰åˆå®®ï¼š${tri1.name}</div>
        <div class="period-detail">ä¸»æ˜Ÿï¼š${getStarNames(tri1)}</div>
    </div>`;

            html += `<div class="glass fortune-period">
        <div class="period-title">ğŸ”» ä¸‰åˆå®®ï¼š${tri2.name}</div>
        <div class="period-detail">ä¸»æ˜Ÿï¼š${getStarNames(tri2)}</div>
    </div>`;

            html += `<div class="glass explain-card" style="margin-top:12px">
        <p style="font-size:0.82rem;line-height:1.7">
            ğŸ’¡ <strong>æ€éº¼çœ‹ï¼Ÿ</strong><br>
            æŠŠæœ¬å®®ã€å°å®®å’Œå…©å€‹ä¸‰åˆå®®çš„æ˜Ÿæ›œå…¨éƒ¨æ”¾åœ¨ä¸€èµ·çœ‹ã€‚å¦‚æœå‰æ˜Ÿï¼ˆç¥¿ã€æ¬Šã€ç§‘ï¼‰å¤šï¼Œé‚£é€™å€‹å®®ä½ä»£è¡¨çš„äººç”Ÿé¢å‘å°±æ¯”è¼ƒé †åˆ©ã€‚
            å¦‚æœç…æ˜Ÿæˆ–å¿Œæ˜Ÿå¤šï¼Œå°±è¡¨ç¤ºé€™æ–¹é¢éœ€è¦å¤šè²»å¿ƒæ€ã€‚ä¸éä¹Ÿä¸ç”¨å¤ªæ“”å¿ƒï¼Œå‘½ç›¤æ˜¯æé†’ä½ ã€ŒçŸ¥é“æœƒæœ‰è€ƒé©—ï¼Œå°±èƒ½æå‰æº–å‚™ã€ã€‚
        </p>
    </div>`;

            container.innerHTML = html;
        }

        // ---------- å®®ä½è©³æƒ… Modal ----------
        function showPalaceDetail(idx) {
            const astro = appState.astrolabe;
            if (!astro) return;
            const palace = astro.palaces[idx];
            if (!palace) return;

            const modal = document.getElementById('palace-modal');
            const body = document.getElementById('palace-modal-body');

            const majorStars = (palace.majorStars || []).filter(s => s.name);
            const minorStars = (palace.minorStars || []).filter(s => s.name);
            const adjStars = (palace.adjectiveStars || []).filter(s => s.name);

            let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <h3 style="font-family:var(--font-serif);font-size:1.2rem;color:var(--gold)">${palace.name}</h3>
        <button onclick="closePalaceModal()" style="background:rgba(255,255,255,0.1);border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.1rem">âœ•</button>
    </div>`;

            html += `<div style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:16px">
        å¤©å¹²åœ°æ”¯ï¼š${palace.heavenlyStemOfPalace || ''}${palace.earthlyBranchOfPalace || ''}
    </div>`;

            if (majorStars.length) {
                html += '<div style="margin-bottom:14px"><div style="font-size:0.8rem;color:var(--purple-light);font-weight:700;margin-bottom:8px">â­ ä¸»æ˜Ÿ</div>';
                majorStars.forEach(s => {
                    html += `<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.06)">
                <span style="color:#ff9f43;font-weight:700">${s.name}</span>
                ${s.brightness ? `<span style="font-size:0.75rem;color:var(--text-secondary)">${s.brightness}</span>` : ''}
                ${s.mutagen ? `<span class="star-hua ${s.mutagen === 'ç¥¿' ? 'hua-lu' : s.mutagen === 'æ¬Š' ? 'hua-quan' : s.mutagen === 'ç§‘' ? 'hua-ke' : 'hua-ji'}" style="font-size:0.8rem">åŒ–${s.mutagen}</span>` : ''}
            </div>`;
                    // åŠ å…¥å£èªè§£èªª
                    if (STAR_PERSONALITY[s.name]) {
                        html += `<div style="font-size:0.78rem;color:var(--text-secondary);padding:6px 0;line-height:1.6">${STAR_PERSONALITY[s.name]}</div>`;
                    }
                });
                html += '</div>';
            }

            if (minorStars.length) {
                html += '<div style="margin-bottom:14px"><div style="font-size:0.8rem;color:#74b9ff;font-weight:700;margin-bottom:8px">âœ¦ å‰¯æ˜Ÿ</div>';
                minorStars.forEach(s => {
                    html += `<div style="display:flex;align-items:center;gap:8px;padding:4px 0">
                <span style="color:#74b9ff">${s.name}</span>
                ${s.mutagen ? `<span class="star-hua ${s.mutagen === 'ç¥¿' ? 'hua-lu' : s.mutagen === 'æ¬Š' ? 'hua-quan' : s.mutagen === 'ç§‘' ? 'hua-ke' : 'hua-ji'}">${s.mutagen}</span>` : ''}
            </div>`;
                });
                html += '</div>';
            }

            if (adjStars.length) {
                html += '<div><div style="font-size:0.8rem;color:var(--text-secondary);font-weight:700;margin-bottom:8px">â—‡ é›œæ›œ</div>';
                html += `<div style="display:flex;flex-wrap:wrap;gap:6px">`;
                adjStars.forEach(s => {
                    html += `<span style="font-size:0.75rem;padding:4px 8px;background:rgba(255,255,255,0.06);border-radius:6px">${s.name}</span>`;
                });
                html += '</div></div>';
            }

            body.innerHTML = html;
            modal.classList.add('show');
        }

        function closePalaceModal() {
            document.getElementById('palace-modal').classList.remove('show');
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰
        document.getElementById('palace-modal').addEventListener('click', function (e) {
            if (e.target === this) closePalaceModal();
        });

        // ============================================================
        // æ­·å²ç´€éŒ„ï¼ˆlocalStorageï¼‰
        // ============================================================
        function loadHistory() {
            try {
                appState.history = JSON.parse(localStorage.getItem('zwds_history') || '[]');
            } catch (e) { appState.history = []; }
            renderHistory();
        }

        function saveChart() {
            if (!appState.birthData) { showToast('æ²’æœ‰å¯å„²å­˜çš„å‘½ç›¤'); return; }
            const record = {
                id: 'c_' + Date.now(),
                birthData: { ...appState.birthData },
                createdAt: new Date().toISOString(),
                label: `${appState.birthData.date} ${HOUR_NAMES[appState.birthData.hour]} ${appState.birthData.gender}å‘½`
            };
            appState.history.unshift(record);
            if (appState.history.length > 50) appState.history = appState.history.slice(0, 50);
            localStorage.setItem('zwds_history', JSON.stringify(appState.history));

            // è‹¥æœ‰å¾Œç«¯å°±ä¹Ÿå„²å­˜ä¸€ä»½
            saveToServer(record);

            showToast('å·²å„²å­˜åˆ°æ­·å²ç´€éŒ„ï¼');
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if (appState.history.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:30px 0">å°šç„¡ç´€éŒ„ï¼Œå¿«å»æ’ç›¤å§ ğŸ”®</p>';
                return;
            }
            list.innerHTML = appState.history.map(h => `
        <div class="glass history-item" onclick="reloadChart('${h.id}')">
            <div class="history-meta">
                <div class="name">${h.label}</div>
                <div class="date">${new Date(h.createdAt).toLocaleDateString('zh-TW')}</div>
            </div>
            <button class="history-delete" onclick="event.stopPropagation();deleteHistory('${h.id}')">
                <i data-lucide="trash-2" style="width:16px;height:16px"></i>
            </button>
        </div>
    `).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function reloadChart(id) {
            const record = appState.history.find(h => h.id === id);
            if (!record) return;
            const bd = record.birthData;
            document.getElementById('birth-date').value = bd.date;
            document.getElementById('birth-hour').value = bd.hour;
            document.getElementById('birth-gender').value = bd.gender;
            if (bd.isLunar !== appState.isLunar) toggleCalendar();
            if (bd.isLeap) document.getElementById('is-leap-month').checked = true;
            generateChart();
        }

        function deleteHistory(id) {
            appState.history = appState.history.filter(h => h.id !== id);
            localStorage.setItem('zwds_history', JSON.stringify(appState.history));
            renderHistory();
            showToast('å·²åˆªé™¤');
        }

        // ============================================================
        // å¾Œç«¯ API é€šè¨Šï¼ˆVercel Serverlessï¼‰
        // ============================================================
        async function saveToServer(record) {
            if (!API_BASE || !appState.user.userId) return;
            try {
                await fetch(`${API_BASE}/api/charts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: appState.user.userId, ...record })
                });
            } catch (e) { console.warn('å„²å­˜åˆ°ä¼ºæœå™¨å¤±æ•—', e); }
        }

        async function loadFromServer() {
            if (!API_BASE || !appState.user.userId) return;
            try {
                const res = await fetch(`${API_BASE}/api/charts?userId=${appState.user.userId}`);
                const data = await res.json();
                if (Array.isArray(data) && data.length) {
                    // åˆä½µä¼ºæœå™¨èˆ‡æœ¬æ©Ÿç´€éŒ„
                    const localIds = new Set(appState.history.map(h => h.id));
                    data.forEach(d => { if (!localIds.has(d.id)) appState.history.push(d); });
                    appState.history.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    localStorage.setItem('zwds_history', JSON.stringify(appState.history));
                    renderHistory();
                }
            } catch (e) { console.warn('å¾ä¼ºæœå™¨è®€å–å¤±æ•—', e); }
        }

        async function saveUserToServer() {
            if (!API_BASE || !appState.user.userId) return;
            try {
                await fetch(`${API_BASE}/api/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appState.user)
                });
            } catch (e) { console.warn('å„²å­˜ä½¿ç”¨è€…è³‡æ–™å¤±æ•—', e); }
        }

        // ============================================================
        // åˆå§‹åŒ–
        // ============================================================
        window.onload = async function () {
            initStarCanvas();
            loadHistory();

            // LIFF åˆå§‹åŒ–
            if (LIFF_ID && LIFF_ID !== 'YOUR_LIFF_ID') {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }
                    const profile = await liff.getProfile();
                    appState.user = {
                        userId: profile.userId,
                        displayName: profile.displayName,
                        pictureUrl: profile.pictureUrl || ''
                    };
                } catch (e) {
                    console.error('LIFF åˆå§‹åŒ–å¤±æ•—', e);
                }
            }

            // æ›´æ–°ä½¿ç”¨è€…ä»‹é¢
            const nameDisp = document.getElementById('user-name-display');
            const avatarEl = document.getElementById('user-avatar');
            if (appState.user.displayName && appState.user.displayName !== 'è¨ªå®¢') {
                nameDisp.textContent = appState.user.displayName;
            }
            if (appState.user.pictureUrl) {
                avatarEl.src = appState.user.pictureUrl;
                avatarEl.classList.remove('hidden');
            }

            // è®€å–ä¼ºæœå™¨è³‡æ–™
            await loadFromServer();
            saveUserToServer();

            // åˆå§‹åŒ–åœ–ç¤º
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // ç§»é™¤ Loading
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 600);
            }
        };
    </script>
</body>

</html>